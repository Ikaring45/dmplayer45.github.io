<!DOCTYPE html>
<html lang="ja">
<head>
  <meta charset="UTF-8">
  <meta name="viewport" content="width=device-width, initial-scale=1.0, user-scalable=no, maximum-scale=1.0, viewport-fit=cover">
  <title>DmPlayer v3.0</title> <meta name="apple-mobile-web-app-capable" content="yes">
  <meta name="apple-mobile-web-app-status-bar-style" content="black-translucent">
  <meta name="apple-mobile-web-app-title" content="DmPlayer">
  
  <link rel="manifest" href="/manifest.json">

  <script src="https://cdn.jsdelivr.net/npm/jsmediatags@3.9.7/dist/jsmediatags.min.js"></script>

  <style>
    /* -------------------- */
    /* ã‚¹ã‚¿ã‚¤ãƒ«ã‚·ãƒ¼ãƒˆ */
    /* -------------------- */
    * { box-sizing: border-box; }
    :root {
      --dark-bg: #121212;
      --medium-bg: #181818;
      --accent-color: #00e6b8;
      --text-color: #ffffff;
      --text-light: #b3b3b3;
      --border-color: #333333;
      --error-color: #e6005c; 
      --debug-color: #00b300; 
      --switch-off: #4a4a4a;
      --switch-on: var(--accent-color);
      --peak-hold-color: #ffcc00;
      /* â­ æ–°è¦è¿½åŠ : iOSã®ã‚»ãƒ¼ãƒ•ã‚¨ãƒªã‚¢ã‚¤ãƒ³ã‚»ãƒƒãƒˆã‚’CSSå¤‰æ•°ã¨ã—ã¦å®šç¾© */
      --safe-area-top: env(safe-area-inset-top, 0px);
      --safe-area-bottom: env(safe-area-inset-bottom, 0px);
      --safe-area-left: env(safe-area-inset-left, 0px);
      --safe-area-right: env(safe-area-inset-right, 0px);
    }

    html, body {
      /* â­ ä¿®æ­£: iOSã§ç”»é¢å¤–ã®é ˜åŸŸãŒé»’ãè¡¨ç¤ºã•ã‚Œã‚‹å•é¡Œã‚’ç·©å’Œã™ã‚‹ãŸã‚ã«æ˜ç¤ºçš„ãªèƒŒæ™¯è‰²ã‚’è¨­å®š */
      background-color: var(--dark-bg);
    }

    body {
      margin: 0;
      font-family: 'Segoe UI', Roboto, Helvetica, Arial, sans-serif;
      color: var(--text-color);
      height: 100vh;
      min-height: -webkit-fill-available;
      overflow: hidden; 
      display: flex; 
    }
    
    .sidebar {
      width: 250px; 
      flex-shrink: 0; 
      background-color: var(--medium-bg);
      border-right: 1px solid var(--border-color);
      overflow: hidden;
      display: flex;
      flex-direction: column;
      padding: 0;
      position: relative; 
      height: 100%; 
      /* â­ ä¿®æ­£: å·¦å´ã®ã‚»ãƒ¼ãƒ•ã‚¨ãƒªã‚¢ã‚¤ãƒ³ã‚»ãƒƒãƒˆã«å¯¾å¿œ (padding-leftã‚’è¿½åŠ ) */
      padding-left: var(--safe-area-left);
    }
    
    .sidebar-content {
        flex-grow: 1;
        overflow-y: auto;
        padding: 15px 15px 5px 15px;
    }

    .sidebar h2 {
      font-size: 1.1em;
      margin-bottom: 10px;
      color: var(--text-light);
    }
    
    .sidebar-footer {
        padding: 10px 15px 15px 15px;
        background-color: #242424; 
        border-top: 1px solid #444444; 
        flex-shrink: 0; 
    }

    .app-info {
        font-size: 0.9em;
        color: var(--text-light);
        margin-bottom: 10px;
        display: flex;
        justify-content: space-between;
    }

    #appName {
        font-weight: bold;
        color: var(--text-color);
    }

    #appVersion {
        font-size: 0.8em;
        color: #999999;
        padding-top: 1px;
    }

    .footer-btn {
        width: 100%;
        padding: 8px;
        margin-top: 5px;
        background-color: #383838;
        color: white;
        border: none;
        border-radius: 4px;
        cursor: pointer;
        transition: background-color 0.2s;
        font-size: 0.9em;
        text-align: center;
        -webkit-tap-highlight-color: transparent;
    }

    .footer-btn:hover {
        background-color: #4a4a4a;
    }
    
    .input-group {
        margin-bottom: 15px;
    }
    .input-group label {
        display: block;
        font-size: 0.9em;
        color: var(--text-light);
        margin-bottom: 5px;
    }
    .input-group input[type="text"] {
        width: 100%;
        padding: 8px;
        background-color: #383838;
        border: 1px solid #555555;
        color: var(--text-color);
        border-radius: 4px;
        font-size: 1em;
    }

    .main {
      flex: 1; 
      display: flex;
      flex-direction: column;
      overflow: hidden;
      position: relative; 
      height: 100%; 
      /* â­ ä¿®æ­£: å³å´ã®ã‚»ãƒ¼ãƒ•ã‚¨ãƒªã‚¢ã‚¤ãƒ³ã‚»ãƒƒãƒˆã«å¯¾å¿œ (padding-rightã‚’è¿½åŠ ) */
      padding-right: var(--safe-area-right);
    }
    
    #fileInput { display: none; }
    
    .file-label {
        display: block;
        width: 100%;
        padding: 10px 15px;
        background-color: var(--accent-color); 
        color: var(--dark-bg);
        border-radius: 6px;
        font-weight: bold;
        text-align: center;
        cursor: pointer;
        transition: background-color 0.2s, box-shadow 0.2s;
        font-size: 1em;
        box-shadow: 0 4px 10px rgba(0, 230, 184, 0.3);
        margin-bottom: 15px; 
        margin-top: 5px; 
    }
    
    .file-label:hover {
        background-color: #00b38c;
        box-shadow: 0 6px 12px rgba(0, 230, 184, 0.4);
    }
    
    .switch-container {
        display: flex;
        align-items: center;
        justify-content: space-between;
        margin-bottom: 15px;
        padding: 5px 0;
        font-size: 0.95em;
    }

    .switch {
        position: relative;
        display: inline-block;
        width: 45px;
        height: 25px;
    }

    .switch input { opacity: 0; width: 0; height: 0; }

    .slider {
        position: absolute; cursor: pointer; top: 0; left: 0; right: 0; bottom: 0;
        background-color: var(--switch-off); transition: .4s; border-radius: 25px;
    }

    .slider:before {
        position: absolute; content: ""; height: 17px; width: 17px; left: 4px; bottom: 4px;
        background-color: white; transition: .4s; border-radius: 50%;
    }

    input:checked + .slider { background-color: var(--switch-on); }
    input:checked + .slider:before { transform: translateX(20px); }

    .audio-list {
        display: flex; flex-direction: column; gap: 5px; padding-top: 5px;
    }

    .queue-item {
        display: flex; align-items: center; width: 100%; padding: 8px 10px;
        background-color: #242424; color: var(--text-color); border: 1px solid #3a3a3a;
        border-radius: 6px; cursor: pointer; transition: background-color 0.2s, border-color 0.2s, box-shadow 0.2s;
        text-align: left; font-size: 0.9em; position: relative; overflow: hidden;
        -webkit-tap-highlight-color: transparent;
    }

    .queue-item:hover { background-color: #303030; }

    .queue-item.active-track {
        border: 1px solid var(--accent-color); border-left: 4px solid var(--accent-color); 
        background-color: #1a1a1a; box-shadow: 0 0 8px rgba(0, 230, 184, 0.3); 
        padding-left: 10px; 
    }
    
    .queue-item.placeholder-track { opacity: 0.6; font-style: italic; }
    
    .queue-index {
        font-size: 1.1em; font-weight: bold; color: var(--text-light);
        width: 25px; flex-shrink: 0; margin-right: 8px; text-align: center;
    }
    
    .track-info-container {
        flex-grow: 1; min-width: 0; display: flex; flex-direction: column;
    }

    .track-title-display {
        font-weight: bold; color: var(--text-color); white-space: nowrap;
        overflow: hidden; text-overflow: ellipsis; 
    }

    .track-artist-display {
        font-size: 0.8em; color: var(--text-light); white-space: nowrap;
        overflow: hidden; text-overflow: ellipsis; 
    }
    
    .queue-controls {
        flex-shrink: 0; margin-left: 8px; display: flex; align-items: center; gap: 3px; 
    }

    .queue-control-btn {
        background: #3a3a3a; color: white; border: none; padding: 4px;
        border-radius: 3px; cursor: pointer; font-size: 0.65em; line-height: 1;
        height: 20px; width: 20px; display: flex; align-items: center;
        justify-content: center; transition: background-color 0.1s, transform 0.1s;
    }
    
    .queue-control-btn:disabled {
        opacity: 0.4;
        cursor: default;
        transform: none;
        background: #3a3a3a;
        color: white;
    }

    .queue-control-btn:hover:not(:disabled) {
        background: var(--accent-color); color: var(--dark-bg); transform: scale(1.1);
    }
    
    .playing-status {
        font-size: 1.2em; color: var(--accent-color); width: 20px; text-align: center; line-height: 1;
    }
    .playing-status.ready-to-play { color: var(--error-color); }
    
    .screen {
      flex: 1; 
      padding: 30px;
      /* â­ ä¿®æ­£: ä¸Šéƒ¨ã®ã‚»ãƒ¼ãƒ•ã‚¨ãƒªã‚¢ã‚¤ãƒ³ã‚»ãƒƒãƒˆã«å¯¾å¿œ */
      padding-top: calc(50px + var(--safe-area-top)); 
      background: linear-gradient(135deg, var(--medium-bg), var(--dark-bg));
      display: flex;
      flex-direction: column;
      justify-content: center;
      align-items: center;
      overflow-y: auto; 
      position: relative; 
      perspective: 1000px; 
      z-index: 1; 
    }

    #visualizerCanvas {
        position: absolute;
        top: 0;
        left: 0;
        width: 100%;
        height: 100%;
        z-index: 0; 
        opacity: 0.6; 
        pointer-events: none; 
    }

    .cover-art-container {
      width: 250px; 
      height: 250px;
      margin-bottom: 25px;
      text-align: center;
      position: relative;
      transform-style: preserve-3d; 
      transition: transform 0.6s; 
      cursor: pointer; 
    }
    
    .cover-art-face {
        position: absolute; width: 100%; height: 100%;
        backface-visibility: hidden; border-radius: 12px;
        box-shadow: 0 15px 30px rgba(0, 0, 0, 0.5), 0 0 0 5px var(--medium-bg);
        overflow: hidden; background-color: var(--medium-bg); padding: 0;
    }

    .cover-art-front { z-index: 2; transform: rotateY(0deg); }

    #coverArt {
      width: 100%; height: 100%; object-fit: cover; border-radius: 12px;
    }
    
    .cover-art-back {
        transform: rotateY(180deg); z-index: 1; display: flex;
        justify-content: center; align-items: flex-start;
        background-color: #1c1c1c; border: 3px solid var(--accent-color); 
    }

    .cover-art-container.flipped { transform: rotateY(180deg); }

    #lyricsDisplay {
        padding: 15px; color: var(--text-light); font-size: 0.85em;
        text-align: center; overflow-y: auto; white-space: pre-wrap;
        max-height: 100%; width: 100%; line-height: 1.4;
    }

    #trackTitle {
      font-size: 2em; font-weight: bold; margin-top: 10px;
    }

    #trackArtist {
        font-size: 1.2em; color: var(--text-light); margin-bottom: 10px; 
    }
    
    .mode-status-display {
        display: flex; gap: 20px; margin-bottom: 30px; font-size: 1.0em; font-weight: 500;
    }

    .mode-item {
        display: flex; align-items: center; gap: 8px; padding: 5px 10px;
        border-radius: 4px; background-color: var(--medium-bg);
        color: var(--text-light); border: 1px solid var(--border-color);
        transition: all 0.2s;
    }

    .mode-item.active {
        background-color: var(--accent-color); color: var(--dark-bg);
        border-color: var(--accent-color); font-weight: bold;
        box-shadow: 0 4px 8px rgba(0, 230, 184, 0.2);
    }

    .mode-icon { font-size: 1.2em; line-height: 1; }

    .seek-container {
      width: 90%; max-width: 600px; margin-top: 30px; display: flex; align-items: center;
    }

    #seekBar {
      flex-grow: 1; margin: 0 15px; -webkit-appearance: none; appearance: none; 
      height: 8px; background: transparent; border-radius: 4px;
      cursor: pointer; transition: background 0.3s;
      --progress: 0%; 
    }

    #seekBar::-webkit-slider-runnable-track {
      width: 100%; height: 8px; cursor: pointer; border-radius: 4px;
      background: linear-gradient(to right, 
        var(--accent-color) 0%, var(--accent-color) var(--progress), 
        var(--border-color) var(--progress), var(--border-color) 100%
      );
    }
    
    #seekBar::-webkit-slider-thumb { -webkit-appearance: none; appearance: none; width: 1px; height: 1px; opacity: 0; border-radius: 50%; background: var(--accent-color); cursor: pointer; margin-top: -4px; }
    #volumeSlider::-webkit-slider-thumb { -webkit-appearance: none; appearance: none; width: 16px; height: 16px; border-radius: 50%; background: var(--accent-color); cursor: pointer; box-shadow: 0 0 5px var(--accent-color); }
    
    .time-display { font-size: 0.9em; width: 45px; text-align: center; color: var(--text-light); }

    .controls-moved {
        display: flex; align-items: center; justify-content: center;
        gap: 15px; margin-top: 20px; 
    }

    .controls-moved button {
        width: 45px; height: 45px; line-height: 45px; padding: 0;
        margin: 5px 0; background-color: var(--accent-color); border: none;
        font-size: 1.2em; color: var(--dark-bg); border-radius: 50%; 
        cursor: pointer; transition: transform 0.1s, background-color 0.2s, box-shadow 0.2s;
        font-weight: bold; -webkit-tap-highlight-color: transparent;
        display: flex; align-items: center; justify-content: center;
    }
    
    .controls-moved button:hover {
        background-color: #00b38c; transform: scale(1.1);
    }
    
    #playPauseBtn { width: 55px; height: 55px; font-size: 1.6em; }
    
    #seekBackwardBtn, #seekForwardBtn {
        background-color: var(--accent-color); color: var(--dark-bg); 
        font-size: 1.4em; width: 45px; height: 45px; border-radius: 50%;
        line-height: 1; font-weight: 900; padding-bottom: 2px; 
    }

    #seekBackwardBtn:hover, #seekForwardBtn:hover {
        background-color: #00b38c; transform: scale(1.1);
    }

    .player-ready #playPauseBtn {
        box-shadow: 0 0 0 4px var(--accent-color), 0 0 20px var(--accent-color);
        background-color: var(--accent-color); color: var(--dark-bg); 
    }

    #optionsBtn {
        position: absolute; top: 15px; left: 15px; background: none; 
        border: none; font-size: 1.8em; color: var(--text-color); 
        cursor: pointer; z-index: 50; padding: 5px 10px; 
        -webkit-tap-highlight-color: transparent; line-height: 1;
        transition: color 0.2s;
    }
    #optionsBtn:hover { color: var(--accent-color); }

    .control-panel {
      flex-shrink: 0; display: flex; background-color: var(--medium-bg);
      padding: 15px; flex-wrap: wrap; border-top: 1px solid var(--border-color);
      height: 180px; gap: 20px; justify-content: space-between;
      /* â­ ä¿®æ­£: ä¸‹éƒ¨ã®ã‚»ãƒ¼ãƒ•ã‚¨ãƒªã‚¢ã‚¤ãƒ³ã‚»ãƒƒãƒˆã«å¯¾å¿œ */
      padding-bottom: calc(15px + var(--safe-area-bottom));
    }
    
    .modes { flex: 1; padding: 0; min-width: 200px; }
    
    .volume-container {
        display: flex; align-items: center; gap: 8px; 
        padding-bottom: 5px; margin-top: 15px;
    }

    #volumeSlider {
        flex-grow: 1; margin: 0; -webkit-appearance: none; appearance: none; 
        height: 8px; background: #555; border-radius: 4px; cursor: pointer;
    }

    .section-title {
      font-size: 0.9em; margin-bottom: 5px; color: var(--text-light);
      border-bottom: 1px solid var(--border-color); padding-bottom: 5px;
    }
    
    .mixer-container {
        display: flex; align-items: center; gap: 10px; padding: 2px 0; 
        position: relative; 
    }

    .channel-label {
        font-size: 0.8em; color: var(--text-light); width: 15px; text-align: center;
    }

    .mixer-bar {
        flex-grow: 1; height: 8px; background-color: #3a3a3a; 
        border-radius: 6px; overflow: hidden; position: relative;
    }

    .mixer-bar-fill {
        height: 100%; width: 0%; transition: width 0.05s linear; 
        background-color: #008000; 
    }
    
    .peak-hold-indicator {
        position: absolute; top: 0; right: 0; width: 4px; height: 100%;
        background-color: var(--peak-hold-color); transition: transform 0.5s ease-out; 
        z-index: 10; border-radius: 2px;
    }
    
    .mode-buttons {
        display: flex; gap: 10px; margin-top: 10px;
    }
    .mode-buttons button {
        flex: 1; padding: 8px; background-color: #383838;
        color: white; border: none; border-radius: 4px;
        cursor: pointer; transition: background-color 0.2s;
        font-size: 0.9em;
    }
    .mode-buttons button:hover { background-color: #4a4a4a; }
    
    #notificationContainer {
        position: absolute; top: 15px; right: 15px; z-index: 1000;
        pointer-events: none; max-width: 300px; overflow: hidden;
    }
    
    .notification-message {
        background-color: #333; color: white; padding: 10px 15px;
        border-radius: 8px; margin-bottom: 10px; box-shadow: 0 4px 12px rgba(0, 0, 0, 0.5);
        opacity: 0; transform: translateX(100%); 
        transition: opacity 0.3s ease-out, transform 0.4s cubic-bezier(0.25, 0.46, 0.45, 0.94);
        pointer-events: all; font-size: 0.9em;
        border-left: 4px solid var(--accent-color); white-space: pre-wrap;
    }

    .notification-message.show { opacity: 1; transform: translateX(0); }
    .notification-message.slide-out { opacity: 0; transform: translateX(100%); }
    .notification-message.error { background-color: #4a1d2e; border-left-color: var(--error-color); }
    .notification-message.debug { background-color: #1b4d24; border-left-color: var(--debug-color); font-size: 0.8em; opacity: 0.7; }

    .settings-overlay {
        position: absolute; top: 0; left: 0; width: 100%; height: 100%;
        background-color: var(--medium-bg); z-index: 10; padding: 15px;
        display: flex; flex-direction: column;
        transform: translateX(-100%); transition: transform 0.3s cubic-bezier(0.4, 0, 0.2, 1);
    }

    .settings-overlay.show { transform: translateX(0); }
    
    .settings-content { flex-grow: 1; overflow-y: auto; }
    
    .settings-footer {
        padding-top: 15px; border-top: 1px solid var(--border-color); margin-top: auto;
    }
    
    .slider-container { margin-bottom: 20px; padding: 5px 0; }
    .slider-container label {
        display: block; font-size: 0.95em; margin-bottom: 5px; color: var(--text-light);
    }
    .slider-container input[type="range"] {
        width: 100%; -webkit-appearance: none; appearance: none; height: 8px;
        background: #555; border-radius: 4px; cursor: pointer;
    }
    .slider-value {
        font-size: 0.85em; color: var(--accent-color); display: block;
        text-align: right; margin-top: 5px;
    }

    .track-details-overlay {
        position: absolute; top: 0; right: 0; width: 300px; height: 100%;
        background-color: #242424; z-index: 200; padding: 20px;
        display: flex; flex-direction: column;
        transform: translateX(100%); transition: transform 0.3s cubic-bezier(0.4, 0, 0.2, 1);
        border-left: 1px solid #444444;
    }
    
    .track-details-overlay.show { transform: translateX(0); }

    .details-content {
        flex-grow: 1; overflow-y: auto; padding-top: 10px;
        font-size: 0.9em; color: var(--text-light);
    }
    
    .details-content strong {
        color: var(--text-color); font-weight: bold; display: block; padding-top: 5px;
    }

    .details-actions { display: flex; gap: 10px; padding: 10px 0; }
    .details-actions button {
        flex: 1; padding: 8px; background-color: #3a3a3a; color: white;
        border: none; border-radius: 4px; cursor: pointer; transition: background-color 0.2s;
    }
    .details-actions button:hover { background-color: #4a4a4a; }

    .close-details-btn {
        margin-top: auto; padding: 10px; background-color: var(--accent-color);
        color: var(--dark-bg); border: none; border-radius: 4px;
        cursor: pointer; font-weight: bold; transition: background-color 0.2s;
    }
    .close-details-btn:hover { background-color: #00b38c; }
    
    #metadataEditForm {
        padding: 10px; border: 1px dashed var(--border-color);
        border-radius: 8px; margin-top: 15px; display: none;
    }
    #metadataEditForm.show { display: block; }

    #player { display: none; }
    
    /* â­ ãƒ“ã‚¸ãƒ¥ã‚¢ãƒ©ã‚¤ã‚¶ãƒ¼ãƒ¢ãƒ¼ãƒ‰ (v3.0) â­ */
    body.visualizer-mode {
        display: block; 
    }
    
    /* ã‚µã‚¤ãƒ‰ãƒãƒ¼ï¼ˆã‚­ãƒ¥ãƒ¼ï¼‰ã¯è¡¨ç¤ºã™ã‚‹ã€‚ãƒ¦ãƒ¼ã‚¶ãƒ¼ã¯ã‚­ãƒ¥ãƒ¼ã‚’è¦‹ãŸã„ã¨ã®è¦æœ›ãŒã‚ã‚‹ãŸã‚å¸¸ã«è¡¨ç¤º */
    body.visualizer-mode .sidebar {
        display: block !important;
        z-index: 3;
    }

    /* ãƒ¡ã‚¤ãƒ³é ˜åŸŸã¯ã‚µã‚¤ãƒ‰ãƒãƒ¼åˆ†ã‚’æ®‹ã—ã¦è¡¨ç¤º */
    body.visualizer-mode .main {
        width: calc(100% - 250px);
        height: 100vh;
        flex: 1;
    }
    
    /* control-panel ã¯è¡¨ç¤ºã—ã¦ãŠãï¼ˆãƒœãƒªãƒ¥ãƒ¼ãƒ /ã‚·ãƒ£ãƒƒãƒ•ãƒ«ç­‰ã‚’æ®‹ã™ï¼‰ */
    body.visualizer-mode .control-panel {
        display: flex !important;
        z-index: 2;
    }
    
    body.visualizer-mode .screen {
        padding: 0; 
    }
    
    /* ãƒ“ã‚¸ãƒ¥ã‚¢ãƒ©ã‚¤ã‚¶ãƒ¼ãƒ¢ãƒ¼ãƒ‰ã§ã¯ã€Œãƒœã‚¿ãƒ³é¡ã®ã¿ã€ã‚’éè¡¨ç¤ºã«ã—ã¦
       ã‚¢ãƒ«ãƒãƒ ã‚«ãƒãƒ¼ã‚„ã‚·ãƒ¼ã‚¯ãƒãƒ¼ã€ã‚¿ã‚¤ãƒˆãƒ«é¡ã¯è¡¨ç¤ºã—ãŸã¾ã¾ã«ã™ã‚‹ã€‚
       canvas ã¯èƒŒæ™¯ã¨ã—ã¦è¡¨ç¤ºã•ã‚Œã€UI ã¯ãã®ä¸Šã«é‡ãªã‚‹ã€‚ */
    /* éè¡¨ç¤º: ãƒ“ã‚¸ãƒ¥ã‚¢ãƒ©ã‚¤ã‚¶ãƒ¼è¡¨ç¤ºæ™‚ã¯ã‚¢ãƒ«ãƒãƒ ã‚«ãƒãƒ¼ï¼ã‚¿ã‚¤ãƒˆãƒ«ï¼ã‚·ãƒ¼ã‚¯ãƒãƒ¼ã‚’éš ã™ */
    body.visualizer-mode .cover-art-container,
    body.visualizer-mode #trackTitle,
    body.visualizer-mode #trackArtist,
    body.visualizer-mode .seek-container,
    body.visualizer-mode .cover-art-face {
        display: none !important;
    }

    /* éè¡¨ç¤º: ç”»é¢ä¸Šã®å†ç”Ÿ/å‰å¾Œãªã©ã®å¤§ããªã‚³ãƒ³ãƒˆãƒ­ãƒ¼ãƒ«ã¯éš ã™ï¼ˆæ“ä½œã¯ control-panel ã§å¯èƒ½ï¼‰ */
    body.visualizer-mode .controls-moved,
    body.visualizer-mode #optionsBtn {
        display: none !important;
    }
    
    /* éšœå®³ã«ãªã‚‹æµ®éŠè¡¨ç¤ºï¼ˆãƒ«ãƒ¼ãƒ—/ã‚·ãƒ£ãƒƒãƒ•ãƒ«ã®ã‚¹ãƒ†ãƒ¼ã‚¿ã‚¹ï¼‰ã‚’éè¡¨ç¤ºã«ã™ã‚‹ */
    body.visualizer-mode #loopStatus,
    body.visualizer-mode #shuffleStatus {
        display: none !important;
    }
    
    /* ã‚­ãƒ£ãƒ³ãƒã‚¹ã¨é€šçŸ¥ã€ã‚ªãƒ¼ãƒãƒ¼ãƒ¬ã‚¤ã¯è¡¨ç¤ºã‚’ç¶­æŒ */
    body.visualizer-mode #visualizerCanvas {
        display: block !important; 
        opacity: 1.0; 
        z-index: 0 !important;
        pointer-events: none !important;
    }

    body.visualizer-mode #notificationContainer {
        display: block !important;
        pointer-events: none;
    }

    /* è¨­å®šã‚„è©³ç´°ã‚ªãƒ¼ãƒãƒ¼ãƒ¬ã‚¤ã¯è¡¨ç¤ºã‚’ç¶­æŒ */
    body.visualizer-mode .settings-overlay.show,
    body.visualizer-mode .track-details-overlay.show {
        display: flex !important; 
        z-index: 100;
    }

  </style>
</head>
<body>

  <div class="sidebar">
    
    <div id="settingsOverlay" class="settings-overlay">
        <h2>âš™ï¸ è¨­å®šãƒ¡ãƒ‹ãƒ¥ãƒ¼</h2>
        <div class="settings-content">
            
            <div class="switch-container">
                <label for="visualizerToggle">ã‚ªãƒ¼ãƒ‡ã‚£ã‚ªãƒ“ã‚¸ãƒ¥ã‚¢ãƒ©ã‚¤ã‚¶ãƒ¼</label>
                <label class="switch">
                    <input type="checkbox" id="visualizerToggle">
                    <span class="slider"></span>
                </label>
            </div>
            
            <div class="switch-container">
                <label for="nextTrackNotificationToggle">æ¬¡ã®æ›²ã‚’é€šçŸ¥</label>
                <label class="switch">
                    <input type="checkbox" id="nextTrackNotificationToggle" checked>
                    <span class="slider"></span>
                </label>
            </div>
            <div class="switch-container">
                <label for="debugToggle">ãƒ‡ãƒãƒƒã‚°è¡¨ç¤º</label>
                <label class="switch">
                    <input type="checkbox" id="debugToggle">
                    <span class="slider"></span>
                </label>
            </div>
            
            <div class="slider-container">
                <label for="crossfadeDurationSlider">ã‚¯ãƒ­ã‚¹ãƒ•ã‚§ãƒ¼ãƒ‰æ™‚é–“ (<span id="crossfadeValue">1.5</span>ç§’)</label>
                <input type="range" id="crossfadeDurationSlider" min="0.0" max="5.0" step="0.1" value="1.5">
                <span class="slider-value">æ›²ã®åˆ‡ã‚Šæ›¿ãˆã‚’æ»‘ã‚‰ã‹ã«ã—ã¾ã™ã€‚</span>
            </div>
            
        </div>
        <div class="settings-footer">
            <button id="closeSettingsBtn" class="footer-btn">é–‰ã˜ã‚‹</button>
        </div>
    </div>
    
    <div class="sidebar-content">
      <h2>ã‚­ãƒ¥ãƒ¼ã«è¿½åŠ </h2>
      <input type="file" id="fileInput" accept="audio/mp3, audio/m4a, audio/flac, audio/ogg, audio/wav, audio/mp4" multiple />
      <label for="fileInput" class="file-label">ğŸ“‚ ãƒ•ã‚¡ã‚¤ãƒ«ã‚’é¸æŠ</label>
      
      <h2>ã‚­ãƒ¥ãƒ¼</h2>
      <div class="audio-list" id="audioList"></div>
    </div>

    <div class="sidebar-footer">
        <div class="app-info">
          <div id="appName">DmPlayer</div>
          <div id="appVersion">v3.0</div> </div>
        <button id="settingsBtn" class="footer-btn">âš™ï¸ è¨­å®š</button>
        <button id="helpBtn" class="footer-btn">ğŸ’¡ ãƒ˜ãƒ«ãƒ—</button>
    </div>
  </div>

  <div class="main">
    
    <div id="notificationContainer"></div>
    <div id="trackDetailsOverlay" class="track-details-overlay">
        <h2>â„¹ï¸ ãƒˆãƒ©ãƒƒã‚¯è©³ç´°</h2>
        <div id="currentTrackInfoDetails" class="details-content">
            è©³ç´°ã‚’èª­ã¿è¾¼ã¿ä¸­...
            <div id="metadataEditForm">
                <div class="input-group">
                    <label for="editTitle">ã‚¿ã‚¤ãƒˆãƒ«</label>
                    <input type="text" id="editTitle">
                </div>
                <div class="input-group">
                    <label for="editArtist">ã‚¢ãƒ¼ãƒ†ã‚£ã‚¹ãƒˆ</label>
                    <input type="text" id="editArtist">
                </div>
                <button class="footer-btn" id="saveMetadataBtn">ã‚¿ã‚°ã‚’ä¿å­˜ã—ã¦é©ç”¨</button>
            </div>
        </div>
        
        <div class="details-actions">
            <button id="toggleEditBtn">ã‚¿ã‚°ã‚’ç·¨é›†</button>
        </div>
        <button id="closeDetailsBtn" class="close-details-btn">é–‰ã˜ã‚‹</button>
    </div>

    <div id="playerScreen" class="screen">
      <canvas id="visualizerCanvas"></canvas>
      
      <div class="mode-status-display">
          <div id="loopStatus" class="mode-item">â†³ OFF</div>
          <div id="shuffleStatus" class="mode-item">ğŸ”€ OFF</div>
      </div>
      
      <div class="cover-art-container" onclick="toggleFlip()">
          <div class="cover-art-face cover-art-front">
              <img id="coverArt" alt="Cover Art" src="">
          </div>
          <div class="cover-art-face cover-art-back">
              <pre id="lyricsDisplay">æ­Œè©æƒ…å ±ãªã—</pre>
          </div>
      </div>

      <h1 id="trackTitle">-- DmPlayer --</h1>
      <p id="trackArtist">ã‚ªãƒ•ãƒ©ã‚¤ãƒ³å†ç”Ÿã«å¯¾å¿œã—ãŸã‚¦ã‚§ãƒ–ã‚ªãƒ¼ãƒ‡ã‚£ã‚ªãƒ—ãƒ¬ã‚¤ãƒ¤ãƒ¼</p>

      <div class="seek-container">
          <div id="currentTime" class="time-display">0:00</div>
          <input type="range" id="seekBar" min="0" max="100" value="0">
          <div id="duration" class="time-display">0:00</div>
      </div>

      <div class="controls-moved">
          <button id="seekPrevBtn" title="å‰ã®æ›²" disabled>â®</button>
          <button id="seekBackwardBtn" title="10ç§’æˆ»ã‚‹" disabled>âª</button>
          <button id="playPauseBtn" title="å†ç”Ÿ / ä¸€æ™‚åœæ­¢" disabled>â–¶</button>
          <button id="seekForwardBtn" title="10ç§’é€²ã‚€" disabled>â©</button>
          <button id="seekNextBtn" title="æ¬¡ã®æ›²" disabled>â­</button>
      </div>

      <button id="optionsBtn">â˜°</button>
    </div>

    <div class="control-panel">
        
        <div class="mixer-section">
            <div class="section-title">ğŸ”Š ã‚ªãƒ¼ãƒ‡ã‚£ã‚ªãƒ¬ãƒ™ãƒ«</div>
            <div class="mixer-container">
                <div class="channel-label">L</div>
                <div class="mixer-bar">
                    <div class="mixer-bar-fill" id="mixerBarL"></div>
                    <div class="peak-hold-indicator" id="peakHoldL"></div>
                </div>
            </div>
            <div class="mixer-container">
                <div class="channel-label">R</div>
                <div class="mixer-bar">
                    <div class="mixer-bar-fill" id="mixerBarR"></div>
                    <div class="peak-hold-indicator" id="peakHoldR"></div>
                </div>
            </div>
        </div>
        
        <div class="modes">
            <div class="section-title">âš™ï¸ ãƒœãƒªãƒ¥ãƒ¼ãƒ  & ãƒ¢ãƒ¼ãƒ‰</div>
            <div class="volume-container">
                <span style="font-size:0.9em; color: var(--text-light); white-space: nowrap;">éŸ³é‡: </span>
                <input type="range" id="volumeSlider" min="0" max="200" value="100">
                <span id="volumePercentage" style="font-size:0.9em; width: 35px; text-align: right; color: var(--accent-color); cursor: pointer; user-select: none;">100%</span>
            </div>
            <div class="mode-buttons">
                <button id="loopBtn">ãƒªãƒ”ãƒ¼ãƒˆ</button>
                <button id="shuffleBtn">ã‚·ãƒ£ãƒƒãƒ•ãƒ«</button>
            </div>
        </div>
    </div>
    
    <audio id="player" preload="auto"></audio>
  </div>

  <script>
    
    // ** PWA Service Worker Registration **
    if ('serviceWorker' in navigator) {
        // â­ ä¿®æ­£: scope ã‚’ root (/) ã«å¤‰æ›´
        navigator.serviceWorker.register('/sw.js', { scope: '/' })
        .then(reg => {
            console.log('ServiceWorker registered:', reg);
            showNotification('Service Worker ç™»éŒ²æ¸ˆã¿', false, 2000); 

            // æ–°ã—ã„ SW ãŒã‚¤ãƒ³ã‚¹ãƒˆãƒ¼ãƒ«ã•ã‚ŒãŸã‚‰ã‚¯ãƒ©ã‚¤ã‚¢ãƒ³ãƒˆã«é€šçŸ¥
            reg.addEventListener('updatefound', () => {
                const newWorker = reg.installing;
                newWorker.addEventListener('statechange', () => {
                    if (newWorker.state === 'installed') {
                        if (navigator.serviceWorker.controller) {
                            // æ›´æ–°é©ç”¨å¯èƒ½
                            showNotification('æ–°ã—ã„ãƒãƒ¼ã‚¸ãƒ§ãƒ³ã‚’æ¤œå‡ºã—ã¾ã—ãŸã€‚ãƒšãƒ¼ã‚¸ã‚’ãƒªãƒ­ãƒ¼ãƒ‰ã™ã‚‹ã¨æ›´æ–°ã•ã‚Œã¾ã™ã€‚', false, 4000);
                        } else {
                            // åˆå›ã‚¤ãƒ³ã‚¹ãƒˆãƒ¼ãƒ«
                            showNotification('ã‚¢ãƒ—ãƒªãŒã‚ªãƒ•ãƒ©ã‚¤ãƒ³ã§ä½¿ç”¨ã§ãã‚‹ã‚ˆã†ã«ãªã‚Šã¾ã—ãŸã€‚', false, 3000);
                        }
                    }
                });
            });
        }).catch(err => {
            console.warn('ServiceWorker registration failed:', err);
            showNotification('Service Worker ã®ç™»éŒ²ã«å¤±æ•—ã—ã¾ã—ãŸã€‚', true, 3000);
        });

        // æ—©æœŸã«æ–°ã—ã„SWã‚’æœ‰åŠ¹åŒ–ã—ãŸã„å ´åˆï¼ˆé–‹ç™ºæ™‚å‘ã‘ï¼‰
        navigator.serviceWorker.addEventListener('message', (ev) => {
            if (ev.data && ev.data.type === 'SKIP_WAITING') {
                navigator.serviceWorker.getRegistration().then(reg => {
                    if (reg && reg.waiting) reg.waiting.postMessage({ type: 'SKIP_WAITING' });
                });
            }
        });
    }

    // --- ã‚°ãƒ­ãƒ¼ãƒãƒ«å¤‰æ•° ---
    const playlists = [];
    const PLAYER_STATE_KEY = 'dmplayer_state_v3'; 
    let currentIndex = 0;
    let isLoop = 'off'; // 'off', 'all', 'one'
    let isShuffle = false;
    let isSeeking = false;
    let isSwitchingTrack = false;
    let isVisualizerEnabled = false; 
    let isDebugging = false;
    let nextTrackNotificationEnabled = true;
    let nextTrackNotificationSent = false;
    let CROSSFADE_DURATION = 1.5; // åˆæœŸå€¤
    const DEFAULT_COVER_SRC = 'data:image/svg+xml;base64,PHN2ZyB4bWxucz0iaHR0cDovL3d3dy53My5vcmcvMjAwb09SV1h3d3cucwzVlJhc3QiIHdpZHRoPSIyNTAiIGhlaWdodD0iMjUwIiB2aWV3Qm94PSIwIDAgNTAgNTAiIGZpbGw9IiMwMGU2YjgiPjxwYXRoIGQ9Ik00MCAxMEgxMFY0MEg0MFpNNjAzNjYyIDMyVjE3SDQ2di01aDYuMTVsMi4wNi0yLjA3QzQwLjI3NjYgMzQuNjIgNDAuMTg0IDM0LjM3MiA0MC4xNDggMzQuMTAyTDQ1IDM5di01eiIgdHJhbnNmb3JtPSJtYXRyaXgoLjU5Mjg1NyAwIDAgLjU5Mjg1NyAxMS44NTcgMTEuODU3KSIvPjwvc3ZnPg=='; 
    let rafId = null;

    // â­ æ–°è¦è¿½åŠ : ãƒ¦ãƒ¼ã‚¶ãƒ¼æ“ä½œãƒ•ãƒ©ã‚°
    let hasUserGesture = false;

    // DOMè¦ç´ 
    let audioList, player, notificationContainer, settingsOverlay, debugToggle, nextTrackNotificationToggle;
    let trackDetailsOverlay, currentTrackInfoDetails, volumeSlider, volumePercentage;
    let shuffleStatus, loopStatus, playPauseBtn, seekBackwardBtn, seekForwardBtn, playNextBtn, playPrevBtn;
    let coverArtContainer, lyricsDisplay, crossfadeDurationSlider, crossfadeValueDisplay;
    let metadataEditForm, editTitleInput, editArtistInput, saveMetadataBtn, toggleEditBtn;
    let peakHoldL, peakHoldR, mixerBarL, mixerBarR, seekBar, currentTimeDisplay, durationDisplay;
    let fileInput, trackTitle, trackArtist, coverArt, optionsBtn, settingsBtn, closeSettingsBtn, helpBtn, closeDetailsBtn;
    const loopBtnElement = document.getElementById("loopBtn");
    const shuffleBtnElement = document.getElementById("shuffleBtn");
    
    // â­ ãƒ“ã‚¸ãƒ¥ã‚¢ãƒ©ã‚¤ã‚¶ãƒ¼é–¢é€£ã®DOMè¦ç´ ã‚’å–å¾—
    let visualizerCanvas, visualizerCtx, visualizerToggle; 

    // AudioContextã®ã‚»ãƒƒãƒˆã‚¢ãƒƒãƒ—
    const AudioContext = window.AudioContext || window.webkitAudioContext;
    let audioContext = null;
    let sourceNode = null;
    let gainNode = null;
    let analyserMain = null; 
    let analyserL = null;
    let analyserR = null; 
    let mediaElementSource = null;
    let isConnected = false;
    let peakLevelL = 0;
    let peakLevelR = 0;
    const peakDecayRate = 0.95; 
    const fftSize = 2048;
    const frequencyData = new Uint8Array(fftSize / 2);
    
    // --- åˆæœŸåŒ–å‡¦ç† ---
    document.addEventListener('DOMContentLoaded', () => {
        // DOMè¦ç´ ã®å–å¾—ï¼ˆæ—¢å­˜ï¼‰
        audioList = document.getElementById("audioList");
        player = document.getElementById("player");
        notificationContainer = document.getElementById("notificationContainer");
        settingsOverlay = document.getElementById("settingsOverlay");
        debugToggle = document.getElementById("debugToggle");
        nextTrackNotificationToggle = document.getElementById("nextTrackNotificationToggle");
        trackDetailsOverlay = document.getElementById("trackDetailsOverlay");
        currentTrackInfoDetails = document.getElementById("currentTrackInfoDetails");
        volumeSlider = document.getElementById("volumeSlider");
        volumePercentage = document.getElementById("volumePercentage");
        shuffleStatus = document.getElementById("shuffleStatus");
        loopStatus = document.getElementById("loopStatus");
        playPauseBtn = document.getElementById("playPauseBtn");
        seekBackwardBtn = document.getElementById("seekBackwardBtn");
        seekForwardBtn = document.getElementById("seekForwardBtn");
        playPrevBtn = document.getElementById("seekPrevBtn");
        playNextBtn = document.getElementById("seekNextBtn");
        coverArtContainer = document.querySelector(".cover-art-container");
        lyricsDisplay = document.getElementById("lyricsDisplay");
        crossfadeDurationSlider = document.getElementById("crossfadeDurationSlider");
        crossfadeValueDisplay = document.getElementById("crossfadeValue");
        metadataEditForm = document.getElementById("metadataEditForm");
        editTitleInput = document.getElementById("editTitle");
        editArtistInput = document.getElementById("editArtist");
        saveMetadataBtn = document.getElementById("saveMetadataBtn");
        toggleEditBtn = document.getElementById("toggleEditBtn");
        peakHoldL = document.getElementById("peakHoldL");
        peakHoldR = document.getElementById("peakHoldR");
        mixerBarL = document.getElementById("mixerBarL");
        mixerBarR = document.getElementById("mixerBarR");
        seekBar = document.getElementById("seekBar");
        currentTimeDisplay = document.getElementById("currentTime");
        durationDisplay = document.getElementById("duration");
        fileInput = document.getElementById("fileInput");
        trackTitle = document.getElementById("trackTitle");
        trackArtist = document.getElementById("trackArtist");
        coverArt = document.getElementById("coverArt");
        optionsBtn = document.getElementById("optionsBtn");
        settingsBtn = document.getElementById("settingsBtn");
        closeSettingsBtn = document.getElementById("closeSettingsBtn");
        helpBtn = document.getElementById("helpBtn");
        closeDetailsBtn = document.getElementById("closeDetailsBtn");
        
        // â­ ãƒ“ã‚¸ãƒ¥ã‚¢ãƒ©ã‚¤ã‚¶ãƒ¼é–¢é€£ã®DOMè¦ç´ ã‚’å–å¾—
        visualizerCanvas = document.getElementById("visualizerCanvas");
        visualizerToggle = document.getElementById("visualizerToggle");
        visualizerCtx = visualizerCanvas.getContext("2d"); 

        // AudioContextã®ã‚»ãƒƒãƒˆã‚¢ãƒƒãƒ—ï¼ˆæ—¢å­˜ï¼‰
        try {
            audioContext = new AudioContext();
        } catch (e) {
            showNotification('AudioContextã®åˆæœŸåŒ–ã«å¤±æ•—ã—ã¾ã—ãŸã€‚', true, 5000);
            return;
        }

        gainNode = audioContext.createGain();
        gainNode.gain.value = 1.0;
        
        analyserL = audioContext.createAnalyser();
        analyserR = audioContext.createAnalyser();
        analyserMain = audioContext.createAnalyser();
        
        // åˆ†å‰²ç‚¹ã‚’ç”¨æ„
        const splitter = audioContext.createChannelSplitter(2);

        // æ¥ç¶š
        // mediaElementSource ã¯ loadTrack ã§æ¥ç¶šã•ã‚Œã¾ã™ã€‚
        gainNode.connect(analyserMain);
        gainNode.connect(splitter);
        splitter.connect(analyserL, 0); // Left Channel
        splitter.connect(analyserR, 1); // Right Channel
        analyserMain.connect(audioContext.destination); // Main output
        
        analyserMain.fftSize = fftSize;
        analyserL.fftSize = fftSize;
        analyserR.fftSize = fftSize;
        
        // ã‚¤ãƒ™ãƒ³ãƒˆãƒªã‚¹ãƒŠãƒ¼ã®ã‚»ãƒƒãƒˆã‚¢ãƒƒãƒ—ï¼ˆæ—¢å­˜ï¼‰
        fileInput.addEventListener('change', handleFileSelection);
        playPauseBtn.addEventListener('click', () => handleUserAction(togglePlayPause));
        playNextBtn.addEventListener('click', () => handleUserAction(playNext));
        playPrevBtn.addEventListener('click', () => handleUserAction(playPrev));
        seekBackwardBtn.addEventListener('click', () => handleUserAction(() => seek(player.currentTime - 10)));
        seekForwardBtn.addEventListener('click', () => handleUserAction(() => seek(player.currentTime + 10)));
        volumeSlider.addEventListener('input', (e) => updateVolume(e.target.value));
        volumePercentage.addEventListener('click', resetVolumeToDefault);
        loopBtnElement.addEventListener('click', toggleLoop);
        shuffleBtnElement.addEventListener('click', toggleShuffle);
        optionsBtn.addEventListener('click', () => toggleOverlay('settingsOverlay', true));
        settingsBtn.addEventListener('click', () => toggleOverlay('settingsOverlay', true));
        closeSettingsBtn.addEventListener('click', () => toggleOverlay('settingsOverlay', false));
        helpBtn.addEventListener('click', () => showNotification("ãƒ˜ãƒ«ãƒ—æ©Ÿèƒ½ã¯é–‹ç™ºä¸­ã§ã™ã€‚", false, 2000));
        closeDetailsBtn.addEventListener('click', () => toggleOverlay('trackDetailsOverlay', false));
        toggleEditBtn.addEventListener('click', toggleMetadataEdit);
        saveMetadataBtn.addEventListener('click', saveEditedMetadata);
        
        // ã‚¯ãƒ­ã‚¹ãƒ•ã‚§ãƒ¼ãƒ‰ã‚¹ãƒ©ã‚¤ãƒ€ãƒ¼
        crossfadeDurationSlider.addEventListener('input', (e) => {
            CROSSFADE_DURATION = parseFloat(e.target.value);
            crossfadeValueDisplay.textContent = CROSSFADE_DURATION.toFixed(1);
            saveState();
        });
        
        // ãƒ“ã‚¸ãƒ¥ã‚¢ãƒ©ã‚¤ã‚¶ãƒ¼åˆ‡ã‚Šæ›¿ãˆ
        visualizerToggle.addEventListener('change', (e) => {
            isVisualizerEnabled = e.target.checked;
            updateVisualizerState();
            saveState();
        });
        
        // ãƒ‡ãƒãƒƒã‚°è¡¨ç¤ºåˆ‡ã‚Šæ›¿ãˆ
        debugToggle.addEventListener('change', (e) => {
            isDebugging = e.target.checked;
            saveState();
        });
        
        // æ¬¡ã®æ›²ã‚’é€šçŸ¥åˆ‡ã‚Šæ›¿ãˆ
        nextTrackNotificationToggle.addEventListener('change', (e) => {
            nextTrackNotificationEnabled = e.target.checked;
            saveState();
        });
        
        // ã‚·ãƒ¼ã‚¯ãƒãƒ¼é–¢é€£
        seekBar.addEventListener('mousedown', () => { isSeeking = true; });
        seekBar.addEventListener('touchstart', () => { isSeeking = true; });
        const seekEndHandler = () => {
            isSeeking = false;
            const duration = player.duration;
            if (!isNaN(duration) && isFinite(duration) && duration > 0) {
                player.currentTime = (seekBar.value / 100) * duration;
            }
            updateSeekBar(player.currentTime);
            saveState();
        };
        seekBar.addEventListener('mouseup', seekEndHandler);
        seekBar.addEventListener('touchend', seekEndHandler);
        seekBar.addEventListener('input', () => {
            const duration = player.duration;
            if (!isNaN(duration) && isFinite(duration) && duration > 0) {
                const tempTime = (seekBar.value / 100) * duration;
                currentTimeDisplay.textContent = formatTime(tempTime);
                seekBar.style.setProperty('--progress', `${seekBar.value}%`);
            }
        });

        // ãƒ—ãƒ¬ã‚¤ãƒ¤ãƒ¼ã‚¤ãƒ™ãƒ³ãƒˆ
        player.addEventListener('loadedmetadata', onLoadedMetadata);
        player.addEventListener('timeupdate', onTimeUpdate);
        player.addEventListener('ended', onTrackEnded);
        player.addEventListener('error', onPlayerError);
        player.addEventListener('play', onPlay);
        player.addEventListener('pause', onPause);

        // åˆæœŸåŒ–å‡¦ç†
        initDB().finally(() => {
            updateVolume(volumeSlider.value);
            loadState(); // çŠ¶æ…‹ã‚’ãƒ­ãƒ¼ãƒ‰
            // â­ ãƒ“ã‚¸ãƒ¥ã‚¢ãƒ©ã‚¤ã‚¶ãƒ¼ã®åˆæœŸçŠ¶æ…‹ã‚’åæ˜ 
            updateVisualizerState();
            updateAudioList();
            updateModeStatusDisplay();
            updateLoopButton();
            if (playlists.length === 0) {
                resetDisplayedTrackInfo();
            } else {
                loadTrack(currentIndex);
            }
            updatePlayerStatusDisplay(true);
            showNotification("DmPlayer v3.0 èµ·å‹•å®Œäº† (iOS PWAå¯¾å¿œ)ã€‚", false, 1500, true); // ãƒãƒ¼ã‚¸ãƒ§ãƒ³ã‚’æ›´æ–°
        });

        // ãƒªã‚µã‚¤ã‚ºæ™‚ã®ã‚­ãƒ£ãƒ³ãƒã‚¹ã‚µã‚¤ã‚ºèª¿æ•´
        window.addEventListener('resize', updateVisualizerCanvasSize);
        // åˆæœŸã‚­ãƒ£ãƒ³ãƒã‚¹ã‚µã‚¤ã‚ºèª¿æ•´
        updateVisualizerCanvasSize();
        
        // â­ æ–°è¦è¿½åŠ : ãƒ¦ãƒ¼ã‚¶ãƒ¼æ“ä½œãƒªã‚¹ãƒŠãƒ¼
        document.addEventListener('click', handleFirstUserGesture, { once: true });
        document.addEventListener('touchend', handleFirstUserGesture, { once: true });
        document.addEventListener('keydown', handleFirstUserGesture, { once: true });
    });

    // --- DBé–¢æ•° (å¤‰æ›´ãªã—) ---
    function initDB() { 
        return new Promise((resolve, reject) => {
            if (!window.indexedDB) return resolve();
            const request = indexedDB.open('DmPlayerDB', 1);
            request.onerror = (e) => { console.error('DB error', e); reject(e); };
            request.onupgradeneeded = (e) => {
                e.target.result.createObjectStore('tracks', { keyPath: 'name' });
            };
            request.onsuccess = (e) => { 
                db = e.target.result; 
                // DBã‹ã‚‰ãƒ—ãƒ¬ã‚¤ãƒªã‚¹ãƒˆã‚’ãƒ­ãƒ¼ãƒ‰ã™ã‚‹ãƒ­ã‚¸ãƒƒã‚¯ã‚’ã“ã“ã«å®Ÿè£…ã™ã‚‹
                // ç¾çŠ¶ã¯ loadState ã§ playlist.json ã®ã¿ãƒ­ãƒ¼ãƒ‰ã•ã‚Œã¦ã„ã‚‹å‰æãªã®ã§ã€IndexedDBã®å…¨ãƒ­ãƒ¼ãƒ‰ã¯çœç•¥
                resolve(); 
            };
        });
    }

    function loadMetadataFromDB(fileName) {
        return new Promise((resolve) => {
            if (!window.indexedDB || !db) return resolve(null);
            const transaction = db.transaction(['tracks'], 'readonly');
            transaction.objectStore('tracks').get(fileName).onsuccess = (e) => resolve(e.target.result);
            transaction.onerror = (e) => { console.error('DB load error', e); resolve(null); };
        });
    }

    function saveMetadataToDB(fileName, metadata) {
        return new Promise((resolve, reject) => {
            if (!window.indexedDB || !db) return resolve();
            const transaction = db.transaction(['tracks'], 'readwrite');
            const store = transaction.objectStore('tracks');
            const data = { name: fileName, ...metadata };
            const request = store.put(data);
            request.onsuccess = resolve;
            request.onerror = (e) => { console.error('DB save error', e); reject(e); };
        });
    }
    
    // --- ãƒ¦ãƒ¼ãƒ†ã‚£ãƒªãƒ†ã‚£é–¢æ•° (å¤‰æ›´ãªã—) ---
    function formatTime(seconds) {
        if (isNaN(seconds) || seconds < 0) return "0:00";
        const minutes = Math.floor(seconds / 60);
        const remainingSeconds = Math.floor(seconds % 60);
        return `${minutes}:${remainingSeconds.toString().padStart(2, '0')}`;
    }

    function removeExtension(filename) {
        return filename.split('.').slice(0, -1).join('.') || filename;
    }

    function showNotification(msg, isErr = false, dur = 3000, isDebug = false) {
        if (isDebug && !isDebugging) return;
        const div = document.createElement('div');
        div.className = `notification-message ${isErr ? 'error' : ''} ${isDebug ? 'debug' : ''}`;
        div.textContent = msg;
        notificationContainer.appendChild(div);
        setTimeout(() => div.classList.add('show'), 10);
        setTimeout(() => {
            div.classList.remove('show');
            setTimeout(() => div.remove(), 500);
        }, dur);
    }

    function calculateRMS(analyser) {
        const buffer = new Float32Array(analyser.fftSize);
        analyser.getFloatTimeDomainData(buffer);
        let sumOfSquares = 0;
        for (let i = 0; i < buffer.length; i++) {
            sumOfSquares += buffer[i] * buffer[i];
        }
        return Math.min(100, Math.sqrt(sumOfSquares / buffer.length) * 100 * 3); // 3å€ã¯è¦–è¦šåŒ–ã®ãŸã‚ã®å¢—å¹…
    }

    function updateVisualizerCanvasSize() {
        const screen = document.getElementById("playerScreen");
        if (screen) {
            const dpr = window.devicePixelRatio || 1;
            const w = Math.max(1, Math.floor(screen.clientWidth));
            const h = Math.max(1, Math.floor(screen.clientHeight));
            visualizerCanvas.style.width = w + 'px';
            visualizerCanvas.style.height = h + 'px';
            visualizerCanvas.width = Math.max(1, Math.floor(w * dpr));
            visualizerCanvas.height = Math.max(1, Math.floor(h * dpr));
            visualizerCtx.scale(dpr, dpr);
        }
    }
    
    // â­ æ–°è¦è¿½åŠ : æœ€åˆã®ãƒ¦ãƒ¼ã‚¶ãƒ¼æ“ä½œã‚’å‡¦ç†ã™ã‚‹é–¢æ•°
    function handleFirstUserGesture(event) {
        if (hasUserGesture) return;
        
        hasUserGesture = true;
        
        // AudioContextã‚’resumeã™ã‚‹
        if (audioContext && audioContext.state === 'suspended') {
            audioContext.resume().then(() => {
                console.log("AudioContext resumed by user gesture.");
                showNotification("è‡ªå‹•å†ç”Ÿãƒ–ãƒ­ãƒƒã‚¯ã‚’è§£é™¤ã—ã¾ã—ãŸã€‚", false, 1500, true);
            }).catch(e => {
                console.error("AudioContext resume failed:", e);
                showNotification("AudioContextã®å†é–‹ã«å¤±æ•—ã—ã¾ã—ãŸã€‚", true, 3000, true);
            });
        }
        
        // ãƒªã‚¹ãƒŠãƒ¼ã‚’å‰Šé™¤ã—ã¦ã€ä¸€åº¦ã ã‘å®Ÿè¡Œã•ã‚Œã‚‹ã‚ˆã†ã«ã™ã‚‹
        document.removeEventListener('click', handleFirstUserGesture);
        document.removeEventListener('touchend', handleFirstUserGesture);
        document.removeEventListener('keydown', handleFirstUserGesture);
    }

    // --- ãƒ¡ã‚¤ãƒ³ãƒ­ã‚¸ãƒƒã‚¯é–¢æ•° ---
    
    function handleFileSelection(event) { /* ... æ—¢å­˜ã®å®Ÿè£… ... */ }
    function processFile(file) { /* ... æ—¢å­˜ã®å®Ÿè£… ... */ }
    
    function connectSource() { /* ... æ—¢å­˜ã®å®Ÿè£… ... */ }
    
    // --- ãƒ—ãƒ¬ã‚¤ãƒ¤ãƒ¼åˆ¶å¾¡ ---
    
    // â­ æ–°è¦è¿½åŠ : player.play() ã® Promise æ‹’å¦ã‚’å‡¦ç†ã—ã€ãƒªãƒˆãƒ©ã‚¤ã‚’è©¦ã¿ã‚‹é–¢æ•°
    function tryPlayWithRetry() {
        // AudioContextãŒã‚µã‚¹ãƒšãƒ³ãƒ‰ã•ã‚Œã¦ã„ãŸã‚‰å†é–‹ã‚’è©¦ã¿ã‚‹ (ãƒ¦ãƒ¼ã‚¶ãƒ¼æ“ä½œãƒ•ãƒ©ã‚°ã«é–¢ã‚ã‚‰ãš)
        if (audioContext.state === 'suspended') {
            audioContext.resume().catch(err => {
                console.error("AudioContext resume failed on retry attempt:", err);
            });
        }
        
        player.play().then(() => {
            // æˆåŠŸ
        }).catch(e => {
            // å†ç”ŸãŒãƒ–ãƒ­ãƒƒã‚¯ã•ã‚ŒãŸå ´åˆ (NotAllowedError)
            if (e.name === 'NotAllowedError') {
                showNotification("è‡ªå‹•å†ç”ŸãŒãƒ–ãƒ­ãƒƒã‚¯ã•ã‚Œã¾ã—ãŸã€‚å†ç”Ÿãƒœã‚¿ãƒ³ã‚’ã‚¿ãƒƒãƒ—ã—ã¦ãã ã•ã„ã€‚", true, 5000, true);
            } else if (e.name !== 'AbortError') {
                 // AbortErrorã¯pause()ã®å¾Œã«play()ã‚’å‘¼ã¶éš›ãªã©ã«å‡ºã‚‹ãŸã‚ç„¡è¦–
                showNotification(`å†ç”Ÿãƒ–ãƒ­ãƒƒã‚¯: ${e.name}. æ‰‹å‹•å†ç”ŸãŒå¿…è¦ã§ã™ã€‚`, true, 5000, true);
            }
            updatePlayerStatusDisplay(true); // ã‚¹ãƒ†ãƒ¼ã‚¿ã‚¹ã‚’æ›´æ–°ã—ã¦ã€æ‰‹å‹•æ“ä½œã‚’ä¿ƒã™
        });
    }

    function togglePlayPause() {
        if (playlists.length === 0) return;

        if (player.paused) {
            // å†ç”Ÿ
            if (!isConnected) connectSource();
            
            if (audioContext.state === 'suspended') {
                audioContext.resume().catch(e => console.error("Resume failed:", e));
            }
            
            player.play().catch(e => {
                if (e.name === 'NotAllowedError') {
                    showNotification("è‡ªå‹•å†ç”ŸãŒãƒ–ãƒ­ãƒƒã‚¯ã•ã‚Œã¾ã—ãŸã€‚å†ç”Ÿãƒœã‚¿ãƒ³ã‚’ã‚¿ãƒƒãƒ—ã—ã¦ãã ã•ã„ã€‚", true, 5000, true);
                } else if (e.name !== 'AbortError') {
                    showNotification(`å†ç”Ÿãƒ–ãƒ­ãƒƒã‚¯: ${e.name}. æ‰‹å‹•å†ç”ŸãŒå¿…è¦ã§ã™ã€‚`, true, 5000, true);
                }
                updatePlayerStatusDisplay(true);
            });
            
        } else {
            // ä¸€æ™‚åœæ­¢
            // ã‚¯ãƒ­ã‚¹ãƒ•ã‚§ãƒ¼ãƒ‰åŠ¹æœã‚’åŠ ãˆã‚‹
            if (CROSSFADE_DURATION > 0 && isConnected) {
                gainNode.gain.cancelScheduledValues(audioContext.currentTime);
                gainNode.gain.linearRampToValueAtTime(0, audioContext.currentTime + CROSSFADE_DURATION);
                setTimeout(() => {
                    player.pause();
                    gainNode.gain.setValueAtTime(volumeSlider.value / 100.0, audioContext.currentTime);
                    updatePlayerStatusDisplay(true);
                    showNotification("ä¸€æ™‚åœæ­¢", false, 1000, true);
                }, CROSSFADE_DURATION * 1000);
            } else {
                player.pause();
                updatePlayerStatusDisplay(true);
                showNotification("ä¸€æ™‚åœæ­¢", false, 1000, true);
            }
        }
    }

    function loadTrack(index, wasUserInitiatedPlay = true) { /* ... æ—¢å­˜ã®å®Ÿè£… ... */ }

    function onLoadedMetadata() { /* ... æ—¢å­˜ã®å®Ÿè£… ... */ }
    
    function onTimeUpdate() { /* ... æ—¢å­˜ã®å®Ÿè£… ... */ }
    
    // â­ ä¿®æ­£: onTrackEnded ã®å‡¦ç†ã‚’å …ç‰¢ãªãƒ•ã‚©ãƒ¼ãƒ«ãƒãƒƒã‚¯ãƒ­ã‚¸ãƒƒã‚¯ã§å¼·åŒ–
    function onTrackEnded() {
        nextTrackNotificationSent = false;

        // 1. Single track loop (Loop 'one')
        if (isLoop === 'one') {
            player.currentTime = 0;
            // â­ ä¿®æ­£: player.play() ã‚’ tryPlayWithRetry ã«ç½®ãæ›ãˆ
            tryPlayWithRetry();
            return;
        }

        // 2. Next track logic (Loop 'all' or Shuffle)
        let nextIndex = currentIndex;
        if (isShuffle) {
            nextIndex = Math.floor(Math.random() * playlists.length);
        } else if (currentIndex < playlists.length - 1) {
            nextIndex = currentIndex + 1;
        } else if (isLoop === 'all') {
            nextIndex = 0;
        } else {
            // End of queue (Loop 'off')
            updatePlayerStatusDisplay(true);
            showNotification("å†ç”Ÿãƒªã‚¹ãƒˆã®çµ‚ç«¯ã«é”ã—ã¾ã—ãŸã€‚", false, 2000, true);
            return;
        }

        // 3. Play next track with crossfade (if available) or fallback
        // æ—¢å­˜ã® playNext() ãŒã‚¯ãƒ­ã‚¹ãƒ•ã‚§ãƒ¼ãƒ‰å‡¦ç†ã‚’æŒã¤ãŸã‚ã€ãã‚Œã‚’å„ªå…ˆçš„ã«åˆ©ç”¨
        if (typeof playNext === 'function') {
            playNext();
        } else {
            // playNextãŒãªã„å ´åˆã®ãƒ•ã‚©ãƒ¼ãƒ«ãƒãƒƒã‚¯: loadTrackã‚’å‘¼ã³å‡ºã—ã¦å†ç”Ÿã‚’è©¦ã¿ã‚‹
            if (playlists.length > 0) {
                loadTrack(nextIndex);
                // â­ ä¿®æ­£: player.play() ã‚’ tryPlayWithRetry ã«ç½®ãæ›ãˆ
                tryPlayWithRetry();
            }
        }
    }
    
    function onPlayerError() { /* ... æ—¢å­˜ã®å®Ÿè£… ... */ }
    function onPlay() { /* ... æ—¢å­˜ã®å®Ÿè£… ... */ }
    function onPause() { /* ... æ—¢å­˜ã®å®Ÿè£… ... */ }

    function playNext() { /* ... æ—¢å­˜ã®å®Ÿè£… ... */ }
    function playPrev() { /* ... æ—¢å­˜ã®å®Ÿè£… ... */ }
    
    function seek(time) { /* ... æ—¢å­˜ã®å®Ÿè£… ... */ }
    
    function updateDisplayedTrackInfo(track) { /* ... æ—¢å­˜ã®å®Ÿè£… ... */ }
    function resetDisplayedTrackInfo() { /* ... æ—¢å­˜ã®å®Ÿè£… ... */ }
    
    function updatePlayerStatusDisplay(force = false) { /* ... æ—¢å­˜ã®å®Ÿè£… ... */ }
    
    function handleUserAction(action, event = null) { /* ... æ—¢å­˜ã®å®Ÿè£… ... */ }
    
    // --- UIåˆ¶å¾¡é–¢æ•° (ä¸€éƒ¨å¤‰æ›´ã‚ã‚Š) ---
    function updateModeStatusDisplay() { /* ... æ—¢å­˜ã®å®Ÿè£… ... */ }
    function updateLoopButton() { /* ... æ—¢å­˜ã®å®Ÿè£… ... */ }
    function toggleLoop() { /* ... æ—¢å­˜ã®å®Ÿè£… ... */ }
    function toggleShuffle() { /* ... æ—¢å­˜ã®å®Ÿè£… ... */ }
    function updateVolume(value) { /* ... æ—¢å­˜ã®å®Ÿè£… ... */ }
    function resetVolumeToDefault() { /* ... æ—¢å­˜ã®å®Ÿè£… ... */ }
    function updateSeekBar(currentTime) { /* ... æ—¢å­˜ã®å®Ÿè£… ... */ }
    function moveTrack(from, to) { /* ... æ—¢å­˜ã®å®Ÿè£… ... */ }
    function moveTrackUp(index) { /* ... æ—¢å­˜ã®å®Ÿè£… ... */ }
    function moveTrackDown(index) { /* ... æ—¢å­˜ã®å®Ÿè£… ... */ }
    function updateAudioList() { /* ... æ—¢å­˜ã®å®Ÿè£… ... */ }
    function handleTrackSelect(index) { /* ... æ—¢å­˜ã®å®Ÿè£… ... */ }
    function removeTrack(index) { /* ... æ—¢å­˜ã®å®Ÿè£… ... */ }
    function toggleOverlay(overlayId, show) { /* ... æ—¢å­˜ã®å®Ÿè£… ... */ }
    function updateTrackDetails(track) { /* ... æ—¢å­˜ã®å®Ÿè£… ... */ }
    function hideTrackDetails() { /* ... æ—¢å­˜ã®å®Ÿè£… ... */ }
    function toggleMetadataEdit() { /* ... æ—¢å­˜ã®å®Ÿè£… ... */ }
    function saveEditedMetadata() { /* ... æ—¢å­˜ã®å®Ÿè£… ... */ }
    
    // --- AudioContext/Mixer/Visualizeré–¢é€£ ---
    function drawVisualizer() { /* ... æ—¢å­˜ã®å®Ÿè£… ... */ }
    function drawMixer() { /* ... æ—¢å­˜ã®å®Ÿè£… ... */ }
    function updateVisualizerState() { /* ... æ—¢å­˜ã®å®Ÿè£… ... */ }

    // --- ãƒ¡ã‚¿ãƒ‡ãƒ¼ã‚¿/çŠ¶æ…‹ç®¡ç† ---
    function getBlobUrl(picture) { /* ... æ—¢å­˜ã®å®Ÿè£… ... */ }
    function toggleFlip() { /* ... æ—¢å­˜ã®å®Ÿè£… ... */ }
    function saveState() { 
        localStorage.setItem(PLAYER_STATE_KEY, JSON.stringify({
            currentIndex, 
            isLoop, 
            isShuffle, 
            volume: volumeSlider.value,
            crossfade: CROSSFADE_DURATION,
            visualizer: isVisualizerEnabled, 
            playbackPosition: player.currentTime 
        }));
    }
    
    function loadState() { 
        const s = JSON.parse(localStorage.getItem(PLAYER_STATE_KEY));
        if (s) {
            currentIndex = s.currentIndex || 0;
            isLoop = s.isLoop || 'off';
            isShuffle = s.isShuffle || false;
            if (s.volume) {
                volumeSlider.value = s.volume;
                updateVolume(s.volume);
            }
            if (s.crossfade) {
                CROSSFADE_DURATION = s.crossfade;
                crossfadeDurationSlider.value = s.crossfade;
                crossfadeValueDisplay.textContent = s.crossfade.toFixed(1);
            }
            // â­ çŠ¶æ…‹ã‚’ãƒ­ãƒ¼ãƒ‰
            isVisualizerEnabled = s.visualizer || false; 
        }
    }
    
    // --- ãƒ¡ãƒ‡ã‚£ã‚¢ã‚»ãƒƒã‚·ãƒ§ãƒ³ API (å¤‰æ›´ãªã—) ---
    function setMediaSession(track) { /* ... æ—¢å­˜ã®å®Ÿè£… ... */ }

  </script>

</body>
</html>
