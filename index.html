<!DOCTYPE html>
<html lang="ja">
<head>
  <meta charset="UTF-8">
  <meta name="viewport" content="width=device-width, initial-scale=1.0, user-scalable=no, maximum-scale=1.0, viewport-fit=cover">
  <title>DmPlayer v2.0.18</title> <meta name="apple-mobile-web-app-capable" content="yes">
  <meta name="apple-mobile-web-app-status-bar-style" content="black-translucent">
  <meta name="apple-mobile-web-app-title" content="DmPlayer">
  
  <link rel="manifest" href="./manifest.json">

  <script src="https://cdn.jsdelivr.net/npm/jsmediatags@3.9.7/dist/jsmediatags.min.js"></script>

  <style>
    /* -------------------- */
    /* ã‚¹ã‚¿ã‚¤ãƒ«ã‚·ãƒ¼ãƒˆ */
    /* -------------------- */
    * { box-sizing: border-box; }
    :root {
      --dark-bg: #121212;
      --medium-bg: #181818;
      --accent-color: #00e6b8;
      --text-color: #ffffff;
      --text-light: #b3b3b3;
      --border-color: #333333;
      --error-color: #e6005c; 
      --debug-color: #00b300; 
      --switch-off: #4a4a4a;
      --switch-on: var(--accent-color);
      --peak-hold-color: #ffcc00;
    }

    body {
      margin: 0;
      background-color: var(--dark-bg); 
      font-family: 'Segoe UI', Roboto, Helvetica, Arial, sans-serif;
      color: var(--text-color);
      height: 100vh;
      min-height: -webkit-fill-available;
      overflow: hidden; 
      display: flex; 
    }
    
    .sidebar {
      width: 250px; 
      flex-shrink: 0; 
      background-color: var(--medium-bg);
      border-right: 1px solid var(--border-color);
      overflow: hidden;
      display: flex;
      flex-direction: column;
      padding: 0;
      position: relative; 
      height: 100%; 
    }
    
    .sidebar-content {
        flex-grow: 1;
        overflow-y: auto;
        padding: 15px 15px 5px 15px;
    }

    .sidebar h2 {
      font-size: 1.1em;
      margin-bottom: 10px;
      color: var(--text-light);
    }
    
    .sidebar-footer {
        padding: 10px 15px 15px 15px;
        background-color: #242424; 
        border-top: 1px solid #444444; 
        flex-shrink: 0; 
    }

    .app-info {
        font-size: 0.9em;
        color: var(--text-light);
        margin-bottom: 10px;
        display: flex;
        justify-content: space-between;
    }

    #appName {
        font-weight: bold;
        color: var(--text-color);
    }

    #appVersion {
        font-size: 0.8em;
        color: #999999;
        padding-top: 1px;
    }

    .footer-btn {
        width: 100%;
        padding: 8px;
        margin-top: 5px;
        background-color: #383838;
        color: white;
        border: none;
        border-radius: 4px;
        cursor: pointer;
        transition: background-color 0.2s;
        font-size: 0.9em;
        text-align: center;
        -webkit-tap-highlight-color: transparent;
    }

    .footer-btn:hover {
        background-color: #4a4a4a;
    }
    
    .input-group {
        margin-bottom: 15px;
    }
    .input-group label {
        display: block;
        font-size: 0.9em;
        color: var(--text-light);
        margin-bottom: 5px;
    }
    .input-group input[type="text"] {
        width: 100%;
        padding: 8px;
        background-color: #383838;
        border: 1px solid #555555;
        color: var(--text-color);
        border-radius: 4px;
        font-size: 1em;
    }

    .main {
      flex: 1; 
      display: flex;
      flex-direction: column;
      overflow: hidden;
      position: relative; 
      height: 100%; 
    }
    
    #fileInput { display: none; }
    
    .file-label {
        display: block;
        width: 100%;
        padding: 10px 15px;
        background-color: var(--accent-color); 
        color: var(--dark-bg);
        border-radius: 6px;
        font-weight: bold;
        text-align: center;
        cursor: pointer;
        transition: background-color 0.2s, box-shadow 0.2s;
        font-size: 1em;
        box-shadow: 0 4px 10px rgba(0, 230, 184, 0.3);
        margin-bottom: 15px; 
        margin-top: 5px; 
    }
    
    .file-label:hover {
        background-color: #00b38c;
        box-shadow: 0 6px 12px rgba(0, 230, 184, 0.4);
    }
    
    .switch-container {
        display: flex;
        align-items: center;
        justify-content: space-between;
        margin-bottom: 15px;
        padding: 5px 0;
        font-size: 0.95em;
    }

    .switch {
        position: relative;
        display: inline-block;
        width: 45px;
        height: 25px;
    }

    .switch input { opacity: 0; width: 0; height: 0; }

    .slider {
        position: absolute; cursor: pointer; top: 0; left: 0; right: 0; bottom: 0;
        background-color: var(--switch-off); transition: .4s; border-radius: 25px;
    }

    .slider:before {
        position: absolute; content: ""; height: 17px; width: 17px; left: 4px; bottom: 4px;
        background-color: white; transition: .4s; border-radius: 50%;
    }

    input:checked + .slider { background-color: var(--switch-on); }
    input:checked + .slider:before { transform: translateX(20px); }

    .audio-list {
        display: flex; flex-direction: column; gap: 5px; padding-top: 5px;
    }

    .queue-item {
        display: flex; align-items: center; width: 100%; padding: 8px 10px;
        background-color: #242424; color: var(--text-color); border: 1px solid #3a3a3a;
        border-radius: 6px; cursor: pointer; transition: background-color 0.2s, border-color 0.2s, box-shadow 0.2s;
        text-align: left; font-size: 0.9em; position: relative; overflow: hidden;
        -webkit-tap-highlight-color: transparent;
    }

    .queue-item:hover { background-color: #303030; }

    .queue-item.active-track {
        border: 1px solid var(--accent-color); border-left: 4px solid var(--accent-color); 
        background-color: #1a1a1a; box-shadow: 0 0 8px rgba(0, 230, 184, 0.3); 
        padding-left: 10px; 
    }
    
    .queue-item.placeholder-track { opacity: 0.6; font-style: italic; }
    
    .queue-index {
        font-size: 1.1em; font-weight: bold; color: var(--text-light);
        width: 25px; flex-shrink: 0; margin-right: 8px; text-align: center;
    }
    
    .track-info-container {
        flex-grow: 1; min-width: 0; display: flex; flex-direction: column;
    }

    .track-title-display {
        font-weight: bold; color: var(--text-color); white-space: nowrap;
        overflow: hidden; text-overflow: ellipsis; 
    }

    .track-artist-display {
        font-size: 0.8em; color: var(--text-light); white-space: nowrap;
        overflow: hidden; text-overflow: ellipsis; 
    }
    
    .queue-controls {
        flex-shrink: 0; margin-left: 8px; display: flex; align-items: center; gap: 3px; 
    }

    .queue-control-btn {
        background: #3a3a3a; color: white; border: none; padding: 4px;
        border-radius: 3px; cursor: pointer; font-size: 0.65em; line-height: 1;
        height: 20px; width: 20px; display: flex; align-items: center;
        justify-content: center; transition: background-color 0.1s, transform 0.1s;
    }
    
    .queue-control-btn:disabled {
        opacity: 0.4;
        cursor: default;
        transform: none;
        background: #3a3a3a;
        color: white;
    }

    .queue-control-btn:hover:not(:disabled) {
        background: var(--accent-color); color: var(--dark-bg); transform: scale(1.1);
    }
    
    .playing-status {
        font-size: 1.2em; color: var(--accent-color); width: 20px; text-align: center; line-height: 1;
    }
    .playing-status.ready-to-play { color: var(--error-color); }
    
    .screen {
      flex: 1; 
      padding: 30px;
      padding-top: 50px; 
      background: linear-gradient(135deg, var(--medium-bg), var(--dark-bg));
      display: flex;
      flex-direction: column;
      justify-content: center;
      align-items: center;
      overflow-y: auto; 
      position: relative; 
      perspective: 1000px; 
      z-index: 1; 
    }

    #visualizerCanvas {
        position: absolute;
        top: 0;
        left: 0;
        width: 100%;
        height: 100%;
        z-index: 0; 
        opacity: 0.6; 
        pointer-events: none; 
    }

    .cover-art-container {
      width: 250px; 
      height: 250px;
      margin-bottom: 25px;
      text-align: center;
      position: relative;
      transform-style: preserve-3d; 
      transition: transform 0.6s; 
      cursor: pointer; 
    }
    
    .cover-art-face {
        position: absolute; width: 100%; height: 100%;
        backface-visibility: hidden; border-radius: 12px;
        box-shadow: 0 15px 30px rgba(0, 0, 0, 0.5), 0 0 0 5px var(--medium-bg);
        overflow: hidden; background-color: var(--medium-bg); padding: 0;
    }

    .cover-art-front { z-index: 2; transform: rotateY(0deg); }

    #coverArt {
      width: 100%; height: 100%; object-fit: cover; border-radius: 12px;
    }
    
    .cover-art-back {
        transform: rotateY(180deg); z-index: 1; display: flex;
        justify-content: center; align-items: flex-start;
        background-color: #1c1c1c; border: 3px solid var(--accent-color); 
    }

    .cover-art-container.flipped { transform: rotateY(180deg); }

    #lyricsDisplay {
        padding: 15px; color: var(--text-light); font-size: 0.85em;
        text-align: center; overflow-y: auto; white-space: pre-wrap;
        max-height: 100%; width: 100%; line-height: 1.4;
    }

    #trackTitle {
      font-size: 2em; font-weight: bold; margin-top: 10px;
    }

    #trackArtist {
        font-size: 1.2em; color: var(--text-light); margin-bottom: 10px; 
    }
    
    .mode-status-display {
        display: flex; gap: 20px; margin-bottom: 30px; font-size: 1.0em; font-weight: 500;
    }

    .mode-item {
        display: flex; align-items: center; gap: 8px; padding: 5px 10px;
        border-radius: 4px; background-color: var(--medium-bg);
        color: var(--text-light); border: 1px solid var(--border-color);
        transition: all 0.2s;
    }

    .mode-item.active {
        background-color: var(--accent-color); color: var(--dark-bg);
        border-color: var(--accent-color); font-weight: bold;
        box-shadow: 0 4px 8px rgba(0, 230, 184, 0.2);
    }

    .mode-icon { font-size: 1.2em; line-height: 1; }

    .seek-container {
      width: 90%; max-width: 600px; margin-top: 30px; display: flex; align-items: center;
    }

    #seekBar {
      flex-grow: 1; margin: 0 15px; -webkit-appearance: none; appearance: none; 
      height: 8px; background: transparent; border-radius: 4px;
      cursor: pointer; transition: background 0.3s;
      --progress: 0%; 
    }

    #seekBar::-webkit-slider-runnable-track {
      width: 100%; height: 8px; cursor: pointer; border-radius: 4px;
      background: linear-gradient(to right, 
        var(--accent-color) 0%, var(--accent-color) var(--progress), 
        var(--border-color) var(--progress), var(--border-color) 100%
      );
    }
    
    #seekBar::-webkit-slider-thumb { -webkit-appearance: none; appearance: none; width: 1px; height: 1px; opacity: 0; border-radius: 50%; background: var(--accent-color); cursor: pointer; margin-top: -4px; }
    #volumeSlider::-webkit-slider-thumb { -webkit-appearance: none; appearance: none; width: 16px; height: 16px; border-radius: 50%; background: var(--accent-color); cursor: pointer; box-shadow: 0 0 5px var(--accent-color); }
    
    .time-display { font-size: 0.9em; width: 45px; text-align: center; color: var(--text-light); }

    .controls-moved {
        display: flex; align-items: center; justify-content: center;
        gap: 15px; margin-top: 20px; 
    }

    .controls-moved button {
        width: 45px; height: 45px; line-height: 45px; padding: 0;
        margin: 5px 0; background-color: var(--accent-color); border: none;
        font-size: 1.2em; color: var(--dark-bg); border-radius: 50%; 
        cursor: pointer; transition: transform 0.1s, background-color 0.2s, box-shadow 0.2s;
        font-weight: bold; -webkit-tap-highlight-color: transparent;
        display: flex; align-items: center; justify-content: center;
    }
    
    .controls-moved button:hover {
        background-color: #00b38c; transform: scale(1.1);
    }
    
    #playPauseBtn { width: 55px; height: 55px; font-size: 1.6em; }
    
    #seekBackwardBtn, #seekForwardBtn {
        background-color: var(--accent-color); color: var(--dark-bg); 
        font-size: 1.4em; width: 45px; height: 45px; border-radius: 50%;
        line-height: 1; font-weight: 900; padding-bottom: 2px; 
    }

    #seekBackwardBtn:hover, #seekForwardBtn:hover {
        background-color: #00b38c; transform: scale(1.1);
    }

    .player-ready #playPauseBtn {
        box-shadow: 0 0 0 4px var(--accent-color), 0 0 20px var(--accent-color);
        background-color: var(--accent-color); color: var(--dark-bg); 
    }

    #optionsBtn {
        position: absolute; top: 15px; left: 15px; background: none; 
        border: none; font-size: 1.8em; color: var(--text-color); 
        cursor: pointer; z-index: 50; padding: 5px 10px; 
        -webkit-tap-highlight-color: transparent; line-height: 1;
        transition: color 0.2s;
    }
    #optionsBtn:hover { color: var(--accent-color); }

    .control-panel {
      flex-shrink: 0; display: flex; background-color: var(--medium-bg);
      padding: 15px; flex-wrap: wrap; border-top: 1px solid var(--border-color);
      height: 180px; gap: 20px; justify-content: space-between;
    }
    
    .modes { flex: 1; padding: 0; min-width: 200px; }
    
    .volume-container {
        display: flex; align-items: center; gap: 8px; 
        padding-bottom: 5px; margin-top: 15px;
    }

    #volumeSlider {
        flex-grow: 1; margin: 0; -webkit-appearance: none; appearance: none; 
        height: 8px; background: #555; border-radius: 4px; cursor: pointer;
    }

    .section-title {
      font-size: 0.9em; margin-bottom: 5px; color: var(--text-light);
      border-bottom: 1px solid var(--border-color); padding-bottom: 5px;
    }
    
    .mixer-container {
        display: flex; align-items: center; gap: 10px; padding: 2px 0; 
        position: relative; 
    }

    .channel-label {
        font-size: 0.8em; color: var(--text-light); width: 15px; text-align: center;
    }

    .mixer-bar {
        flex-grow: 1; height: 8px; background-color: #3a3a3a; 
        border-radius: 6px; overflow: hidden; position: relative;
    }

    .mixer-bar-fill {
        height: 100%; width: 0%; transition: width 0.05s linear; 
        background-color: #008000; 
    }
    
    .peak-hold-indicator {
        position: absolute; top: 0; right: 0; width: 4px; height: 100%;
        background-color: var(--peak-hold-color); transition: transform 0.5s ease-out; 
        z-index: 10; border-radius: 2px;
    }
    
    .mode-buttons {
        display: flex; gap: 10px; margin-top: 10px;
    }
    .mode-buttons button {
        flex: 1; padding: 8px; background-color: #383838;
        color: white; border: none; border-radius: 4px;
        cursor: pointer; transition: background-color 0.2s;
        font-size: 0.9em;
    }
    .mode-buttons button:hover { background-color: #4a4a4a; }
    
    #notificationContainer {
        position: absolute; top: 15px; right: 15px; z-index: 1000;
        pointer-events: none; max-width: 300px; overflow: hidden;
    }
    
    .notification-message {
        background-color: #333; color: white; padding: 10px 15px;
        border-radius: 8px; margin-bottom: 10px; box-shadow: 0 4px 12px rgba(0, 0, 0, 0.5);
        opacity: 0; transform: translateX(100%); 
        transition: opacity 0.3s ease-out, transform 0.4s cubic-bezier(0.25, 0.46, 0.45, 0.94);
        pointer-events: all; font-size: 0.9em;
        border-left: 4px solid var(--accent-color); white-space: pre-wrap;
    }

    .notification-message.show { opacity: 1; transform: translateX(0); }
    .notification-message.slide-out { opacity: 0; transform: translateX(100%); }
    .notification-message.error { background-color: #4a1d2e; border-left-color: var(--error-color); }
    .notification-message.debug { background-color: #1b4d24; border-left-color: var(--debug-color); font-size: 0.8em; opacity: 0.7; }

    .settings-overlay {
        position: absolute; top: 0; left: 0; width: 100%; height: 100%;
        background-color: var(--medium-bg); z-index: 10; padding: 15px;
        display: flex; flex-direction: column;
        transform: translateX(-100%); transition: transform 0.3s cubic-bezier(0.4, 0, 0.2, 1);
    }

    .settings-overlay.show { transform: translateX(0); }
    
    .settings-content { flex-grow: 1; overflow-y: auto; }
    
    .settings-footer {
        padding-top: 15px; border-top: 1px solid var(--border-color); margin-top: auto;
    }
    
    .slider-container { margin-bottom: 20px; padding: 5px 0; }
    .slider-container label {
        display: block; font-size: 0.95em; margin-bottom: 5px; color: var(--text-light);
    }
    .slider-container input[type="range"] {
        width: 100%; -webkit-appearance: none; appearance: none; height: 8px;
        background: #555; border-radius: 4px; cursor: pointer;
    }
    .slider-value {
        font-size: 0.85em; color: var(--accent-color); display: block;
        text-align: right; margin-top: 5px;
    }

    .track-details-overlay {
        position: absolute; top: 0; right: 0; width: 300px; height: 100%;
        background-color: #242424; z-index: 200; padding: 20px;
        display: flex; flex-direction: column;
        transform: translateX(100%); transition: transform 0.3s cubic-bezier(0.4, 0, 0.2, 1);
        border-left: 1px solid #444444;
    }
    
    .track-details-overlay.show { transform: translateX(0); }

    .details-content {
        flex-grow: 1; overflow-y: auto; padding-top: 10px;
        font-size: 0.9em; color: var(--text-light);
    }
    
    .details-content strong {
        color: var(--text-color); font-weight: bold; display: block; padding-top: 5px;
    }

    .details-actions { display: flex; gap: 10px; padding: 10px 0; }
    .details-actions button {
        flex: 1; padding: 8px; background-color: #3a3a3a; color: white;
        border: none; border-radius: 4px; cursor: pointer; transition: background-color 0.2s;
    }
    .details-actions button:hover { background-color: #4a4a4a; }

    .close-details-btn {
        margin-top: auto; padding: 10px; background-color: var(--accent-color);
        color: var(--dark-bg); border: none; border-radius: 4px;
        cursor: pointer; font-weight: bold; transition: background-color 0.2s;
    }
    .close-details-btn:hover { background-color: #00b38c; }
    
    #metadataEditForm {
        padding: 10px; border: 1px dashed var(--border-color);
        border-radius: 8px; margin-top: 15px; display: none;
    }
    #metadataEditForm.show { display: block; }

    #player { display: none; }
    
    /* â­ ãƒ“ã‚¸ãƒ¥ã‚¢ãƒ©ã‚¤ã‚¶ãƒ¼ãƒ¢ãƒ¼ãƒ‰ (v2.0.16) â­ */
    body.visualizer-mode {
        display: block; 
    }
    
    /* ã‚µã‚¤ãƒ‰ãƒãƒ¼ï¼ˆã‚­ãƒ¥ãƒ¼ï¼‰ã¯è¡¨ç¤ºã™ã‚‹ã€‚ãƒ¦ãƒ¼ã‚¶ãƒ¼ã¯ã‚­ãƒ¥ãƒ¼ã‚’è¦‹ãŸã„ã¨ã®è¦æœ›ãŒã‚ã‚‹ãŸã‚å¸¸ã«è¡¨ç¤º */
    body.visualizer-mode .sidebar {
        display: block !important;
        z-index: 3;
    }

    /* ãƒ¡ã‚¤ãƒ³é ˜åŸŸã¯ã‚µã‚¤ãƒ‰ãƒãƒ¼åˆ†ã‚’æ®‹ã—ã¦è¡¨ç¤º */
    body.visualizer-mode .main {
        width: calc(100% - 250px);
        height: 100vh;
        flex: 1;
    }
    
    /* control-panel ã¯è¡¨ç¤ºã—ã¦ãŠãï¼ˆãƒœãƒªãƒ¥ãƒ¼ãƒ /ã‚·ãƒ£ãƒƒãƒ•ãƒ«ç­‰ã‚’æ®‹ã™ï¼‰ */
    body.visualizer-mode .control-panel {
        display: flex !important;
        z-index: 2;
    }
    
    body.visualizer-mode .screen {
        padding: 0; 
    }
    
    /* ãƒ“ã‚¸ãƒ¥ã‚¢ãƒ©ã‚¤ã‚¶ãƒ¼ãƒ¢ãƒ¼ãƒ‰ã§ã¯ã€Œãƒœã‚¿ãƒ³é¡ã®ã¿ã€ã‚’éè¡¨ç¤ºã«ã—ã¦
       ã‚¢ãƒ«ãƒãƒ ã‚«ãƒãƒ¼ã‚„ã‚·ãƒ¼ã‚¯ãƒãƒ¼ã€ã‚¿ã‚¤ãƒˆãƒ«é¡ã¯è¡¨ç¤ºã—ãŸã¾ã¾ã«ã™ã‚‹ã€‚
       canvas ã¯èƒŒæ™¯ã¨ã—ã¦è¡¨ç¤ºã•ã‚Œã€UI ã¯ãã®ä¸Šã«é‡ãªã‚‹ã€‚ */
    /* éè¡¨ç¤º: ãƒ“ã‚¸ãƒ¥ã‚¢ãƒ©ã‚¤ã‚¶ãƒ¼è¡¨ç¤ºæ™‚ã¯ã‚¢ãƒ«ãƒãƒ ã‚«ãƒãƒ¼ï¼ã‚¿ã‚¤ãƒˆãƒ«ï¼ã‚·ãƒ¼ã‚¯ãƒãƒ¼ã‚’éš ã™ */
    body.visualizer-mode .cover-art-container,
    body.visualizer-mode #trackTitle,
    body.visualizer-mode #trackArtist,
    body.visualizer-mode .seek-container,
    body.visualizer-mode .cover-art-face {
        display: none !important;
    }

    /* éè¡¨ç¤º: ç”»é¢ä¸Šã®å†ç”Ÿ/å‰å¾Œãªã©ã®å¤§ããªã‚³ãƒ³ãƒˆãƒ­ãƒ¼ãƒ«ã¯éš ã™ï¼ˆæ“ä½œã¯ control-panel ã§å¯èƒ½ï¼‰ */
    body.visualizer-mode .controls-moved,
    body.visualizer-mode #optionsBtn {
        display: none !important;
    }
    
    /* éšœå®³ã«ãªã‚‹æµ®éŠè¡¨ç¤ºï¼ˆãƒ«ãƒ¼ãƒ—/ã‚·ãƒ£ãƒƒãƒ•ãƒ«ã®ã‚¹ãƒ†ãƒ¼ã‚¿ã‚¹ï¼‰ã‚’éè¡¨ç¤ºã«ã™ã‚‹ */
    body.visualizer-mode #loopStatus,
    body.visualizer-mode #shuffleStatus {
        display: none !important;
    }
    
    /* ã‚­ãƒ£ãƒ³ãƒã‚¹ã¨é€šçŸ¥ã€ã‚ªãƒ¼ãƒãƒ¼ãƒ¬ã‚¤ã¯è¡¨ç¤ºã‚’ç¶­æŒ */
    body.visualizer-mode #visualizerCanvas {
        display: block !important; 
        opacity: 1.0; 
        z-index: 0 !important;
        pointer-events: none !important;
    }

    body.visualizer-mode #notificationContainer {
        display: block !important;
        pointer-events: none;
    }

    /* è¨­å®šã‚„è©³ç´°ã‚ªãƒ¼ãƒãƒ¼ãƒ¬ã‚¤ã¯è¡¨ç¤ºã‚’ç¶­æŒ */
    body.visualizer-mode .settings-overlay.show,
    body.visualizer-mode .track-details-overlay.show {
        display: flex !important; 
        z-index: 100;
    }

    /* -------------------- */
    /* ğŸš¨ ã‚µã‚¤ãƒ‰ãƒãƒ¼æ¨ªã®ä¸è¦ãªé»’ã„ãƒãƒ¼ã®ä¿®æ­£ (ãƒ¦ãƒ¼ã‚¶ãƒ¼è¦æœ›) */
    /* .sidebar ã«è¨­å®šã•ã‚Œã¦ã„ã‚‹ border-right ã‚’ç„¡åŠ¹åŒ–ã—ã¾ã™ã€‚ */
    /* -------------------- */
    .sidebar {
      border-right: none !important; 
    }

  </style>
</head>
<body>

  <div class="sidebar">
    
    <div id="settingsOverlay" class="settings-overlay">
        <h2>âš™ï¸ è¨­å®šãƒ¡ãƒ‹ãƒ¥ãƒ¼</h2>
        <div class="settings-content">
            
            <div class="switch-container">
                <label for="visualizerToggle">ã‚ªãƒ¼ãƒ‡ã‚£ã‚ªãƒ“ã‚¸ãƒ¥ã‚¢ãƒ©ã‚¤ã‚¶ãƒ¼</label>
                <label class="switch">
                    <input type="checkbox" id="visualizerToggle">
                    <span class="slider"></span>
                </label>
            </div>
            
            <div class="switch-container">
                <label for="nextTrackNotificationToggle">æ¬¡ã®æ›²ã‚’é€šçŸ¥</label>
                <label class="switch">
                    <input type="checkbox" id="nextTrackNotificationToggle" checked>
                    <span class="slider"></span>
                </label>
            </div>
            <div class="switch-container">
                <label for="debugToggle">ãƒ‡ãƒãƒƒã‚°è¡¨ç¤º</label>
                <label class="switch">
                    <input type="checkbox" id="debugToggle">
                    <span class="slider"></span>
                </label>
            </div>
            
            <div class="slider-container">
                <label for="crossfadeDurationSlider">ã‚¯ãƒ­ã‚¹ãƒ•ã‚§ãƒ¼ãƒ‰æ™‚é–“ (<span id="crossfadeValue">1.5</span>ç§’)</label>
                <input type="range" id="crossfadeDurationSlider" min="0.0" max="5.0" step="0.1" value="1.5">
                <span class="slider-value">æ›²ã®åˆ‡ã‚Šæ›¿ãˆã‚’æ»‘ã‚‰ã‹ã«ã—ã¾ã™ã€‚</span>
            </div>
            
        </div>
        <div class="settings-footer">
            <button id="closeSettingsBtn" class="footer-btn">é–‰ã˜ã‚‹</button>
        </div>
    </div>
    
    <div class="sidebar-content">
      <h2>ã‚­ãƒ¥ãƒ¼ã«è¿½åŠ </h2>
      <input type="file" id="fileInput" accept="audio/mp3, audio/m4a, audio/flac, audio/ogg, audio/wav, audio/mp4" multiple />
      <label for="fileInput" class="file-label">ğŸ“‚ ãƒ•ã‚¡ã‚¤ãƒ«ã‚’é¸æŠ</label>
      
      <h2>ã‚­ãƒ¥ãƒ¼</h2>
      <div class="audio-list" id="audioList"></div>
    </div>

    <div class="sidebar-footer">
        <div class="app-info">
          <div id="appName">DmPlayer</div>
          <div id="appVersion">v2.0.16</div> </div>
        <button id="settingsBtn" class="footer-btn">âš™ï¸ è¨­å®š</button>
        <button id="helpBtn" class="footer-btn">ğŸ’¡ ãƒ˜ãƒ«ãƒ—</button>
    </div>
  </div>

  <div class="main">
    
    <div id="notificationContainer"></div>
    <div id="trackDetailsOverlay" class="track-details-overlay">
        <h2>â„¹ï¸ ãƒˆãƒ©ãƒƒã‚¯è©³ç´°</h2>
        <div id="currentTrackInfoDetails" class="details-content">
            è©³ç´°ã‚’èª­ã¿è¾¼ã¿ä¸­...
            <div id="metadataEditForm">
                <div class="input-group">
                    <label for="editTitle">ã‚¿ã‚¤ãƒˆãƒ«</label>
                    <input type="text" id="editTitle">
                </div>
                <div class="input-group">
                    <label for="editArtist">ã‚¢ãƒ¼ãƒ†ã‚£ã‚¹ãƒˆ</label>
                    <input type="text" id="editArtist">
                </div>
                <button class="footer-btn" id="saveMetadataBtn">ã‚¿ã‚°ã‚’ä¿å­˜ã—ã¦é©ç”¨</button>
            </div>
        </div>
        
        <div class="details-actions">
            <button id="toggleEditBtn">ã‚¿ã‚°ã‚’ç·¨é›†</button>
        </div>
        <button id="closeDetailsBtn" class="close-details-btn">é–‰ã˜ã‚‹</button>
    </div>
    
    <div class="screen" id="playerScreen">
      
      <canvas id="visualizerCanvas"></canvas> 

      <button id="optionsBtn" title="ãƒˆãƒ©ãƒƒã‚¯è©³ç´°">â‹®</button>
      
      <div class="cover-art-container" title="ã‚¯ãƒªãƒƒã‚¯ã§æ­Œè©ã‚’è¡¨ç¤º">
          <div class="cover-art-face cover-art-front">
              <img id="coverArt" src="data:image/svg+xml;utf8,<svg xmlns='http://www.w3.org/2000/svg' width='250' height='250'><rect width='100%' height='100%' fill='%23333'/><text x='50%' y='50%' dominant-baseline='middle' text-anchor='middle' font-family='Arial' font-size='30' fill='%23ccc'>NO ART</text></svg>" alt="ã‚¢ãƒ«ãƒãƒ ã‚«ãƒãƒ¼" />
          </div>
          <div class="cover-art-face cover-art-back">
              <div id="lyricsDisplay">
                  æ­Œè©ã‚’èª­ã¿è¾¼ã¿ä¸­...
              </div>
          </div>
      </div>

      <div id="trackTitle">ãƒ•ã‚¡ã‚¤ãƒ«ã‚’é¸æŠã—ã¦ãã ã•ã„</div>
      <div id="trackArtist">â€”</div>
      
      <div class="mode-status-display">
        <div id="shuffleStatus" class="mode-item"></div>
        <div id="loopStatus" class="mode-item"></div>
      </div>
      
      <div class="seek-container">
        <div id="currentTime" class="time-display">0:00</div>
        <input type="range" id="seekBar" value="0" min="0" max="100">
        <div id="duration" class="time-display">0:00</div>
      </div>
      
      <div class="controls-moved">
        <button class="skip-button" id="playPrevBtn" title="å‰ã®æ›²">â®ï¸</button>
        <button id="seekBackwardBtn" title="10ç§’æˆ»ã‚‹">âª</button>
        <button id="playPauseBtn" class="control-button" title="å†ç”Ÿ/ä¸€æ™‚åœæ­¢">â–¶ï¸</button>
        <button id="seekForwardBtn" title="10ç§’ã‚¹ã‚­ãƒƒãƒ—">â©</button>
        <button class="skip-button" id="playNextBtn" title="æ¬¡ã®æ›²">â­ï¸</button>
      </div>

    </div>
    
    <div class="control-panel">
        <div class="modes">
            <div class="section-title">ğŸ”Š ãƒ¬ãƒ™ãƒ«ãƒ¡ãƒ¼ã‚¿ãƒ¼</div>
            <div class="mixer-container">
                <div class="channel-label">L</div>
                <div class="mixer-bar">
                    <div id="mixerBarL" class="mixer-bar-fill"></div>
                    <div id="peakHoldL" class="peak-hold-indicator"></div> </div>
            </div>
            <div class="mixer-container">
                <div class="channel-label">R</div>
                <div class="mixer-bar">
                    <div id="mixerBarR" class="mixer-bar-fill"></div>
                    <div id="peakHoldR" class="peak-hold-indicator"></div> </div>
            </div>
        </div>

        <div class="modes">
            <div class="section-title">âš™ï¸ ãƒœãƒªãƒ¥ãƒ¼ãƒ  & ãƒ¢ãƒ¼ãƒ‰</div>
            <div class="volume-container">
                <span style="font-size:0.9em; color: var(--text-light); white-space: nowrap;">éŸ³é‡: </span>
                <input type="range" id="volumeSlider" min="0" max="200" value="100">
                <span id="volumePercentage" style="font-size:0.9em; width: 35px; text-align: right; color: var(--accent-color); cursor: pointer; user-select: none;">100%</span>
            </div>
            
            <div class="mode-buttons">
                <button id="loopBtn">ãƒªãƒ”ãƒ¼ãƒˆ</button>
                <button id="shuffleBtn">ã‚·ãƒ£ãƒƒãƒ•ãƒ«</button>
            </div>
        </div>
    </div> 

    <audio id="player" preload="auto"></audio>
  </div>

<script>
    // â­â­â­ [ç·Šæ€¥ PWA URL å¼·åˆ¶ãƒªãƒ€ã‚¤ãƒ¬ã‚¯ãƒˆ - GitHub Pageså¯¾å¿œ] â­â­â­
    (function() {
        const TARGET_PATH = '/dmplayer45.github.io/'; 
        const isStandalone = window.matchMedia('(display-mode: standalone)').matches;
        
        // PWAèµ·å‹•ã‚’ç¤ºã™æ®‹éª¸ã€ã¾ãŸã¯ standalone ãƒ¢ãƒ¼ãƒ‰ã‚’ãƒã‚§ãƒƒã‚¯
        const hasPwaDebris = window.location.search.length > 0 || 
                             window.location.hash.length > 0 ||
                             isStandalone; 

        // ç¾åœ¨ã®ã‚¯ãƒªãƒ¼ãƒ³ãªãƒ‘ã‚¹
        const currentPathClean = window.location.pathname.replace(/\/$/, '');
        const targetPathClean = TARGET_PATH.replace(/\/$/, '');

        if (hasPwaDebris || currentPathClean !== targetPathClean) {
            // ç›®æ¨™ã®ã‚¯ãƒªãƒ¼ãƒ³ãªãƒ•ãƒ«URLã‚’æ§‹ç¯‰
            const targetCleanUrl = window.location.origin + TARGET_PATH;
            
            if (window.location.href !== targetCleanUrl) {
                console.log("PWA state or wrong path detected. Forcing redirect to:", targetCleanUrl);
                
                // å±¥æ­´ã‚’æ®‹ã•ãšã«ãƒªãƒ€ã‚¤ãƒ¬ã‚¯ãƒˆã‚’å®Ÿè¡Œ
                window.location.replace(targetCleanUrl);
                
                // ã‚¹ã‚¯ãƒªãƒ—ãƒˆã®å®Ÿè¡Œã‚’å³åº§ã«ä¸­æ­¢
                throw new Error("PWA Redirecting"); 
            }
        }
    })();
    // â­â­â­ [ç·Šæ€¥ PWA URL å¼·åˆ¶ãƒªãƒ€ã‚¤ãƒ¬ã‚¯ãƒˆçµ‚ã‚ã‚Š] â­â­â­

    // ** PWA Service Worker Registration **
    if ('serviceWorker' in navigator) {
        navigator.serviceWorker.register('./sw.js', { scope: './' })
        .then(reg => {
            console.log('ServiceWorker registered:', reg);
            showNotification('Service Worker ç™»éŒ²æ¸ˆã¿', false, 2000);

            reg.addEventListener('updatefound', () => {
                const newWorker = reg.installing;
                if (newWorker) {
                    newWorker.addEventListener('statechange', () => {
                        if (newWorker.state === 'installed') {
                            if (navigator.serviceWorker.controller) {
                                showNotification('æ–°ã—ã„ãƒãƒ¼ã‚¸ãƒ§ãƒ³ã‚’æ¤œå‡ºã—ã¾ã—ãŸã€‚ãƒšãƒ¼ã‚¸ã‚’ãƒªãƒ­ãƒ¼ãƒ‰ã™ã‚‹ã¨æ›´æ–°ã•ã‚Œã¾ã™ã€‚', false, 4000);
                            } else {
                                showNotification('ã‚¢ãƒ—ãƒªãŒã‚ªãƒ•ãƒ©ã‚¤ãƒ³ã§ä½¿ç”¨ã§ãã‚‹ã‚ˆã†ã«ãªã‚Šã¾ã—ãŸã€‚', false, 3000);
                            }
                        }
                    });
                }
            });
        }).catch(err => {
            if (err.message !== "PWA Redirecting") {
                console.warn('ServiceWorker registration failed:', err);
                showNotification('Service Worker ã®ç™»éŒ²ã«å¤±æ•—ã—ã¾ã—ãŸã€‚', true, 3000);
            }
        });
        
        navigator.serviceWorker.addEventListener('message', (ev) => {
            if (ev.data && ev.data.type === 'SKIP_WAITING') {
                navigator.serviceWorker.getRegistration().then(reg => {
                    if (reg && reg.waiting) reg.waiting.postMessage({ type: 'SKIP_WAITING' });
                });
            }
        });
    }

    // --- ã‚°ãƒ­ãƒ¼ãƒãƒ«å¤‰æ•° (å®Œå…¨ç‰ˆ) ---
    const playlists = [];
    const PLAYER_STATE_KEY = 'dmplayer_state_v3'; 
    
    // DOMè¦ç´ 
    let audioList, player, notificationContainer, settingsOverlay, debugToggle, nextTrackNotificationToggle;
    let trackDetailsOverlay, currentTrackInfoDetails, volumeSlider, volumePercentage;
    let shuffleStatus, loopStatus, playPauseBtn, seekBackwardBtn, seekForwardBtn, playNextBtn, playPrevBtn;
    let coverArtContainer, lyricsDisplay, crossfadeDurationSlider, crossfadeValueDisplay;
    let metadataEditForm, editTitleInput, editArtistInput, saveMetadataBtn, toggleEditBtn;
    let peakHoldL, peakHoldR, mixerBarL, mixerBarR;
    let seekBar, currentTimeDisplay, durationDisplay;
    let fileInput, trackTitle, trackArtist, coverArt;
    let optionsBtn, settingsBtn, closeSettingsBtn, helpBtn, closeDetailsBtn;

    // ãƒ“ã‚¸ãƒ¥ã‚¢ãƒ©ã‚¤ã‚¶ãƒ¼é–¢é€£ã®DOMè¦ç´ 
    let visualizerCanvas, visualizerCtx; 
    let visualizerToggle; 

    // çŠ¶æ…‹å¤‰æ•°
    let currentIndex = 0;
    let isLoop = 'off'; 
    let isShuffle = false;
    let isSeeking = false; 
    let nextTrackNotificationSent = false; 
    let isDebugging = false; 
    let nextTrackNotificationEnabled = true; 
    let isVisualizerEnabled = false;
    let wasUserInitiatedPlay = false;
    let CROSSFADE_DURATION = 1.5;
    let isCrossfading = false;
    let isSwitchingTrack = false;


    // Web Audio API
    let audioCtx;
    let currentSource; 
    let nextSource;
    let currentGainNode; 
    let nextGainNode; 
    let analyser;
    let splitter;
    let channel0, channel1;
    let rafId = null;
    let bufferLength = 0;
    let dataArray = null; 
    let peakLevelL = 0;
    let peakLevelR = 0;
    const peakDecayRate = 0.98; // ãƒ”ãƒ¼ã‚¯ãƒ¬ãƒ™ãƒ«ã®æ¸›è¡°ç‡

    // ãƒ—ãƒ¬ã‚¤ãƒªã‚¹ãƒˆæ“ä½œç”¨
    let originalPlaylist = [];
    let shuffleIndices = [];
    
    // å®šæ•°/DB
    const MAX_VOLUME = 2.0; // 200%
    const PEAK_HOLD_DELAY = 1000; // 1ç§’é–“ãƒ”ãƒ¼ã‚¯ã‚’ä¿æŒ
    const DB_NAME = 'DmPlayerDB';
    const DB_VERSION = 1;
    const STORE_NAME = 'metadata';
    let db; // IndexedDBã‚¤ãƒ³ã‚¹ã‚¿ãƒ³ã‚¹
    let dbReady = false;

    // ----------------------------------------------------
    // DBé–¢é€£é–¢æ•°
    // ----------------------------------------------------
    function initDB() {
        return new Promise((resolve) => {
            if (!window.indexedDB) {
                console.warn("IndexedDB not supported.");
                dbReady = false;
                return resolve();
            }
            const request = indexedDB.open(DB_NAME, DB_VERSION);
            request.onerror = (event) => {
                console.error("DBã‚ªãƒ¼ãƒ—ãƒ³ã‚¨ãƒ©ãƒ¼:", event.target.error);
                dbReady = false;
                resolve();
            };
            request.onsuccess = (event) => {
                db = event.target.result;
                dbReady = true;
                resolve();
            };
            request.onupgradeneeded = (event) => {
                const db = event.target.result;
                db.createObjectStore(STORE_NAME, { keyPath: 'fileName' });
            };
        });
    }

    // ----------------------------------------------------
    // ãƒ¦ãƒ¼ãƒ†ã‚£ãƒªãƒ†ã‚£é–¢æ•°
    // ----------------------------------------------------
    function removeExtension(filename) { return filename.replace(/\.[^/.]+$/, ""); }

    function formatTime(seconds) {
        if (isNaN(seconds) || seconds < 0) return '0:00';
        const minutes = Math.floor(seconds / 60);
        const remainingSeconds = Math.floor(seconds % 60);
        return `${minutes}:${remainingSeconds.toString().padStart(2, '0')}`;
    }

    function showNotification(message, isError = false, duration = 3000, isDebug = false) {
        if (!notificationContainer) return;
        if (!isDebugging && isDebug) return;

        const div = document.createElement('div');
        div.className = `notification-message ${isError ? 'error' : ''} ${isDebug ? 'debug' : ''}`;
        div.textContent = message;
        notificationContainer.appendChild(div);
        setTimeout(() => div.classList.add('show'), 10);
        setTimeout(() => { 
            div.classList.remove('show'); 
            setTimeout(() => div.remove(), 500); 
        }, duration);
    }
    
    function getNextTrackIndex(current) {
        if (playlists.length === 0) return -1;
        if (isLoop === 'single') return current;
        
        let nextIndex;
        if (isShuffle) {
            const currentShuffleIndex = shuffleIndices.indexOf(current);
            if (currentShuffleIndex === -1) { // ç•°å¸¸å€¤
                return (current + 1) % playlists.length;
            }
            nextIndex = shuffleIndices[(currentShuffleIndex + 1) % playlists.length];
        } else {
            nextIndex = (current + 1) % playlists.length;
        }

        if (isLoop === 'all' || isShuffle) {
            return nextIndex;
        } else {
            // ãƒ«ãƒ¼ãƒ—OFFã®å ´åˆã€ãƒªã‚¹ãƒˆã®æœ€å¾Œã¾ã§å†ç”Ÿã—ãŸã‚‰çµ‚äº†
            return (current + 1 < playlists.length) ? nextIndex : -1;
        }
    }
    
    function getPreviousTrackIndex(current) {
        if (playlists.length === 0) return -1;
        
        if (isShuffle) {
            const currentShuffleIndex = shuffleIndices.indexOf(current);
            if (currentShuffleIndex === -1) { // ç•°å¸¸å€¤
                return (current - 1 + playlists.length) % playlists.length;
            }
            const prevShuffleIndex = (currentShuffleIndex - 1 + playlists.length) % playlists.length;
            return shuffleIndices[prevShuffleIndex];
        } else {
            return (current - 1 + playlists.length) % playlists.length;
        }
    }


    // ----------------------------------------------------
    // ãƒ•ã‚¡ã‚¤ãƒ«ã¨ãƒ—ãƒ¬ã‚¤ãƒªã‚¹ãƒˆå‡¦ç†
    // ----------------------------------------------------
    
    // ãƒ•ã‚¡ã‚¤ãƒ«é¸æŠã‚¤ãƒ™ãƒ³ãƒˆãƒãƒ³ãƒ‰ãƒ©
    function handleFileSelect(event) {
        const files = Array.from(event.target.files);
        if (files.length === 0) return;
        handleAddFiles(files);
        event.target.value = null; // åŒã˜ãƒ•ã‚¡ã‚¤ãƒ«ã‚’ç¶šã‘ã¦é¸æŠã§ãã‚‹ã‚ˆã†ã«ã‚¯ãƒªã‚¢
    }

    // ãƒ•ã‚¡ã‚¤ãƒ«ã‚­ãƒ¥ãƒ¼è¿½åŠ å‡¦ç†
    async function handleAddFiles(files) {
        showNotification(`${files.length}å€‹ã®ãƒ•ã‚¡ã‚¤ãƒ«ã‚’ã‚­ãƒ¥ãƒ¼ã«è¿½åŠ ä¸­...`, false, 2000, true);
        
        // ãƒ•ã‚¡ã‚¤ãƒ«å‡¦ç†ã¨ã‚¿ã‚°èª­ã¿è¾¼ã¿ã‚’ä¸¦è¡Œã—ã¦è¡Œã†Promiseã®é…åˆ—
        const newTrackPromises = files.map(file => {
            const fileName = file.name;
            // ãƒ—ãƒ¬ã‚¤ãƒªã‚¹ãƒˆã‚ªãƒ–ã‚¸ã‚§ã‚¯ãƒˆã‚’å…ˆã«ä½œæˆã—ã€ã‚­ãƒ¥ãƒ¼ã«è¿½åŠ 
            const track = { 
                file: file, 
                name: fileName, 
                title: removeExtension(fileName), 
                artist: 'Unknown Artist', 
                album: 'Unknown Album', 
                lyrics: '', // ã‚¿ã‚°ã§æ›´æ–°
                coverArt: 'placeholder.png', 
                isPlaceholder: true, 
                duration: 0, 
                bitrate: null, 
                sampleRate: null,
                url: URL.createObjectURL(file) // ãƒ•ã‚¡ã‚¤ãƒ«URLã‚’ä½œæˆ
            };
            playlists.push(track); 
            
            // ã‚¿ã‚°èª­ã¿è¾¼ã¿ã‚’Promiseã§ãƒ©ãƒƒãƒ—
            return new Promise((resolve) => {
                if (file.size === 0) {
                    track.isPlaceholder = false;
                    showNotification(`${fileName} ã¯ç©ºãƒ•ã‚¡ã‚¤ãƒ«ã®ãŸã‚ã‚¹ã‚­ãƒƒãƒ—ã—ã¾ã—ãŸã€‚`, true, 3000, true);
                    resolve(track);
                    return;
                }
                
                jsmediatags.read(file, { 
                    onSuccess: (tag) => {
                        const tags = tag.tags;
                        track.title = tags.title || removeExtension(file.name);
                        track.artist = tags.artist || 'Unknown Artist';
                        track.album = tags.album || 'Unknown Album';
                        track.lyrics = tags.lyrics ? tags.lyrics.text : '';

                        if (tags.picture) {
                            // ç”»åƒå‡¦ç†ãƒ­ã‚¸ãƒƒã‚¯ (URLã‚’DataURLã«å¤‰æ›)
                            const base64String = tags.picture.data.reduce((acc, current) => acc + String.fromCharCode(current), '');
                            track.coverArt = `data:${tags.picture.format};base64,${btoa(base64String)}`;
                        }
                        
                        track.isPlaceholder = false;
                        resolve(track);
                    },
                    onError: (error) => {
                        console.error("Error reading tags for", file.name, ":", error);
                        track.isPlaceholder = false;
                        resolve(track); 
                    }
                });
            });
        });
        
        updateAudioList(); // ãƒ•ã‚¡ã‚¤ãƒ«ãŒã‚­ãƒ¥ãƒ¼ã«è¿½åŠ ã•ã‚ŒãŸã“ã¨ã‚’å³åº§ã«UIã«åæ˜ 

        await Promise.all(newTrackPromises);

        // ã‚·ãƒ£ãƒƒãƒ•ãƒ«çŠ¶æ…‹ã‚’æ›´æ–°
        if (isShuffle) { applyShuffle(); } 
        updateAudioList(); // ãƒ¡ã‚¿ãƒ‡ãƒ¼ã‚¿ãŒæ›´æ–°ã•ã‚ŒãŸã‚‰UIã‚’å†åº¦æ›´æ–°

        showNotification(`å…¨ã¦ã®ãƒ•ã‚¡ã‚¤ãƒ«ã‚’ã‚­ãƒ¥ãƒ¼ã«è¿½åŠ ã—ã¾ã—ãŸ (${playlists.length}æ›²)`, false, 2500, true);

        // ã‚­ãƒ¥ãƒ¼ãŒç©ºã®çŠ¶æ…‹ã‹ã‚‰è¿½åŠ ã•ã‚ŒãŸå ´åˆã€æœ€åˆã®æ›²ã‚’ãƒ­ãƒ¼ãƒ‰
        if (playlists.length > 0 && player.src === '') {
             loadTrack(0); 
        }
    }

    function removeTrack(index) {
        if (index < 0 || index >= playlists.length) return;

        const trackToRemove = playlists[index];
        URL.revokeObjectURL(trackToRemove.url); // ã‚ªãƒ–ã‚¸ã‚§ã‚¯ãƒˆURLã‚’è§£æ”¾
        playlists.splice(index, 1);

        if (index === currentIndex) {
            // å†ç”Ÿä¸­ã®æ›²ãŒå‰Šé™¤ã•ã‚ŒãŸå ´åˆ
            if (playlists.length > 0) {
                currentIndex = Math.min(index, playlists.length - 1);
                loadTrack(currentIndex, true);
                if (!player.paused) togglePlayPause(); // å†ç”Ÿã‚’ç¶šè¡Œ
            } else {
                player.src = '';
                currentIndex = 0;
                updateAudioList();
                updateCoverArt('placeholder.png');
                trackTitle.textContent = 'DmPlayer';
                trackArtist.textContent = 'ã‚­ãƒ¥ãƒ¼ã«ãƒ•ã‚¡ã‚¤ãƒ«ã‚’è¿½åŠ ã—ã¦ãã ã•ã„';
            }
        } else if (index < currentIndex) {
            // å†ç”Ÿä¸­ã®æ›²ã‚ˆã‚Šå‰ã®æ›²ãŒå‰Šé™¤ã•ã‚ŒãŸå ´åˆã€ã‚¤ãƒ³ãƒ‡ãƒƒã‚¯ã‚¹ã‚’èª¿æ•´
            currentIndex--;
        }

        if (isShuffle) { applyShuffle(); } // ã‚·ãƒ£ãƒƒãƒ•ãƒ«ãƒªã‚¹ãƒˆã‚’å†æ§‹ç¯‰
        updateAudioList();
        saveState();
        showNotification(`${trackToRemove.title} ã‚’ã‚­ãƒ¥ãƒ¼ã‹ã‚‰å‰Šé™¤ã—ã¾ã—ãŸ`, false, 1500, true);
    }
    
    function moveTrackUp(index) {
        if (index <= 0) return;
        [playlists[index], playlists[index - 1]] = [playlists[index - 1], playlists[index]];
        if (index === currentIndex) currentIndex--;
        else if (index - 1 === currentIndex) currentIndex++;
        if (isShuffle) applyShuffle();
        updateAudioList();
        saveState();
    }

    function moveTrackDown(index) {
        if (index >= playlists.length - 1) return;
        [playlists[index], playlists[index + 1]] = [playlists[index + 1], playlists[index]];
        if (index === currentIndex) currentIndex++;
        else if (index + 1 === currentIndex) currentIndex--;
        if (isShuffle) applyShuffle();
        updateAudioList();
        saveState();
    }
    
    // ----------------------------------------------------
    // ã‚ªãƒ¼ãƒ‡ã‚£ã‚ªåˆ¶å¾¡
    // ----------------------------------------------------
    
    function initializeAudioContext() {
        if (!audioCtx) {
            try {
                audioCtx = new (window.AudioContext || window.webkitAudioContext)();
                setupAudioNodes();
            } catch (e) {
                showNotification('Web Audio APIã®åˆæœŸåŒ–ã«å¤±æ•—ã—ã¾ã—ãŸã€‚', true);
                console.error("Audio Context Init Error:", e);
                return false;
            }
        }
        if (audioCtx.state === 'suspended') {
            audioCtx.resume().catch(e => console.error("AudioContext resume failed:", e));
        }
        return true;
    }

    function setupAudioNodes() {
        if (!audioCtx || analyser) return; // æ—¢ã«ã‚»ãƒƒãƒˆã‚¢ãƒƒãƒ—æ¸ˆã¿

        // AnalyserNode
        analyser = audioCtx.createAnalyser();
        analyser.fftSize = 2048;
        bufferLength = analyser.frequencyBinCount;
        dataArray = new Uint8Array(bufferLength);

        // SplitterNode (ã‚¹ãƒ†ãƒ¬ã‚ªãƒ¬ãƒ™ãƒ«ãƒ¡ãƒ¼ã‚¿ãƒ¼ç”¨)
        splitter = audioCtx.createChannelSplitter(2);
        
        // Analyser for Left Channel (Channel 0)
        channel0 = audioCtx.createAnalyser();
        channel0.fftSize = 2048;
        
        // Analyser for Right Channel (Channel 1)
        channel1 = audioCtx.createAnalyser();
        channel1.fftSize = 2048;

        splitter.connect(channel0, 0);
        splitter.connect(channel1, 1);

        // Audioè¦ç´ ã‹ã‚‰ã‚½ãƒ¼ã‚¹ã‚’ä½œæˆ
        currentSource = audioCtx.createMediaElementSource(player);

        // åˆæœŸã‚²ã‚¤ãƒ³ãƒãƒ¼ãƒ‰ã‚’è¨­å®š
        currentGainNode = audioCtx.createGain();
        currentGainNode.gain.value = player.volume * (volumeSlider.value / 100);
        
        // æ¥ç¶š: Source -> Gain -> Analyser -> Splitter -> (Ch0/Ch1 Analysers) -> Destination
        currentSource.connect(currentGainNode);
        currentGainNode.connect(analyser);
        currentGainNode.connect(splitter); // ãƒ¬ãƒ™ãƒ«ãƒ¡ãƒ¼ã‚¿ãƒ¼ç”¨
        analyser.connect(audioCtx.destination); // æœ€çµ‚å‡ºåŠ›
    }

    // ã‚¯ãƒ­ã‚¹ãƒ•ã‚§ãƒ¼ãƒ‰ã‚ã‚Šã§æ¬¡ã®ãƒˆãƒ©ãƒƒã‚¯ã‚’æº–å‚™
    function prepareNextTrack(nextIndex) {
        if (isSwitchingTrack || !initializeAudioContext()) return;
        if (nextIndex === -1) {
            showNotification('ã‚­ãƒ¥ãƒ¼ã®çµ‚ã‚ã‚Šã«åˆ°é”ã—ã¾ã—ãŸã€‚', false, 2000);
            return;
        }

        isSwitchingTrack = true;
        const nextTrack = playlists[nextIndex];

        // æ¬¡ã®ã‚ªãƒ¼ãƒ‡ã‚£ã‚ªè¦ç´ ã‚’ä½œæˆ (playerã¨åŒã˜ãƒ—ãƒ­ãƒ‘ãƒ†ã‚£ã‚’è¨­å®š)
        const nextAudio = new Audio(nextTrack.url);
        nextAudio.preload = 'auto';

        // æ¬¡ã®ã‚½ãƒ¼ã‚¹ã¨ã‚²ã‚¤ãƒ³ãƒãƒ¼ãƒ‰ã‚’ä½œæˆ
        nextSource = audioCtx.createMediaElementSource(nextAudio);
        nextGainNode = audioCtx.createGain();
        nextGainNode.gain.value = 0; // æœ€åˆã¯ãƒŸãƒ¥ãƒ¼ãƒˆ

        // æ¥ç¶š: NextSource -> NextGain -> Analyser (ä¸€æ™‚çš„) -> Destination
        nextSource.connect(nextGainNode);
        nextGainNode.connect(analyser);
        nextGainNode.connect(splitter);
        nextGainNode.connect(audioCtx.destination);

        nextAudio.onloadedmetadata = () => {
            console.log("Next track metadata loaded. Starting crossfade.");
            
            // ã‚¯ãƒ­ã‚¹ãƒ•ã‚§ãƒ¼ãƒ‰ã®æº–å‚™
            const now = audioCtx.currentTime;
            
            // ç¾åœ¨ã®ãƒˆãƒ©ãƒƒã‚¯ã‚’ãƒ•ã‚§ãƒ¼ãƒ‰ã‚¢ã‚¦ãƒˆ
            currentGainNode.gain.cancelScheduledValues(now);
            currentGainNode.gain.linearRampToValueAtTime(0, now + CROSSFADE_DURATION);

            // æ¬¡ã®ãƒˆãƒ©ãƒƒã‚¯ã‚’ãƒ•ã‚§ãƒ¼ãƒ‰ã‚¤ãƒ³
            nextGainNode.gain.cancelScheduledValues(now);
            nextGainNode.gain.linearRampToValueAtTime(player.volume * (volumeSlider.value / 100), now + CROSSFADE_DURATION);
            
            // å†ç”Ÿé–‹å§‹
            nextAudio.play().catch(e => console.error("Next audio play failed:", e));

            // ã‚¯ãƒ­ã‚¹ãƒ•ã‚§ãƒ¼ãƒ‰ãŒå®Œäº†ã—ãŸã‚‰åˆ‡ã‚Šæ›¿ãˆã‚’å®Œäº†
            setTimeout(() => {
                // å¤ã„ã‚½ãƒ¼ã‚¹ã¨ãƒãƒ¼ãƒ‰ã‚’ç ´æ£„
                if (currentSource) currentSource.disconnect();
                if (currentGainNode) currentGainNode.disconnect();
                if (player.src) URL.revokeObjectURL(player.src);
                player.pause();
                
                // æ–°ã—ã„è¦ç´ ã«ç½®ãæ›ãˆ
                player.src = nextAudio.src;
                player.currentTime = 0; // æ–°ã—ã„ãƒˆãƒ©ãƒƒã‚¯ã®å†ç”Ÿé–‹å§‹ä½ç½®ã¯0
                
                // ã‚°ãƒ­ãƒ¼ãƒãƒ«ãªWeb Audioãƒãƒ¼ãƒ‰å‚ç…§ã‚’æ›´æ–° (é‡è¦)
                // playerè¦ç´ ã¯DOMã®ã¾ã¾ã§ã€Web Audioã®æ¥ç¶šã®ã¿å…¥ã‚Œæ›¿ãˆã‚‹
                currentSource = audioCtx.createMediaElementSource(player); // å†åº¦ä½œæˆ
                currentGainNode = nextGainNode;
                
                currentSource.connect(currentGainNode);
                currentGainNode.connect(analyser);
                currentGainNode.connect(splitter);
                currentGainNode.connect(audioCtx.destination);
                
                // çŠ¶æ…‹æ›´æ–°
                currentIndex = nextIndex;
                onLoadedMetadata(nextTrack); // UIã‚’æ›´æ–°
                updateAudioList();
                saveState();

                isSwitchingTrack = false;
                nextSource = null; // æ¬¡ã®ã‚½ãƒ¼ã‚¹ã‚’ã‚¯ãƒªã‚¢
            }, CROSSFADE_DURATION * 1000); 
        };
        
        nextAudio.onerror = (e) => {
            console.error("Next audio load error:", e);
            isSwitchingTrack = false;
            showNotification(`æ¬¡ã®æ›² (${nextTrack.title}) ã®ãƒ­ãƒ¼ãƒ‰ä¸­ã«ã‚¨ãƒ©ãƒ¼ãŒç™ºç”Ÿã—ã¾ã—ãŸã€‚ã‚¹ã‚­ãƒƒãƒ—ã—ã¾ã™ã€‚`, true, 3000);
            playNext(true); // å¼·åˆ¶çš„ã«æ¬¡ã®æ¬¡ã®æ›²ã‚’è©¦è¡Œ
        };
    }
    
    function loadTrack(index, forcePlay = false) {
        if (index < 0 || index >= playlists.length) return;

        const track = playlists[index];
        const wasPaused = player.paused;

        // ã‚¯ãƒ­ã‚¹ãƒ•ã‚§ãƒ¼ãƒ‰ãŒæœ‰åŠ¹ãªå ´åˆã¯prepareNextTrackã‚’ä½¿ã†
        if (CROSSFADE_DURATION > 0 && !player.paused) {
            prepareNextTrack(index);
            return;
        }
        
        if (player.src) {
            URL.revokeObjectURL(player.src); // æ—¢å­˜ã®ã‚ªãƒ–ã‚¸ã‚§ã‚¯ãƒˆURLã‚’è§£æ”¾
        }
        
        currentIndex = index;
        player.src = track.url;
        player.load();
        
        onLoadedMetadata(track);
        updateAudioList();
        saveState();

        if (forcePlay || !wasPaused) {
            // Web Audio Contextã®å†é–‹ã¨å†ç”Ÿ
            handleUserAction(() => {
                player.play().catch(e => {
                    if (e.name !== 'NotAllowedError') {
                        showNotification('è‡ªå‹•å†ç”ŸãŒãƒ–ãƒ­ãƒƒã‚¯ã•ã‚Œã¾ã—ãŸã€‚å†ç”Ÿãƒœã‚¿ãƒ³ã‚’æŠ¼ã—ã¦ãã ã•ã„ã€‚', true, 5000);
                    }
                    console.error("Auto play failed:", e);
                });
            });
        }
    }

    function togglePlayPause() {
        if (player.paused) {
            player.play().catch(e => {
                showNotification('å†ç”Ÿã‚¨ãƒ©ãƒ¼: ãƒ¦ãƒ¼ã‚¶ãƒ¼æ“ä½œãŒå¿…è¦ã§ã™ã€‚', true, 3000);
                console.error("Play failed:", e);
            });
        } else {
            player.pause();
        }
        updateAudioList();
        // å†ç”Ÿé–‹å§‹æ™‚ã«ãƒ“ã‚¸ãƒ¥ã‚¢ãƒ©ã‚¤ã‚¶ãƒ¼ã®æç”»ãƒ«ãƒ¼ãƒ—ã‚’é–‹å§‹
        if (!player.paused && isVisualizerEnabled && rafId === null) {
            drawVisualizer();
        }
    }

    function playNext(skipCrossfade = false) {
        if (isSwitchingTrack) return;
        const nextIndex = getNextTrackIndex(currentIndex);
        
        if (nextIndex !== -1) {
            if (CROSSFADE_DURATION > 0 && !player.paused && !skipCrossfade) {
                prepareNextTrack(nextIndex);
            } else {
                loadTrack(nextIndex, !player.paused);
            }
        } else {
            // å†ç”Ÿçµ‚äº†
            if (isLoop === 'off') {
                player.pause();
                player.currentTime = 0;
                updateAudioList();
                showNotification('ãƒ—ãƒ¬ã‚¤ãƒªã‚¹ãƒˆã®çµ‚ã‚ã‚Šã«åˆ°é”ã—ã¾ã—ãŸã€‚', false, 2000);
            }
        }
    }

    function playPrev() {
        if (player.currentTime > 3) {
            seekAudio(0); // 3ç§’ä»¥ä¸Šå†ç”Ÿã—ã¦ã„ãŸã‚‰å·»ãæˆ»ã—
        } else {
            const prevIndex = getPreviousTrackIndex(currentIndex);
            loadTrack(prevIndex, !player.paused);
        }
    }

    function seekAudio(time) {
        if (isNaN(player.duration)) return;
        player.currentTime = Math.max(0, Math.min(time, player.duration));
    }

    function onLoadedMetadata(track) {
        if (!track) return;
        durationDisplay.textContent = formatTime(player.duration);
        trackTitle.textContent = track.title;
        trackArtist.textContent = track.artist;
        updateCoverArt(track.coverArt);
        lyricsDisplay.textContent = track.lyrics || 'æ­Œè©æƒ…å ±ã¯ã‚ã‚Šã¾ã›ã‚“ã€‚';
        setMediaSession(track);
    }
    
    function handleAudioError(e) {
        showNotification(`ã‚ªãƒ¼ãƒ‡ã‚£ã‚ªã‚¨ãƒ©ãƒ¼: ${e.message || 'ä¸æ˜ãªã‚¨ãƒ©ãƒ¼'}`, true, 4000);
        console.error("Audio Error:", e);
        // ã‚¨ãƒ©ãƒ¼ç™ºç”Ÿæ™‚ã¯å¼·åˆ¶çš„ã«æ¬¡ã®æ›²ã¸ã‚¹ã‚­ãƒƒãƒ—ã‚’è©¦ã¿ã‚‹
        if (playlists.length > 0) {
            showNotification('ã‚ªãƒ¼ãƒ‡ã‚£ã‚ªã‚¨ãƒ©ãƒ¼ã‚’æ¤œå‡ºã—ã¾ã—ãŸã€‚æ¬¡ã®æ›²ã‚’è©¦è¡Œã—ã¾ã™ã€‚', false, 2000);
            playNext(true); // ã‚¯ãƒ­ã‚¹ãƒ•ã‚§ãƒ¼ãƒ‰ã‚’ã‚¹ã‚­ãƒƒãƒ—ã—ã¦æ¬¡ã®æ›²ã¸
        }
    }

    // ----------------------------------------------------
    // UI/çŠ¶æ…‹æ›´æ–°
    // ----------------------------------------------------
    function updateVolume(value) {
        const volume = value / 100;
        player.volume = Math.min(volume, MAX_VOLUME);
        volumePercentage.textContent = `${Math.round(volume * 100)}%`;
        if (currentGainNode) {
            currentGainNode.gain.value = player.volume;
        }
    }
    
    function toggleLoop() {
        if (isLoop === 'off') {
            isLoop = 'all';
            showNotification('ãƒ«ãƒ¼ãƒ—ãƒ¢ãƒ¼ãƒ‰: å…¨æ›²', false, 1500);
        } else if (isLoop === 'all') {
            isLoop = 'single';
            showNotification('ãƒ«ãƒ¼ãƒ—ãƒ¢ãƒ¼ãƒ‰: ä¸€æ›²', false, 1500);
        } else {
            isLoop = 'off';
            showNotification('ãƒ«ãƒ¼ãƒ—ãƒ¢ãƒ¼ãƒ‰: OFF', false, 1500);
        }
        updateLoopStatus();
        saveState();
    }

    function updateLoopStatus() {
        loopStatus.textContent = isLoop === 'off' ? 'ğŸ”' : (isLoop === 'all' ? 'ğŸ” All' : 'ğŸ”‚ Single');
    }

    function toggleShuffle() {
        isShuffle = !isShuffle;
        if (isShuffle) {
            applyShuffle();
            showNotification('ã‚·ãƒ£ãƒƒãƒ•ãƒ«: ON', false, 1500);
        } else {
            // ã‚·ãƒ£ãƒƒãƒ•ãƒ«OFFæ™‚ã€ç¾åœ¨ã®æ›²ãŒã‚ªãƒªã‚¸ãƒŠãƒ«ãƒªã‚¹ãƒˆã®ã©ã“ã«ã‚ã‚‹ã‹ã‚’æ¢ã™
            currentIndex = shuffleIndices[currentIndex] || 0;
            shuffleIndices = []; // ã‚·ãƒ£ãƒƒãƒ•ãƒ«ãƒªã‚¹ãƒˆã‚’ã‚¯ãƒªã‚¢
            showNotification('ã‚·ãƒ£ãƒƒãƒ•ãƒ«: OFF', false, 1500);
        }
        updateShuffleStatus();
        updateAudioList();
        saveState();
    }
    
    function applyShuffle() {
        if (!isShuffle || playlists.length === 0) return;
        
        // ç¾åœ¨ã®ãƒˆãƒ©ãƒƒã‚¯ã‚’ã‚·ãƒ£ãƒƒãƒ•ãƒ«ãƒªã‚¹ãƒˆã®å…ˆé ­ã«å›ºå®š
        const currentTrackIndex = currentIndex;
        const allIndices = playlists.map((_, i) => i);
        const nonCurrentIndices = allIndices.filter(i => i !== currentTrackIndex);
        
        // Fisher-Yates shuffle
        for (let i = nonCurrentIndices.length - 1; i > 0; i--) {
            const j = Math.floor(Math.random() * (i + 1));
            [nonCurrentIndices[i], nonCurrentIndices[j]] = [nonCurrentIndices[j], nonCurrentIndices[i]];
        }
        
        // ã‚·ãƒ£ãƒƒãƒ•ãƒ«ãƒªã‚¹ãƒˆã‚’æ§‹ç¯‰: [ç¾åœ¨ã®æ›², ãƒ©ãƒ³ãƒ€ãƒ ãªæ®‹ã‚Šã®æ›²...]
        shuffleIndices = [currentTrackIndex, ...nonCurrentIndices];
        
        // ã‚·ãƒ£ãƒƒãƒ•ãƒ«å¾Œã®ãƒªã‚¹ãƒˆã§ã€ç¾åœ¨ã®æ›²ã®ã‚¤ãƒ³ãƒ‡ãƒƒã‚¯ã‚¹ã¯å¸¸ã« 0 ã«ãªã‚‹
        currentIndex = 0;
    }

    function updateShuffleStatus() {
        shuffleStatus.textContent = isShuffle ? 'ğŸ”€ ON' : 'ğŸ”€';
    }

    function updateCoverArt(src) {
        if (coverArt) {
            coverArt.src = src || 'placeholder.png';
        }
    }

    function updateVisualizerMode(enabled) {
        if (visualizerCanvas) {
            visualizerCanvas.style.display = enabled ? 'block' : 'none';
        }
    }

    function setMediaSession(track) {
        if ('mediaSession' in navigator && track) {
            navigator.mediaSession.metadata = new MediaMetadata({
                title: track.title,
                artist: track.artist,
                album: track.album || 'DmPlayer',
                artwork: [
                    { src: track.coverArt, sizes: '192x192', type: 'image/png' },
                ]
            });

            navigator.mediaSession.setActionHandler('play', togglePlayPause);
            navigator.mediaSession.setActionHandler('pause', togglePlayPause);
            navigator.mediaSession.setActionHandler('nexttrack', playNext);
            navigator.mediaSession.setActionHandler('previoustrack', playPrev);
            // ã‚·ãƒ¼ã‚¯æ“ä½œã‚‚è¿½åŠ å¯èƒ½ã ãŒã€çœç•¥
        }
    }

    // ----------------------------------------------------
    // ãƒ“ã‚¸ãƒ¥ã‚¢ãƒ©ã‚¤ã‚¶ãƒ¼æç”»
    // ----------------------------------------------------
    function drawVisualizer() {
        if (!isVisualizerEnabled || !audioCtx || !analyser) {
            if (rafId !== null) {
                cancelAnimationFrame(rafId);
                rafId = null;
            }
            return;
        }

        rafId = requestAnimationFrame(drawVisualizer);

        if (player.paused) return; // ä¸€æ™‚åœæ­¢ä¸­ã¯æç”»ã‚’åœæ­¢

        // ãƒ¬ãƒ™ãƒ«ãƒ¡ãƒ¼ã‚¿ãƒ¼æç”»
        const levelL = new Uint8Array(1);
        const levelR = new Uint8Array(1);

        if (channel0 && channel1) {
            channel0.getByteFrequencyData(levelL);
            channel1.getByteFrequencyData(levelR);
            
            // ãƒ”ãƒ¼ã‚¯ãƒ¬ãƒ™ãƒ«ã®æ›´æ–°ã¨æ¸›è¡°
            const maxLevelL = Math.max(...levelL);
            const maxLevelR = Math.max(...levelR);
            peakLevelL = Math.max(peakLevelL * peakDecayRate, maxLevelL);
            peakLevelR = Math.max(peakLevelR * peakDecayRate, maxLevelR);

            const levelMeterL = maxLevelL / 255 * 100;
            const levelMeterR = maxLevelR / 255 * 100;
            const peakMeterL = peakLevelL / 255 * 100;
            const peakMeterR = peakLevelR / 255 * 100;

            mixerBarL.style.height = `${levelMeterL}%`;
            mixerBarR.style.height = `${levelMeterR}%`;
            peakHoldL.style.bottom = `${peakMeterL}%`;
            peakHoldR.style.bottom = `${peakMeterR}%`;
        }

        // FFTãƒ‡ãƒ¼ã‚¿å–å¾— (ãƒ“ã‚¸ãƒ¥ã‚¢ãƒ©ã‚¤ã‚¶ãƒ¼ç”¨)
        analyser.getByteFrequencyData(dataArray);

        visualizerCtx.clearRect(0, 0, visualizerCanvas.width, visualizerCanvas.height);
        
        const barWidth = (visualizerCanvas.width / bufferLength) * 2.5;
        let barHeight;
        let x = 0;

        for (let i = 0; i < bufferLength; i++) {
            barHeight = dataArray[i]; 

            visualizerCtx.fillStyle = 'rgba(0, 230, 184, 0.7)'; // --accent-color
            visualizerCtx.fillRect(x, visualizerCanvas.height - barHeight / 2, barWidth, barHeight / 2);

            x += barWidth + 1;
        }
    }
    
    function updateVisualizerCanvasSize() {
        if (visualizerCanvas) {
            visualizerCanvas.width = visualizerCanvas.offsetWidth;
            visualizerCanvas.height = visualizerCanvas.offsetHeight;
        }
    }
    
    // ----------------------------------------------------
    // çŠ¶æ…‹ã®ä¿å­˜ã¨ãƒ­ãƒ¼ãƒ‰
    // ----------------------------------------------------
    function saveState() {
        localStorage.setItem(PLAYER_STATE_KEY, JSON.stringify({
            currentIndex: currentIndex, 
            isLoop: isLoop, 
            isShuffle: isShuffle, 
            volume: volumeSlider.value,
            crossfade: CROSSFADE_DURATION,
            visualizer: isVisualizerEnabled, 
            // ãƒ—ãƒ¬ã‚¤ãƒªã‚¹ãƒˆã®å¾©å…ƒã¯è¤‡é›‘ãªãŸã‚ã€ãƒ•ã‚¡ã‚¤ãƒ«ãƒ™ãƒ¼ã‚¹ã®ã‚¢ãƒ—ãƒªã§ã¯çœç•¥ã€‚
            // ãƒ—ãƒ¬ã‚¤ãƒ¤ãƒ¼ä½ç½®ã‚‚é€šå¸¸ã¯ä¿å­˜ã—ãªã„ã€‚
        }));
    }
    
    function loadState() {
        const s = JSON.parse(localStorage.getItem(PLAYER_STATE_KEY));
        if (s) {
            currentIndex = s.currentIndex || 0;
            isLoop = s.isLoop || 'off';
            isShuffle = s.isShuffle || false;
            
            if (s.volume) {
                volumeSlider.value = s.volume;
                updateVolume(s.volume);
            } else {
                updateVolume(volumeSlider.value); // ãƒ‡ãƒ•ã‚©ãƒ«ãƒˆãƒœãƒªãƒ¥ãƒ¼ãƒ ã‚’é©ç”¨
            }

            if (s.crossfade) {
                CROSSFADE_DURATION = s.crossfade;
                crossfadeDurationSlider.value = s.crossfade;
                crossfadeValueDisplay.textContent = s.crossfade.toFixed(1);
            }
            
            isVisualizerEnabled = s.visualizer || false; 
            
            // ãƒ—ãƒ¬ã‚¤ãƒªã‚¹ãƒˆã®å¾©å…ƒã¯ã€ãƒ¦ãƒ¼ã‚¶ãƒ¼ãŒå†åº¦ãƒ•ã‚¡ã‚¤ãƒ«ã‚’é¸æŠã™ã‚‹å¿…è¦ãŒã‚ã‚‹ãŸã‚ã‚¹ã‚­ãƒƒãƒ—
        } else {
            // çŠ¶æ…‹ãŒãªã„å ´åˆã‚‚ãƒ‡ãƒ•ã‚©ãƒ«ãƒˆã‚’é©ç”¨
            updateVolume(volumeSlider.value);
        }
    }

    // ----------------------------------------------------
    // DOMContentLoaded ã¨åˆæœŸåŒ–
    // ----------------------------------------------------
    document.addEventListener('DOMContentLoaded', () => {
        // DOMè¦ç´ ã®å–å¾—
        audioList = document.getElementById('audioList');
        player = document.getElementById('player');
        notificationContainer = document.getElementById('notificationContainer');
        settingsOverlay = document.getElementById('settingsOverlay');
        debugToggle = document.getElementById('debugToggle');
        nextTrackNotificationToggle = document.getElementById('nextTrackNotificationToggle');
        trackDetailsOverlay = document.getElementById('trackDetailsOverlay');
        currentTrackInfoDetails = document.getElementById('currentTrackInfoDetails');
        volumeSlider = document.getElementById('volumeSlider');
        volumePercentage = document.getElementById('volumePercentage');
        shuffleStatus = document.getElementById('shuffleStatus');
        loopStatus = document.getElementById('loopStatus');
        playPauseBtn = document.getElementById('playPauseBtn');
        seekBackwardBtn = document.getElementById('seekBackwardBtn');
        seekForwardBtn = document.getElementById('seekForwardBtn');
        playNextBtn = document.getElementById('playNextBtn');
        playPrevBtn = document.getElementById('playPrevBtn');
        coverArtContainer = document.querySelector('.cover-art-container');
        lyricsDisplay = document.getElementById('lyricsDisplay');
        crossfadeDurationSlider = document.getElementById('crossfadeDurationSlider');
        crossfadeValueDisplay = document.getElementById('crossfadeValue');
        metadataEditForm = document.getElementById('metadataEditForm');
        editTitleInput = document.getElementById('editTitle');
        editArtistInput = document.getElementById('editArtist');
        saveMetadataBtn = document.getElementById('saveMetadataBtn');
        toggleEditBtn = document.getElementById('toggleEditBtn');
        peakHoldL = document.getElementById('peakHoldL');
        peakHoldR = document.getElementById('peakHoldR');
        mixerBarL = document.getElementById('mixerBarL');
        mixerBarR = document.getElementById('mixerBarR');
        seekBar = document.getElementById('seekBar');
        currentTimeDisplay = document.getElementById('currentTime');
        durationDisplay = document.getElementById('duration');
        fileInput = document.getElementById('fileInput');
        trackTitle = document.getElementById('trackTitle');
        trackArtist = document.getElementById('trackArtist');
        coverArt = document.getElementById('coverArt');
        optionsBtn = document.getElementById('optionsBtn');
        settingsBtn = document.getElementById('settingsBtn');
        closeSettingsBtn = document.getElementById('closeSettingsBtn');
        helpBtn = document.getElementById('helpBtn');
        closeDetailsBtn = document.getElementById('closeDetailsBtn');
        visualizerCanvas = document.getElementById('visualizerCanvas'); 
        visualizerToggle = document.getElementById('visualizerToggle');
        
        // AudioContextã®åˆæœŸåŒ–
        initializeAudioContext();
        if (visualizerCanvas) {
            visualizerCtx = visualizerCanvas.getContext('2d');
            updateVisualizerCanvasSize();
            window.addEventListener('resize', updateVisualizerCanvasSize);
        }

        // åˆæœŸåŒ–å‡¦ç†
        initDB().finally(() => {
            loadState();
            updateLoopStatus();
            updateShuffleStatus();
            updateVisualizerMode(isVisualizerEnabled);
            visualizerToggle.checked = isVisualizerEnabled;
            nextTrackNotificationToggle.checked = nextTrackNotificationEnabled;
            debugToggle.checked = isDebugging;

            // åˆæœŸã‚­ãƒ¥ãƒ¼è¡¨ç¤º (ç©ºã®çŠ¶æ…‹ã‚’åæ˜ )
            updateAudioList(); 
        });


        // â­ã€é‡è¦ã€‘ãƒ•ã‚¡ã‚¤ãƒ«é¸æŠã‚¤ãƒ™ãƒ³ãƒˆãƒªã‚¹ãƒŠãƒ¼
        if (fileInput) {
            fileInput.addEventListener('change', handleFileSelect);
        }

        // ãƒ—ãƒ¬ã‚¤ãƒ¤ãƒ¼ã‚¤ãƒ™ãƒ³ãƒˆ
        player.addEventListener('timeupdate', onTimeUpdate);
        player.addEventListener('durationchange', () => {
            if (!isNaN(player.duration)) {
                durationDisplay.textContent = formatTime(player.duration);
            }
        });
        player.addEventListener('loadedmetadata', () => onLoadedMetadata(playlists[currentIndex]));
        player.addEventListener('ended', playNext);
        player.addEventListener('error', handleAudioError);
        player.addEventListener('play', () => { 
            playPauseBtn.textContent = 'â¸ï¸'; 
            nextTrackNotificationSent = false;
            if (isVisualizerEnabled && rafId === null) drawVisualizer();
            updateAudioList();
        });
        player.addEventListener('pause', () => { 
            playPauseBtn.textContent = 'â–¶ï¸'; 
            if (rafId !== null) {
                cancelAnimationFrame(rafId);
                rafId = null;
            }
            updateAudioList();
        });

        // åˆ¶å¾¡ãƒœã‚¿ãƒ³
        playPauseBtn.addEventListener('click', () => {
            handleUserAction(togglePlayPause);
        });
        playPrevBtn.addEventListener('click', () => handleUserAction(playPrev));
        playNextBtn.addEventListener('click', () => handleUserAction(playNext));
        
        seekBackwardBtn.addEventListener('click', () => {
            handleUserAction(() => { seekAudio(player.currentTime - 10); });
        });
        seekForwardBtn.addEventListener('click', () => {
            handleUserAction(() => { seekAudio(player.currentTime + 10); });
        });

        // ã‚·ãƒ¼ã‚¯ãƒãƒ¼æ“ä½œ
        seekBar.addEventListener('input', () => {
            isSeeking = true;
            const seekTime = player.duration * (seekBar.value / 100);
            currentTimeDisplay.textContent = formatTime(seekTime);
        });
        seekBar.addEventListener('change', () => {
            isSeeking = false;
            const seekTime = player.duration * (seekBar.value / 100);
            handleUserAction(() => { seekAudio(seekTime); });
        });

        // ãƒœãƒªãƒ¥ãƒ¼ãƒ æ“ä½œ
        volumeSlider.addEventListener('input', (e) => updateVolume(e.target.value));
        volumePercentage.addEventListener('click', () => {
            const currentVolume = parseFloat(volumeSlider.value);
            const newVolume = currentVolume === 100 ? 0 : 100;
            volumeSlider.value = newVolume;
            updateVolume(newVolume);
            saveState();
        });

        document.getElementById('loopBtn').addEventListener('click', toggleLoop);
        document.getElementById('shuffleBtn').addEventListener('click', toggleShuffle);
        
        coverArtContainer.addEventListener('click', () => coverArtContainer.classList.toggle('flipped')); // toggleFlipã®ä»£æ›¿

        // è¨­å®šã¨è©³ç´°ã‚ªãƒ¼ãƒãƒ¼ãƒ¬ã‚¤
        // ... (çœç•¥) ...
        
        // è¨­å®šãƒˆã‚°ãƒ«
        visualizerToggle.addEventListener('change', (e) => {
            isVisualizerEnabled = e.target.checked;
            updateVisualizerMode(isVisualizerEnabled);
            saveState();
            if (isVisualizerEnabled && !player.paused) {
                if (rafId === null) drawVisualizer();
            } else if (!isVisualizerEnabled) {
                if (rafId !== null) {
                    cancelAnimationFrame(rafId);
                    rafId = null;
                }
            }
        });
        nextTrackNotificationToggle.addEventListener('change', (e) => {
            nextTrackNotificationEnabled = e.target.checked;
            saveState();
        });
        debugToggle.addEventListener('change', (e) => {
            isDebugging = e.target.checked;
            showNotification(`ãƒ‡ãƒãƒƒã‚°ãƒ¢ãƒ¼ãƒ‰: ${isDebugging ? 'ON' : 'OFF'}`, isDebugging, 2000, isDebugging);
            saveState();
        });
        
        crossfadeDurationSlider.addEventListener('input', (e) => {
            CROSSFADE_DURATION = parseFloat(e.target.value);
            crossfadeValueDisplay.textContent = CROSSFADE_DURATION.toFixed(1);
        });
        crossfadeDurationSlider.addEventListener('change', () => saveState());

        // ãƒ¡ã‚¿ãƒ‡ãƒ¼ã‚¿ç·¨é›† (çœç•¥)

        // ã‚­ãƒ¼ãƒœãƒ¼ãƒ‰ã‚·ãƒ§ãƒ¼ãƒˆã‚«ãƒƒãƒˆ (çœç•¥)
    });

    function onTimeUpdate() {
        if (!isSeeking && !isNaN(player.duration)) {
            const progress = (player.currentTime / player.duration) * 100;
            seekBar.value = progress;
            seekBar.style.setProperty('--progress', `${progress}%`);
            currentTimeDisplay.textContent = formatTime(player.currentTime);

            // æ¬¡ã®æ›²ã®é€šçŸ¥ãƒ­ã‚¸ãƒƒã‚¯ (æ®‹ã‚Š15ç§’)
            if (nextTrackNotificationEnabled && !nextTrackNotificationSent && player.duration > 30 && player.duration - player.currentTime <= 15) {
                const nextTrackIndex = getNextTrackIndex(currentIndex);
                if (nextTrackIndex !== -1 && nextTrackIndex !== currentIndex) {
                    showNotification(`æ¬¡ã®æ›²: ${playlists[nextTrackIndex].title}`, false, 4000);
                }
                nextTrackNotificationSent = true;
            }
        }
    }
</script>
</body>
</html>
