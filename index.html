<!DOCTYPE html>
<html lang="ja">
<head>
  <meta charset="UTF-8">
  <meta name="viewport" content="width=device-width, initial-scale=1.0, user-scalable=no, maximum-scale=1.0, viewport-fit=cover">
  <title>DmPlayer v2.0.16</title> <meta name="apple-mobile-web-app-capable" content="yes">
  <meta name="apple-mobile-web-app-status-bar-style" content="black-translucent">
  <meta name="apple-mobile-web-app-title" content="DmPlayer">
  
  <link rel="manifest" href="./manifest.json">

  <script src="https://cdn.jsdelivr.net/npm/jsmediatags@3.9.7/dist/jsmediatags.min.js"></script>

  <style>
    /* -------------------- */
    /* ã‚¹ã‚¿ã‚¤ãƒ«ã‚·ãƒ¼ãƒˆ */
    /* -------------------- */
    * { box-sizing: border-box; }
    :root {
      --dark-bg: #121212;
      --medium-bg: #181818;
      --accent-color: #00e6b8;
      --text-color: #ffffff;
      --text-light: #b3b3b3;
      --border-color: #333333;
      --error-color: #e6005c; 
      --debug-color: #00b300; 
      --switch-off: #4a4a4a;
      --switch-on: var(--accent-color);
      --peak-hold-color: #ffcc00;
    }

    body {
      margin: 0;
      background-color: var(--dark-bg); 
      font-family: 'Segoe UI', Roboto, Helvetica, Arial, sans-serif;
      color: var(--text-color);
      height: 100vh;
      min-height: -webkit-fill-available;
      overflow: hidden; 
      display: flex; 
    }
    
    .sidebar {
      width: 250px; 
      flex-shrink: 0; 
      background-color: var(--medium-bg);
      border-right: 1px solid var(--border-color);
      overflow: hidden;
      display: flex;
      flex-direction: column;
      padding: 0;
      position: relative; 
      height: 100%; 
    }
    
    .sidebar-content {
        flex-grow: 1;
        overflow-y: auto;
        padding: 15px 15px 5px 15px;
    }

    .sidebar h2 {
      font-size: 1.1em;
      margin-bottom: 10px;
      color: var(--text-light);
    }
    
    .sidebar-footer {
        padding: 10px 15px 15px 15px;
        background-color: #242424; 
        border-top: 1px solid #444444; 
        flex-shrink: 0; 
    }

    .app-info {
        font-size: 0.9em;
        color: var(--text-light);
        margin-bottom: 10px;
        display: flex;
        justify-content: space-between;
    }

    #appName {
        font-weight: bold;
        color: var(--text-color);
    }

    #appVersion {
        font-size: 0.8em;
        color: #999999;
        padding-top: 1px;
    }

    .footer-btn {
        width: 100%;
        padding: 8px;
        margin-top: 5px;
        background-color: #383838;
        color: white;
        border: none;
        border-radius: 4px;
        cursor: pointer;
        transition: background-color 0.2s;
        font-size: 0.9em;
        text-align: center;
        -webkit-tap-highlight-color: transparent;
    }

    .footer-btn:hover {
        background-color: #4a4a4a;
    }
    
    .input-group {
        margin-bottom: 15px;
    }
    .input-group label {
        display: block;
        font-size: 0.9em;
        color: var(--text-light);
        margin-bottom: 5px;
    }
    .input-group input[type="text"] {
        width: 100%;
        padding: 8px;
        background-color: #383838;
        border: 1px solid #555555;
        color: var(--text-color);
        border-radius: 4px;
        font-size: 1em;
    }

    .main {
      flex: 1; 
      display: flex;
      flex-direction: column;
      overflow: hidden;
      position: relative; 
      height: 100%; 
    }
    
    #fileInput { display: none; }
    
    .file-label {
        display: block;
        width: 100%;
        padding: 10px 15px;
        background-color: var(--accent-color); 
        color: var(--dark-bg);
        border-radius: 6px;
        font-weight: bold;
        text-align: center;
        cursor: pointer;
        transition: background-color 0.2s, box-shadow 0.2s;
        font-size: 1em;
        box-shadow: 0 4px 10px rgba(0, 230, 184, 0.3);
        margin-bottom: 15px; 
        margin-top: 5px; 
    }
    
    .file-label:hover {
        background-color: #00b38c;
        box-shadow: 0 6px 12px rgba(0, 230, 184, 0.4);
    }
    
    .switch-container {
        display: flex;
        align-items: center;
        justify-content: space-between;
        margin-bottom: 15px;
        padding: 5px 0;
        font-size: 0.95em;
    }

    .switch {
        position: relative;
        display: inline-block;
        width: 45px;
        height: 25px;
    }

    .switch input { opacity: 0; width: 0; height: 0; }

    .slider {
        position: absolute; cursor: pointer; top: 0; left: 0; right: 0; bottom: 0;
        background-color: var(--switch-off); transition: .4s; border-radius: 25px;
    }

    .slider:before {
        position: absolute; content: ""; height: 17px; width: 17px; left: 4px; bottom: 4px;
        background-color: white; transition: .4s; border-radius: 50%;
    }

    input:checked + .slider { background-color: var(--switch-on); }
    input:checked + .slider:before { transform: translateX(20px); }

    .audio-list {
        display: flex; flex-direction: column; gap: 5px; padding-top: 5px;
    }

    .queue-item {
        display: flex; align-items: center; width: 100%; padding: 8px 10px;
        background-color: #242424; color: var(--text-color); border: 1px solid #3a3a3a;
        border-radius: 6px; cursor: pointer; transition: background-color 0.2s, border-color 0.2s, box-shadow 0.2s;
        text-align: left; font-size: 0.9em; position: relative; overflow: hidden;
        -webkit-tap-highlight-color: transparent;
    }

    .queue-item:hover { background-color: #303030; }

    .queue-item.active-track {
        border: 1px solid var(--accent-color); border-left: 4px solid var(--accent-color); 
        background-color: #1a1a1a; box-shadow: 0 0 8px rgba(0, 230, 184, 0.3); 
        padding-left: 10px; 
    }
    
    .queue-item.placeholder-track { opacity: 0.6; font-style: italic; }
    
    .queue-index {
        font-size: 1.1em; font-weight: bold; color: var(--text-light);
        width: 25px; flex-shrink: 0; margin-right: 8px; text-align: center;
    }
    
    .track-info-container {
        flex-grow: 1; min-width: 0; display: flex; flex-direction: column;
    }

    .track-title-display {
        font-weight: bold; color: var(--text-color); white-space: nowrap;
        overflow: hidden; text-overflow: ellipsis; 
    }

    .track-artist-display {
        font-size: 0.8em; color: var(--text-light); white-space: nowrap;
        overflow: hidden; text-overflow: ellipsis; 
    }
    
    .queue-controls {
        flex-shrink: 0; margin-left: 8px; display: flex; align-items: center; gap: 3px; 
    }

    .queue-control-btn {
        background: #3a3a3a; color: white; border: none; padding: 4px;
        border-radius: 3px; cursor: pointer; font-size: 0.65em; line-height: 1;
        height: 20px; width: 20px; display: flex; align-items: center;
        justify-content: center; transition: background-color 0.1s, transform 0.1s;
    }
    
    .queue-control-btn:disabled {
        opacity: 0.4;
        cursor: default;
        transform: none;
        background: #3a3a3a;
        color: white;
    }

    .queue-control-btn:hover:not(:disabled) {
        background: var(--accent-color); color: var(--dark-bg); transform: scale(1.1);
    }
    
    .playing-status {
        font-size: 1.2em; color: var(--accent-color); width: 20px; text-align: center; line-height: 1;
    }
    .playing-status.ready-to-play { color: var(--error-color); }
    
    .screen {
      flex: 1; 
      padding: 30px;
      padding-top: 50px; 
      background: linear-gradient(135deg, var(--medium-bg), var(--dark-bg));
      display: flex;
      flex-direction: column;
      justify-content: center;
      align-items: center;
      overflow-y: auto; 
      position: relative; 
      perspective: 1000px; 
      z-index: 1; 
    }

    #visualizerCanvas {
        position: absolute;
        top: 0;
        left: 0;
        width: 100%;
        height: 100%;
        z-index: 0; 
        opacity: 0.6; 
        pointer-events: none; 
    }

    .cover-art-container {
      width: 250px; 
      height: 250px;
      margin-bottom: 25px;
      text-align: center;
      position: relative;
      transform-style: preserve-3d; 
      transition: transform 0.6s; 
      cursor: pointer; 
    }
    
    .cover-art-face {
        position: absolute; width: 100%; height: 100%;
        backface-visibility: hidden; border-radius: 12px;
        box-shadow: 0 15px 30px rgba(0, 0, 0, 0.5), 0 0 0 5px var(--medium-bg);
        overflow: hidden; background-color: var(--medium-bg); padding: 0;
    }

    .cover-art-front { z-index: 2; transform: rotateY(0deg); }

    #coverArt {
      width: 100%; height: 100%; object-fit: cover; border-radius: 12px;
    }
    
    .cover-art-back {
        transform: rotateY(180deg); z-index: 1; display: flex;
        justify-content: center; align-items: flex-start;
        background-color: #1c1c1c; border: 3px solid var(--accent-color); 
    }

    .cover-art-container.flipped { transform: rotateY(180deg); }

    #lyricsDisplay {
        padding: 15px; color: var(--text-light); font-size: 0.85em;
        text-align: center; overflow-y: auto; white-space: pre-wrap;
        max-height: 100%; width: 100%; line-height: 1.4;
    }

    #trackTitle {
      font-size: 2em; font-weight: bold; margin-top: 10px;
    }

    #trackArtist {
        font-size: 1.2em; color: var(--text-light); margin-bottom: 10px; 
    }
    
    .mode-status-display {
        display: flex; gap: 20px; margin-bottom: 30px; font-size: 1.0em; font-weight: 500;
    }

    .mode-item {
        display: flex; align-items: center; gap: 8px; padding: 5px 10px;
        border-radius: 4px; background-color: var(--medium-bg);
        color: var(--text-light); border: 1px solid var(--border-color);
        transition: all 0.2s;
    }

    .mode-item.active {
        background-color: var(--accent-color); color: var(--dark-bg);
        border-color: var(--accent-color); font-weight: bold;
        box-shadow: 0 4px 8px rgba(0, 230, 184, 0.2);
    }

    .mode-icon { font-size: 1.2em; line-height: 1; }

    .seek-container {
      width: 90%; max-width: 600px; margin-top: 30px; display: flex; align-items: center;
    }

    #seekBar {
      flex-grow: 1; margin: 0 15px; -webkit-appearance: none; appearance: none; 
      height: 8px; background: transparent; border-radius: 4px;
      cursor: pointer; transition: background 0.3s;
      --progress: 0%; 
    }

    #seekBar::-webkit-slider-runnable-track {
      width: 100%; height: 8px; cursor: pointer; border-radius: 4px;
      background: linear-gradient(to right, 
        var(--accent-color) 0%, var(--accent-color) var(--progress), 
        var(--border-color) var(--progress), var(--border-color) 100%
      );
    }
    
    #seekBar::-webkit-slider-thumb { -webkit-appearance: none; appearance: none; width: 1px; height: 1px; opacity: 0; border-radius: 50%; background: var(--accent-color); cursor: pointer; margin-top: -4px; }
    #volumeSlider::-webkit-slider-thumb { -webkit-appearance: none; appearance: none; width: 16px; height: 16px; border-radius: 50%; background: var(--accent-color); cursor: pointer; box-shadow: 0 0 5px var(--accent-color); }
    
    .time-display { font-size: 0.9em; width: 45px; text-align: center; color: var(--text-light); }

    .controls-moved {
        display: flex; align-items: center; justify-content: center;
        gap: 15px; margin-top: 20px; 
    }

    .controls-moved button {
        width: 45px; height: 45px; line-height: 45px; padding: 0;
        margin: 5px 0; background-color: var(--accent-color); border: none;
        font-size: 1.2em; color: var(--dark-bg); border-radius: 50%; 
        cursor: pointer; transition: transform 0.1s, background-color 0.2s, box-shadow 0.2s;
        font-weight: bold; -webkit-tap-highlight-color: transparent;
        display: flex; align-items: center; justify-content: center;
    }
    
    .controls-moved button:hover {
        background-color: #00b38c; transform: scale(1.1);
    }
    
    #playPauseBtn { width: 55px; height: 55px; font-size: 1.6em; }
    
    #seekBackwardBtn, #seekForwardBtn {
        background-color: var(--accent-color); color: var(--dark-bg); 
        font-size: 1.4em; width: 45px; height: 45px; border-radius: 50%;
        line-height: 1; font-weight: 900; padding-bottom: 2px; 
    }

    #seekBackwardBtn:hover, #seekForwardBtn:hover {
        background-color: #00b38c; transform: scale(1.1);
    }

    .player-ready #playPauseBtn {
        box-shadow: 0 0 0 4px var(--accent-color), 0 0 20px var(--accent-color);
        background-color: var(--accent-color); color: var(--dark-bg); 
    }

    #optionsBtn {
        position: absolute; top: 15px; left: 15px; background: none; 
        border: none; font-size: 1.8em; color: var(--text-color); 
        cursor: pointer; z-index: 50; padding: 5px 10px; 
        -webkit-tap-highlight-color: transparent; line-height: 1;
        transition: color 0.2s;
    }
    #optionsBtn:hover { color: var(--accent-color); }

    .control-panel {
      flex-shrink: 0; display: flex; background-color: var(--medium-bg);
      padding: 15px; flex-wrap: wrap; border-top: 1px solid var(--border-color);
      height: 180px; gap: 20px; justify-content: space-between;
    }
    
    .modes { flex: 1; padding: 0; min-width: 200px; }
    
    .volume-container {
        display: flex; align-items: center; gap: 8px; 
        padding-bottom: 5px; margin-top: 15px;
    }

    #volumeSlider {
        flex-grow: 1; margin: 0; -webkit-appearance: none; appearance: none; 
        height: 8px; background: #555; border-radius: 4px; cursor: pointer;
    }

    .section-title {
      font-size: 0.9em; margin-bottom: 5px; color: var(--text-light);
      border-bottom: 1px solid var(--border-color); padding-bottom: 5px;
    }
    
    .mixer-container {
        display: flex; align-items: center; gap: 10px; padding: 2px 0; 
        position: relative; 
    }

    .channel-label {
        font-size: 0.8em; color: var(--text-light); width: 15px; text-align: center;
    }

    .mixer-bar {
        flex-grow: 1; height: 8px; background-color: #3a3a3a; 
        border-radius: 6px; overflow: hidden; position: relative;
    }

    .mixer-bar-fill {
        height: 100%; width: 0%; transition: width 0.05s linear; 
        background-color: #008000; 
    }
    
    .peak-hold-indicator {
        position: absolute; top: 0; right: 0; width: 4px; height: 100%;
        background-color: var(--peak-hold-color); transition: transform 0.5s ease-out; 
        z-index: 10; border-radius: 2px;
    }
    
    .mode-buttons {
        display: flex; gap: 10px; margin-top: 10px;
    }
    .mode-buttons button {
        flex: 1; padding: 8px; background-color: #383838;
        color: white; border: none; border-radius: 4px;
        cursor: pointer; transition: background-color 0.2s;
        font-size: 0.9em;
    }
    .mode-buttons button:hover { background-color: #4a4a4a; }
    
    #notificationContainer {
        position: absolute; top: 15px; right: 15px; z-index: 1000;
        pointer-events: none; max-width: 300px; overflow: hidden;
    }
    
    .notification-message {
        background-color: #333; color: white; padding: 10px 15px;
        border-radius: 8px; margin-bottom: 10px; box-shadow: 0 4px 12px rgba(0, 0, 0, 0.5);
        opacity: 0; transform: translateX(100%); 
        transition: opacity 0.3s ease-out, transform 0.4s cubic-bezier(0.25, 0.46, 0.45, 0.94);
        pointer-events: all; font-size: 0.9em;
        border-left: 4px solid var(--accent-color); white-space: pre-wrap;
    }

    .notification-message.show { opacity: 1; transform: translateX(0); }
    .notification-message.slide-out { opacity: 0; transform: translateX(100%); }
    .notification-message.error { background-color: #4a1d2e; border-left-color: var(--error-color); }
    .notification-message.debug { background-color: #1b4d24; border-left-color: var(--debug-color); font-size: 0.8em; opacity: 0.7; }

    .settings-overlay {
        position: absolute; top: 0; left: 0; width: 100%; height: 100%;
        background-color: var(--medium-bg); z-index: 10; padding: 15px;
        display: flex; flex-direction: column;
        transform: translateX(-100%); transition: transform 0.3s cubic-bezier(0.4, 0, 0.2, 1);
    }

    .settings-overlay.show { transform: translateX(0); }
    
    .settings-content { flex-grow: 1; overflow-y: auto; }
    
    .settings-footer {
        padding-top: 15px; border-top: 1px solid var(--border-color); margin-top: auto;
    }
    
    .slider-container { margin-bottom: 20px; padding: 5px 0; }
    .slider-container label {
        display: block; font-size: 0.95em; margin-bottom: 5px; color: var(--text-light);
    }
    .slider-container input[type="range"] {
        width: 100%; -webkit-appearance: none; appearance: none; height: 8px;
        background: #555; border-radius: 4px; cursor: pointer;
    }
    .slider-value {
        font-size: 0.85em; color: var(--accent-color); display: block;
        text-align: right; margin-top: 5px;
    }

    .track-details-overlay {
        position: absolute; top: 0; right: 0; width: 300px; height: 100%;
        background-color: #242424; z-index: 200; padding: 20px;
        display: flex; flex-direction: column;
        transform: translateX(100%); transition: transform 0.3s cubic-bezier(0.4, 0, 0.2, 1);
        border-left: 1px solid #444444;
    }
    
    .track-details-overlay.show { transform: translateX(0); }

    .details-content {
        flex-grow: 1; overflow-y: auto; padding-top: 10px;
        font-size: 0.9em; color: var(--text-light);
    }
    
    .details-content strong {
        color: var(--text-color); font-weight: bold; display: block; padding-top: 5px;
    }

    .details-actions { display: flex; gap: 10px; padding: 10px 0; }
    .details-actions button {
        flex: 1; padding: 8px; background-color: #3a3a3a; color: white;
        border: none; border-radius: 4px; cursor: pointer; transition: background-color 0.2s;
    }
    .details-actions button:hover { background-color: #4a4a4a; }

    .close-details-btn {
        margin-top: auto; padding: 10px; background-color: var(--accent-color);
        color: var(--dark-bg); border: none; border-radius: 4px;
        cursor: pointer; font-weight: bold; transition: background-color 0.2s;
    }
    .close-details-btn:hover { background-color: #00b38c; }
    
    #metadataEditForm {
        padding: 10px; border: 1px dashed var(--border-color);
        border-radius: 8px; margin-top: 15px; display: none;
    }
    #metadataEditForm.show { display: block; }

    #player { display: none; }
    
    /* â­ ãƒ“ã‚¸ãƒ¥ã‚¢ãƒ©ã‚¤ã‚¶ãƒ¼ãƒ¢ãƒ¼ãƒ‰ (v2.0.16) â­ */
    body.visualizer-mode {
        display: block; 
    }
    
    /* ã‚µã‚¤ãƒ‰ãƒãƒ¼ï¼ˆã‚­ãƒ¥ãƒ¼ï¼‰ã¯è¡¨ç¤ºã™ã‚‹ã€‚ãƒ¦ãƒ¼ã‚¶ãƒ¼ã¯ã‚­ãƒ¥ãƒ¼ã‚’è¦‹ãŸã„ã¨ã®è¦æœ›ãŒã‚ã‚‹ãŸã‚å¸¸ã«è¡¨ç¤º */
    body.visualizer-mode .sidebar {
        display: block !important;
        z-index: 3;
    }

    /* ãƒ¡ã‚¤ãƒ³é ˜åŸŸã¯ã‚µã‚¤ãƒ‰ãƒãƒ¼åˆ†ã‚’æ®‹ã—ã¦è¡¨ç¤º */
    body.visualizer-mode .main {
        width: calc(100% - 250px);
        height: 100vh;
        flex: 1;
    }
    
    /* control-panel ã¯è¡¨ç¤ºã—ã¦ãŠãï¼ˆãƒœãƒªãƒ¥ãƒ¼ãƒ /ã‚·ãƒ£ãƒƒãƒ•ãƒ«ç­‰ã‚’æ®‹ã™ï¼‰ */
    body.visualizer-mode .control-panel {
        display: flex !important;
        z-index: 2;
    }
    
    body.visualizer-mode .screen {
        padding: 0; 
    }
    
    /* ãƒ“ã‚¸ãƒ¥ã‚¢ãƒ©ã‚¤ã‚¶ãƒ¼ãƒ¢ãƒ¼ãƒ‰ã§ã¯ã€Œãƒœã‚¿ãƒ³é¡ã®ã¿ã€ã‚’éè¡¨ç¤ºã«ã—ã¦
       ã‚¢ãƒ«ãƒãƒ ã‚«ãƒãƒ¼ã‚„ã‚·ãƒ¼ã‚¯ãƒãƒ¼ã€ã‚¿ã‚¤ãƒˆãƒ«é¡ã¯è¡¨ç¤ºã—ãŸã¾ã¾ã«ã™ã‚‹ã€‚
       canvas ã¯èƒŒæ™¯ã¨ã—ã¦è¡¨ç¤ºã•ã‚Œã€UI ã¯ãã®ä¸Šã«é‡ãªã‚‹ã€‚ */
    /* éè¡¨ç¤º: ãƒ“ã‚¸ãƒ¥ã‚¢ãƒ©ã‚¤ã‚¶ãƒ¼è¡¨ç¤ºæ™‚ã¯ã‚¢ãƒ«ãƒãƒ ã‚«ãƒãƒ¼ï¼ã‚¿ã‚¤ãƒˆãƒ«ï¼ã‚·ãƒ¼ã‚¯ãƒãƒ¼ã‚’éš ã™ */
    body.visualizer-mode .cover-art-container,
    body.visualizer-mode #trackTitle,
    body.visualizer-mode #trackArtist,
    body.visualizer-mode .seek-container,
    body.visualizer-mode .cover-art-face {
        display: none !important;
    }

    /* éè¡¨ç¤º: ç”»é¢ä¸Šã®å†ç”Ÿ/å‰å¾Œãªã©ã®å¤§ããªã‚³ãƒ³ãƒˆãƒ­ãƒ¼ãƒ«ã¯éš ã™ï¼ˆæ“ä½œã¯ control-panel ã§å¯èƒ½ï¼‰ */
    body.visualizer-mode .controls-moved,
    body.visualizer-mode #optionsBtn {
        display: none !important;
    }
    
    /* éšœå®³ã«ãªã‚‹æµ®éŠè¡¨ç¤ºï¼ˆãƒ«ãƒ¼ãƒ—/ã‚·ãƒ£ãƒƒãƒ•ãƒ«ã®ã‚¹ãƒ†ãƒ¼ã‚¿ã‚¹ï¼‰ã‚’éè¡¨ç¤ºã«ã™ã‚‹ */
    body.visualizer-mode #loopStatus,
    body.visualizer-mode #shuffleStatus {
        display: none !important;
    }
    
    /* ã‚­ãƒ£ãƒ³ãƒã‚¹ã¨é€šçŸ¥ã€ã‚ªãƒ¼ãƒãƒ¼ãƒ¬ã‚¤ã¯è¡¨ç¤ºã‚’ç¶­æŒ */
    body.visualizer-mode #visualizerCanvas {
        display: block !important; 
        opacity: 1.0; 
        z-index: 0 !important;
        pointer-events: none !important;
    }

    body.visualizer-mode #notificationContainer {
        display: block !important;
        pointer-events: none;
    }

    /* è¨­å®šã‚„è©³ç´°ã‚ªãƒ¼ãƒãƒ¼ãƒ¬ã‚¤ã¯è¡¨ç¤ºã‚’ç¶­æŒ */
    body.visualizer-mode .settings-overlay.show,
    body.visualizer-mode .track-details-overlay.show {
        display: flex !important; 
        z-index: 100;
    }

    /* -------------------- */
    /* ğŸš¨ ã‚µã‚¤ãƒ‰ãƒãƒ¼æ¨ªã®ä¸è¦ãªé»’ã„ãƒãƒ¼ã®ä¿®æ­£ (ãƒ¦ãƒ¼ã‚¶ãƒ¼è¦æœ›) */
    /* .sidebar ã«è¨­å®šã•ã‚Œã¦ã„ã‚‹ border-right ã‚’ç„¡åŠ¹åŒ–ã—ã¾ã™ã€‚ */
    /* -------------------- */
    .sidebar {
      border-right: none !important; 
    }

  </style>
</head>
<body>

  <div class="sidebar">
    
    <div id="settingsOverlay" class="settings-overlay">
        <h2>âš™ï¸ è¨­å®šãƒ¡ãƒ‹ãƒ¥ãƒ¼</h2>
        <div class="settings-content">
            
            <div class="switch-container">
                <label for="visualizerToggle">ã‚ªãƒ¼ãƒ‡ã‚£ã‚ªãƒ“ã‚¸ãƒ¥ã‚¢ãƒ©ã‚¤ã‚¶ãƒ¼</label>
                <label class="switch">
                    <input type="checkbox" id="visualizerToggle">
                    <span class="slider"></span>
                </label>
            </div>
            
            <div class="switch-container">
                <label for="nextTrackNotificationToggle">æ¬¡ã®æ›²ã‚’é€šçŸ¥</label>
                <label class="switch">
                    <input type="checkbox" id="nextTrackNotificationToggle" checked>
                    <span class="slider"></span>
                </label>
            </div>
            <div class="switch-container">
                <label for="debugToggle">ãƒ‡ãƒãƒƒã‚°è¡¨ç¤º</label>
                <label class="switch">
                    <input type="checkbox" id="debugToggle">
                    <span class="slider"></span>
                </label>
            </div>
            
            <div class="slider-container">
                <label for="crossfadeDurationSlider">ã‚¯ãƒ­ã‚¹ãƒ•ã‚§ãƒ¼ãƒ‰æ™‚é–“ (<span id="crossfadeValue">1.5</span>ç§’)</label>
                <input type="range" id="crossfadeDurationSlider" min="0.0" max="5.0" step="0.1" value="1.5">
                <span class="slider-value">æ›²ã®åˆ‡ã‚Šæ›¿ãˆã‚’æ»‘ã‚‰ã‹ã«ã—ã¾ã™ã€‚</span>
            </div>
            
        </div>
        <div class="settings-footer">
            <button id="closeSettingsBtn" class="footer-btn">é–‰ã˜ã‚‹</button>
        </div>
    </div>
    
    <div class="sidebar-content">
      <h2>ã‚­ãƒ¥ãƒ¼ã«è¿½åŠ </h2>
      <input type="file" id="fileInput" accept="audio/mp3, audio/m4a, audio/flac, audio/ogg, audio/wav, audio/mp4" multiple />
      <label for="fileInput" class="file-label">ğŸ“‚ ãƒ•ã‚¡ã‚¤ãƒ«ã‚’é¸æŠ</label>
      
      <h2>ã‚­ãƒ¥ãƒ¼</h2>
      <div class="audio-list" id="audioList"></div>
    </div>

    <div class="sidebar-footer">
        <div class="app-info">
          <div id="appName">DmPlayer</div>
          <div id="appVersion">v2.0.16</div> </div>
        <button id="settingsBtn" class="footer-btn">âš™ï¸ è¨­å®š</button>
        <button id="helpBtn" class="footer-btn">ğŸ’¡ ãƒ˜ãƒ«ãƒ—</button>
    </div>
  </div>

  <div class="main">
    
    <div id="notificationContainer"></div>
    <div id="trackDetailsOverlay" class="track-details-overlay">
        <h2>â„¹ï¸ ãƒˆãƒ©ãƒƒã‚¯è©³ç´°</h2>
        <div id="currentTrackInfoDetails" class="details-content">
            è©³ç´°ã‚’èª­ã¿è¾¼ã¿ä¸­...
            <div id="metadataEditForm">
                <div class="input-group">
                    <label for="editTitle">ã‚¿ã‚¤ãƒˆãƒ«</label>
                    <input type="text" id="editTitle">
                </div>
                <div class="input-group">
                    <label for="editArtist">ã‚¢ãƒ¼ãƒ†ã‚£ã‚¹ãƒˆ</label>
                    <input type="text" id="editArtist">
                </div>
                <button class="footer-btn" id="saveMetadataBtn">ã‚¿ã‚°ã‚’ä¿å­˜ã—ã¦é©ç”¨</button>
            </div>
        </div>
        
        <div class="details-actions">
            <button id="toggleEditBtn">ã‚¿ã‚°ã‚’ç·¨é›†</button>
        </div>
        <button id="closeDetailsBtn" class="close-details-btn">é–‰ã˜ã‚‹</button>
    </div>
    
    <div class="screen" id="playerScreen">
      
      <canvas id="visualizerCanvas"></canvas> 

      <button id="optionsBtn" title="ãƒˆãƒ©ãƒƒã‚¯è©³ç´°">â‹®</button>
      
      <div class="cover-art-container" title="ã‚¯ãƒªãƒƒã‚¯ã§æ­Œè©ã‚’è¡¨ç¤º">
          <div class="cover-art-face cover-art-front">
              <img id="coverArt" src="data:image/svg+xml;utf8,<svg xmlns='http://www.w3.org/2000/svg' width='250' height='250'><rect width='100%' height='100%' fill='%23333'/><text x='50%' y='50%' dominant-baseline='middle' text-anchor='middle' font-family='Arial' font-size='30' fill='%23ccc'>NO ART</text></svg>" alt="ã‚¢ãƒ«ãƒãƒ ã‚«ãƒãƒ¼" />
          </div>
          <div class="cover-art-face cover-art-back">
              <div id="lyricsDisplay">
                  æ­Œè©ã‚’èª­ã¿è¾¼ã¿ä¸­...
              </div>
          </div>
      </div>

      <div id="trackTitle">ãƒ•ã‚¡ã‚¤ãƒ«ã‚’é¸æŠã—ã¦ãã ã•ã„</div>
      <div id="trackArtist">â€”</div>
      
      <div class="mode-status-display">
        <div id="shuffleStatus" class="mode-item"></div>
        <div id="loopStatus" class="mode-item"></div>
      </div>
      
      <div class="seek-container">
        <div id="currentTime" class="time-display">0:00</div>
        <input type="range" id="seekBar" value="0" min="0" max="100">
        <div id="duration" class="time-display">0:00</div>
      </div>
      
      <div class="controls-moved">
        <button class="skip-button" id="playPrevBtn" title="å‰ã®æ›²">â®ï¸</button>
        <button id="seekBackwardBtn" title="10ç§’æˆ»ã‚‹">âª</button>
        <button id="playPauseBtn" class="control-button" title="å†ç”Ÿ/ä¸€æ™‚åœæ­¢">â–¶ï¸</button>
        <button id="seekForwardBtn" title="10ç§’ã‚¹ã‚­ãƒƒãƒ—">â©</button>
        <button class="skip-button" id="playNextBtn" title="æ¬¡ã®æ›²">â­ï¸</button>
      </div>

    </div>
    
    <div class="control-panel">
        <div class="modes">
            <div class="section-title">ğŸ”Š ãƒ¬ãƒ™ãƒ«ãƒ¡ãƒ¼ã‚¿ãƒ¼</div>
            <div class="mixer-container">
                <div class="channel-label">L</div>
                <div class="mixer-bar">
                    <div id="mixerBarL" class="mixer-bar-fill"></div>
                    <div id="peakHoldL" class="peak-hold-indicator"></div> </div>
            </div>
            <div class="mixer-container">
                <div class="channel-label">R</div>
                <div class="mixer-bar">
                    <div id="mixerBarR" class="mixer-bar-fill"></div>
                    <div id="peakHoldR" class="peak-hold-indicator"></div> </div>
            </div>
        </div>

        <div class="modes">
            <div class="section-title">âš™ï¸ ãƒœãƒªãƒ¥ãƒ¼ãƒ  & ãƒ¢ãƒ¼ãƒ‰</div>
            <div class="volume-container">
                <span style="font-size:0.9em; color: var(--text-light); white-space: nowrap;">éŸ³é‡: </span>
                <input type="range" id="volumeSlider" min="0" max="200" value="100">
                <span id="volumePercentage" style="font-size:0.9em; width: 35px; text-align: right; color: var(--accent-color); cursor: pointer; user-select: none;">100%</span>
            </div>
            
            <div class="mode-buttons">
                <button id="loopBtn">ãƒªãƒ”ãƒ¼ãƒˆ</button>
                <button id="shuffleBtn">ã‚·ãƒ£ãƒƒãƒ•ãƒ«</button>
            </div>
        </div>
    </div> 

    <audio id="player" preload="auto"></audio>
  </div>

  <script>
    // ** PWA Service Worker Registration **
    if ('serviceWorker' in navigator) {
        navigator.serviceWorker.register('./sw.js', { scope: './' })
        .then(reg => {
            console.log('ServiceWorker registered:', reg);
            showNotification('Service Worker ç™»éŒ²æ¸ˆã¿', false, 2000);

            // æ–°ã—ã„ SW ãŒã‚¤ãƒ³ã‚¹ãƒˆãƒ¼ãƒ«ã•ã‚ŒãŸã‚‰ã‚¯ãƒ©ã‚¤ã‚¢ãƒ³ãƒˆã«é€šçŸ¥
            reg.addEventListener('updatefound', () => {
                const newWorker = reg.installing;
                newWorker.addEventListener('statechange', () => {
                    if (newWorker.state === 'installed') {
                        if (navigator.serviceWorker.controller) {
                            // æ›´æ–°é©ç”¨å¯èƒ½
                            showNotification('æ–°ã—ã„ãƒãƒ¼ã‚¸ãƒ§ãƒ³ã‚’æ¤œå‡ºã—ã¾ã—ãŸã€‚ãƒšãƒ¼ã‚¸ã‚’ãƒªãƒ­ãƒ¼ãƒ‰ã™ã‚‹ã¨æ›´æ–°ã•ã‚Œã¾ã™ã€‚', false, 4000);
                        } else {
                            // åˆå›ã‚¤ãƒ³ã‚¹ãƒˆãƒ¼ãƒ«
                            showNotification('ã‚¢ãƒ—ãƒªãŒã‚ªãƒ•ãƒ©ã‚¤ãƒ³ã§ä½¿ç”¨ã§ãã‚‹ã‚ˆã†ã«ãªã‚Šã¾ã—ãŸã€‚', false, 3000);
                        }
                    }
                });
            });

            // æ—©æœŸã«æ–°ã—ã„SWã‚’æœ‰åŠ¹åŒ–ã—ãŸã„å ´åˆï¼ˆé–‹ç™ºæ™‚å‘ã‘ï¼‰
            navigator.serviceWorker.addEventListener('message', (ev) => {
                if (ev.data && ev.data.type === 'SKIP_WAITING') {
                    navigator.serviceWorker.getRegistration().then(reg => {
                        if (reg && reg.waiting) reg.waiting.postMessage({ type: 'SKIP_WAITING' });
                    });
                }
            });
        }).catch(err => {
            console.warn('ServiceWorker registration failed:', err);
            showNotification('Service Worker ã®ç™»éŒ²ã«å¤±æ•—ã—ã¾ã—ãŸã€‚', true, 3000);
        });
    }
    
    // --- ã‚°ãƒ­ãƒ¼ãƒãƒ«å¤‰æ•° ---
    const playlists = [];
    const PLAYER_STATE_KEY = 'dmplayer_state_v3'; 
    
    // DOMè¦ç´ 
    let audioList, player, notificationContainer, settingsOverlay, debugToggle, nextTrackNotificationToggle;
    let trackDetailsOverlay, currentTrackInfoDetails, volumeSlider, volumePercentage;
    let shuffleStatus, loopStatus, playPauseBtn, seekBackwardBtn, seekForwardBtn, playNextBtn, playPrevBtn;
    let coverArtContainer, lyricsDisplay, crossfadeDurationSlider, crossfadeValueDisplay;
    let metadataEditForm, editTitleInput, editArtistInput, saveMetadataBtn, toggleEditBtn;
    let peakHoldL, peakHoldR, mixerBarL, mixerBarR;
    let seekBar, currentTimeDisplay, durationDisplay;
    let fileInput, trackTitle, trackArtist, coverArt;
    let optionsBtn, settingsBtn, closeSettingsBtn, helpBtn, closeDetailsBtn;

    // â­ ãƒ“ã‚¸ãƒ¥ã‚¢ãƒ©ã‚¤ã‚¶ãƒ¼é–¢é€£ã®DOMè¦ç´ 
    let visualizerCanvas, visualizerCtx; 
    let visualizerToggle; 

    // çŠ¶æ…‹å¤‰æ•°
    let currentIndex = 0;
    let isLoop = 'off'; 
    let isShuffle = false;
    let isSeeking = false; 
    let nextTrackNotificationSent = false; 
    let isDebugging = false; 
    let nextTrackNotificationEnabled = true; 
    let isVisualizerEnabled = false;
    let wasUserInitiatedPlay = false;
    let CROSSFADE_DURATION = 1.5;
    let isSwitchingTrack = false;
    
    // AudioContexté–¢é€£
    let audioContext, gainNode, analyserL, analyserR, splitter, source; 
    // â­ ãƒ“ã‚¸ãƒ¥ã‚¢ãƒ©ã‚¤ã‚¶ãƒ¼ç”¨ã®AnalyserNode
    let analyserMain; 
    let frequencyData;
    let isConnected = false;
    let rafId = null;
    let peakLevelL = 0;
    let peakLevelR = 0;
    let peakDecayRate = 0.99;
    
    const DEFAULT_COVER_SRC = "data:image/svg+xml;utf8,<svg xmlns='http://www.w3.org/2000/svg' width='250' height='250'><rect width='100%' height='100%' fill='%23333'/><text x='50%' y='50%' dominant-baseline='middle' text-anchor='middle' font-family='Arial' font-size='30' fill='%23ccc'>NO ART</text></svg>";

    // IndexedDBé–¢é€£
    const DB_NAME = 'DmPlayerDB';
    const DB_VERSION = 1;
    const STORE_NAME = 'CustomMetadata';
    let db;
    
    // --- åˆæœŸåŒ– ---
    document.addEventListener('DOMContentLoaded', () => {
        // DOMè¦ç´ ã®å–å¾—
        audioList = document.getElementById("audioList");
        player = document.getElementById("player");
        notificationContainer = document.getElementById("notificationContainer");
        settingsOverlay = document.getElementById("settingsOverlay");
        debugToggle = document.getElementById("debugToggle");
        nextTrackNotificationToggle = document.getElementById("nextTrackNotificationToggle");
        trackDetailsOverlay = document.getElementById("trackDetailsOverlay");
        currentTrackInfoDetails = document.getElementById("currentTrackInfoDetails");
        volumeSlider = document.getElementById("volumeSlider");
        volumePercentage = document.getElementById("volumePercentage");
        shuffleStatus = document.getElementById("shuffleStatus");
        loopStatus = document.getElementById("loopStatus");
        playPauseBtn = document.getElementById("playPauseBtn");
        seekBackwardBtn = document.getElementById("seekBackwardBtn");
        seekForwardBtn = document.getElementById("seekForwardBtn");
        playNextBtn = document.getElementById("playNextBtn");
        playPrevBtn = document.getElementById("playPrevBtn");
        coverArtContainer = document.querySelector(".cover-art-container");
        lyricsDisplay = document.getElementById("lyricsDisplay");
        crossfadeDurationSlider = document.getElementById("crossfadeDurationSlider");
        crossfadeValueDisplay = document.getElementById("crossfadeValue");
        metadataEditForm = document.getElementById("metadataEditForm");
        editTitleInput = document.getElementById("editTitle");
        editArtistInput = document.getElementById("editArtist");
        saveMetadataBtn = document.getElementById("saveMetadataBtn");
        toggleEditBtn = document.getElementById("toggleEditBtn");
        peakHoldL = document.getElementById("peakHoldL");
        peakHoldR = document.getElementById("peakHoldR");
        mixerBarL = document.getElementById("mixerBarL");
        mixerBarR = document.getElementById("mixerBarR");
        seekBar = document.getElementById("seekBar");
        currentTimeDisplay = document.getElementById("currentTime");
        durationDisplay = document.getElementById("duration");
        fileInput = document.getElementById("fileInput");
        trackTitle = document.getElementById("trackTitle");
        trackArtist = document.getElementById("trackArtist");
        coverArt = document.getElementById("coverArt");
        optionsBtn = document.getElementById("optionsBtn");
        settingsBtn = document.getElementById("settingsBtn");
        closeSettingsBtn = document.getElementById("closeSettingsBtn");
        helpBtn = document.getElementById("helpBtn");
        closeDetailsBtn = document.getElementById("closeDetailsBtn");
        
        const loopBtnElement = document.getElementById("loopBtn");
        const shuffleBtnElement = document.getElementById("shuffleBtn");

        // â­ ãƒ“ã‚¸ãƒ¥ã‚¢ãƒ©ã‚¤ã‚¶ãƒ¼é–¢é€£ã®DOMè¦ç´ ã‚’å–å¾—
        visualizerCanvas = document.getElementById("visualizerCanvas");
        visualizerToggle = document.getElementById("visualizerToggle");
        visualizerCtx = visualizerCanvas.getContext("2d");

        // AudioContextã®ã‚»ãƒƒãƒˆã‚¢ãƒƒãƒ—
        const AudioContext = window.AudioContext || window.webkitAudioContext;
        audioContext = new AudioContext();
        gainNode = audioContext.createGain();
        gainNode.gain.value = 1.0; 

        analyserL = audioContext.createAnalyser();
        analyserR = audioContext.createAnalyser();
        
        // â­ ãƒ“ã‚¸ãƒ¥ã‚¢ãƒ©ã‚¤ã‚¶ãƒ¼ç”¨ã®AnalyserNodeã‚’æ–°è¨­
        analyserMain = audioContext.createAnalyser();
        analyserMain.fftSize = 256;
        frequencyData = new Uint8Array(analyserMain.frequencyBinCount);
        
        analyserL.fftSize = 2048; 
        analyserR.fftSize = 2048;
        analyserL.smoothingTimeConstant = 0.5;
        analyserR.smoothingTimeConstant = 0.5;
        splitter = audioContext.createChannelSplitter(2);

        // ã‚¤ãƒ™ãƒ³ãƒˆãƒªã‚¹ãƒŠãƒ¼ã®ç™»éŒ²
        fileInput.addEventListener('change', handleFileInputChange);
        playPauseBtn.onclick = () => handleUserAction(togglePlayPause);
        seekBackwardBtn.onclick = seekBackward;
        seekForwardBtn.onclick = seekForward;
        playNextBtn.onclick = () => handleUserAction(playNext);
        playPrevBtn.onclick = () => handleUserAction(playPrev);
        loopBtnElement.onclick = toggleLoop;
        shuffleBtnElement.onclick = toggleShuffle;
        volumeSlider.addEventListener('input', () => updateVolume(volumeSlider.value));
        volumePercentage.onclick = resetVolumeToDefault;
        coverArtContainer.onclick = toggleLyrics;
        optionsBtn.onclick = showTrackDetails;
        settingsBtn.onclick = showSettings;
        closeSettingsBtn.onclick = hideSettings;
        closeDetailsBtn.onclick = hideTrackDetails;
        toggleEditBtn.onclick = toggleMetadataEdit;
        helpBtn.onclick = () => showNotification("ãƒ˜ãƒ«ãƒ—æ©Ÿèƒ½ã¯è¿‘æ—¥å…¬é–‹äºˆå®šã§ã™ã€‚", false, 2000);
        
        // è¨­å®šã‚¹ãƒ©ã‚¤ãƒ€ãƒ¼
        crossfadeDurationSlider.addEventListener('input', (e) => {
            CROSSFADE_DURATION = parseFloat(e.target.value);
            crossfadeValueDisplay.textContent = CROSSFADE_DURATION.toFixed(1);
            showNotification(`ãƒ‡ãƒãƒƒã‚°: ã‚¯ãƒ­ã‚¹ãƒ•ã‚§ãƒ¼ãƒ‰æ™‚é–“ = ${CROSSFADE_DURATION.toFixed(1)}s`, false, 1000);
            saveState();
        });
        
        // è¨­å®šãƒˆã‚°ãƒ«
        debugToggle.addEventListener('change', () => {
            isDebugging = debugToggle.checked;
            showNotification(`ãƒ‡ãƒãƒƒã‚°è¡¨ç¤º ${isDebugging ? 'ON' : 'OFF'}`, false, 2000);
            saveState();
        });
        nextTrackNotificationToggle.addEventListener('change', () => {
            nextTrackNotificationEnabled = nextTrackNotificationToggle.checked;
            showNotification(`æ¬¡ã®æ›²ã‚’é€šçŸ¥ ${nextTrackNotificationEnabled ? 'ON' : 'OFF'}`, false, 2000);
            saveState();
        });

        visualizerToggle.addEventListener('change', () => {
            isVisualizerEnabled = visualizerToggle.checked;
            const msg = isVisualizerEnabled ? 'ãƒ“ã‚¸ãƒ¥ã‚¢ãƒ©ã‚¤ã‚¶ãƒ¼ ON' : 'ãƒ“ã‚¸ãƒ¥ã‚¢ãƒ©ã‚¤ã‚¶ãƒ¼ OFF';
            showNotification(msg, false, 2000);
            updateVisualizerState();
            if(!player.paused) {
                // å†ç”Ÿä¸­ã«ON/OFFã—ãŸå ´åˆã€æç”»ãƒ«ãƒ¼ãƒ—ã‚’å†é–‹/åœæ­¢ã™ã‚‹
                if (rafId) cancelAnimationFrame(rafId);
                if (isVisualizerEnabled) {
                    rafId = requestAnimationFrame(drawVisualizer);
                } else {
                    rafId = requestAnimationFrame(drawMixer);
                }
            }
            saveState();
        });

        // ã‚·ãƒ¼ã‚¯ãƒãƒ¼é–¢é€£
        seekBar.addEventListener('mousedown', () => { isSeeking = true; });
        seekBar.addEventListener('touchstart', () => { isSeeking = true; });
        
        const seekEndHandler = () => {
            isSeeking = false;
            const duration = player.duration;
            if (!isNaN(duration)) {
                player.currentTime = duration * (seekBar.value / 100);
            }
        };
        seekBar.addEventListener('mouseup', seekEndHandler);
        seekBar.addEventListener('touchend', seekEndHandler);

        // Audio/Playerã‚¤ãƒ™ãƒ³ãƒˆ
        player.addEventListener('loadedmetadata', updateDurationDisplay);
        player.addEventListener('timeupdate', updateTimeDisplay);
        player.addEventListener('ended', playNext); 
        player.addEventListener('pause', updatePlayPauseButton);
        player.addEventListener('playing', () => {
            updatePlayPauseButton();
            if (audioContext.state === 'suspended') {
                audioContext.resume();
            }
            if (!isConnected) {
                connectAudioNodes();
            }
            // æç”»ãƒ«ãƒ¼ãƒ—ã‚’é–‹å§‹/å†é–‹
            if (rafId) cancelAnimationFrame(rafId);
            if (isVisualizerEnabled) {
                rafId = requestAnimationFrame(drawVisualizer);
            } else {
                rafId = requestAnimationFrame(drawMixer);
            }
        });
        player.addEventListener('error', handleAudioError);
        
        // ãã®ä»–ã®åˆæœŸåŒ–å‡¦ç†
        initIndexedDB();
        loadState();
        updateShuffleStatus();
        updateLoopStatus();
        updateVisualizerState(); // åˆæœŸãƒ­ãƒ¼ãƒ‰æ™‚ã«ãƒ“ã‚¸ãƒ¥ã‚¢ãƒ©ã‚¤ã‚¶ãƒ¼ã®çŠ¶æ…‹ã‚’åæ˜ 

        // æœ€åˆã®ãƒ¬ãƒ³ãƒ€ãƒªãƒ³ã‚°
        if (rafId) cancelAnimationFrame(rafId);
        rafId = requestAnimationFrame(drawMixer);
    });

    // --- ãƒ¦ãƒ¼ãƒ†ã‚£ãƒªãƒ†ã‚£é–¢æ•° ---
    
    // ãƒ¦ãƒ¼ã‚¶ãƒ¼ã‚¢ã‚¯ã‚·ãƒ§ãƒ³ã®ãƒˆãƒªã‚¬ãƒ¼ã‚’ä¿è¨¼
    async function handleUserAction(callback) {
        if (audioContext.state === 'suspended') {
            await audioContext.resume();
            wasUserInitiatedPlay = true;
        }
        callback();
    }
    
    function showNotification(message, isError = false, duration = 3000) {
        if (message.startsWith('ãƒ‡ãƒãƒƒã‚°') && !isDebugging) return;
        
        const notification = document.createElement('div');
        notification.classList.add('notification-message');
        if (isError) {
            notification.classList.add('error');
        } else if (message.startsWith('ãƒ‡ãƒãƒƒã‚°')) {
            notification.classList.add('debug');
        } else if (message === 'æ¬¡ã®æ›²ã‚’å†ç”Ÿã—ã¾ã™') {
            if (!nextTrackNotificationEnabled) return;
            notification.style.borderLeftColor = 'var(--peak-hold-color)';
        }

        notification.textContent = message;
        notificationContainer.prepend(notification); // æ–°ã—ã„é€šçŸ¥ã‚’ä¸Šã«è¡¨ç¤º

        // show
        requestAnimationFrame(() => {
            notification.classList.add('show');
        });

        // hide
        setTimeout(() => {
            notification.classList.add('slide-out');
            notification.addEventListener('transitionend', () => {
                notification.remove();
            });
        }, duration);
    }
    
    function formatTime(seconds) {
        if (isNaN(seconds) || seconds < 0) return "0:00";
        const min = Math.floor(seconds / 60);
        const sec = Math.floor(seconds % 60);
        return `${min}:${sec.toString().padStart(2, '0')}`;
    }

    // AudioContextãƒãƒ¼ãƒ‰ã®æ¥ç¶š
    function connectAudioNodes() {
        if (isConnected) return;
        
        // <audio> è¦ç´ ã‚’ AudioContext ã®ã‚½ãƒ¼ã‚¹ãƒãƒ¼ãƒ‰ã¨ã—ã¦å–å¾—
        source = audioContext.createMediaElementSource(player);

        // source -> splitter (L/Rä¿¡å·ã‚’åˆ†é›¢)
        source.connect(splitter);
        
        // splitter ã®å„ãƒãƒ£ãƒ³ãƒãƒ«ã‚’ãã‚Œãã‚Œã® analyser ã«æ¥ç¶š
        // ãƒãƒ£ãƒ³ãƒãƒ« 0 (L) -> analyserL -> gainNode
        splitter.connect(analyserL, 0);
        // ãƒãƒ£ãƒ³ãƒãƒ« 1 (R) -> analyserR -> gainNode
        splitter.connect(analyserR, 1);
        
        // source -> analyserMain (ãƒ“ã‚¸ãƒ¥ã‚¢ãƒ©ã‚¤ã‚¶ãƒ¼ç”¨)
        source.connect(analyserMain);

        // analyserL ã¨ analyserR ã‹ã‚‰ã®å‡ºåŠ›ã‚’åˆæˆã—ã¦ gainNode ã«æ¥ç¶š (ãƒŸã‚­ã‚·ãƒ³ã‚°ã¯ä¸è¦ãªãŸã‚ã€ã“ã“ã§ã¯å˜ç´”ã« gainNode ã®å¾Œã«æ¥ç¶š)
        // L/R ã®ãƒ¬ãƒ™ãƒ«è§£æã¯ analyser ã§è¡Œã„ã€éŸ³éŸ¿ä¿¡å·è‡ªä½“ã¯ source ã‹ã‚‰ gainNode ã¸ç›´æ¥æ¥ç¶šã™ã‚‹æ–¹ãŒä¸€èˆ¬çš„ã§å®‰å®šã—ã¾ã™ã€‚
        // ã“ã“ã§ã¯ãƒ¬ãƒ™ãƒ«ãƒ¡ãƒ¼ã‚¿ãƒ¼ã®ãŸã‚ã« L/R ã®ã‚¢ãƒŠãƒ©ã‚¤ã‚¶ãƒ¼ã‚’æ¥ç¶šã—ã€éŸ³å£°ã¯ç›´æ¥ source -> gainNode ã«ç¹‹ãã¾ã™ã€‚
        // Web Audio API ã¯è¤‡é›‘ãªãƒ«ãƒ¼ãƒ†ã‚£ãƒ³ã‚°ãŒå¯èƒ½ã§ã™ãŒã€ã“ã“ã§ã¯ã‚·ãƒ³ãƒ—ãƒ«ã«ã€‚
        
        // source -> gainNode -> audioContext.destination
        source.connect(gainNode);
        gainNode.connect(audioContext.destination);

        isConnected = true;
        showNotification("ãƒ‡ãƒãƒƒã‚°: AudioContextæ¥ç¶šå®Œäº†", false, 1000);
    }

    function updateVolume(value) {
        const volume = value / 100;
        if (gainNode) {
            gainNode.gain.value = volume;
        }
        volumePercentage.textContent = `${value}%`;
        
        if (volume > 1.0) {
            volumePercentage.style.color = 'var(--error-color)';
            showNotification('éŸ³é‡ãŒ100%ã‚’è¶…ãˆã¦ã„ã¾ã™ã€‚éŸ³å‰²ã‚Œã«ã”æ³¨æ„ãã ã•ã„ã€‚', false, 2000);
        } else if (volume === 0) {
            volumePercentage.style.color = 'var(--peak-hold-color)';
        } else {
            volumePercentage.style.color = 'var(--accent-color)';
        }
        saveState();
    }
    
    function resetVolumeToDefault() {
        volumeSlider.value = 100;
        updateVolume(100);
        showNotification("éŸ³é‡ã‚’ãƒªã‚»ãƒƒãƒˆã—ã¾ã—ãŸ (100%)", false, 2000);
    }

    function drawMixer() {
        if (!analyserL || !analyserR) {
            rafId = requestAnimationFrame(drawMixer);
            return;
        }
        
        const bufferLength = analyserL.frequencyBinCount;
        const dataArrayL = new Uint8Array(bufferLength);
        const dataArrayR = new Uint8Array(bufferLength);
        
        analyserL.getByteFrequencyData(dataArrayL);
        analyserR.getByteFrequencyData(dataArrayR);
        
        // L/Rãƒãƒ£ãƒ³ãƒãƒ«ã®å¹³å‡ãƒ¬ãƒ™ãƒ«è¨ˆç®— (ç°¡ç•¥åŒ–ã®ãŸã‚ã«RMSã§ã¯ãªãå¹³å‡ã‚’ä½¿ç”¨)
        const avgL = dataArrayL.reduce((sum, val) => sum + val, 0) / bufferLength;
        const avgR = dataArrayR.reduce((sum, val) => sum + val, 0) / bufferLength;
        
        // ãƒ¬ãƒ™ãƒ«ã‚’0-100%ã«ãƒãƒƒãƒ”ãƒ³ã‚°
        const levelL = Math.min(100, (avgL / 255) * 200);
        const levelR = Math.min(100, (avgR / 255) * 200);

        mixerBarL.style.width = `${levelL}%`;
        mixerBarR.style.width = `${levelR}%`;

        // ãƒ”ãƒ¼ã‚¯ãƒ›ãƒ¼ãƒ«ãƒ‰æ›´æ–°
        if (levelL > peakLevelL) peakLevelL = levelL;
        if (levelR > peakLevelR) peakLevelR = levelR;

        // ãƒ”ãƒ¼ã‚¯ã®æ¸›è¡°
        peakLevelL *= peakDecayRate;
        peakLevelR *= peakDecayRate;

        // ãƒ”ãƒ¼ã‚¯ã‚¤ãƒ³ã‚¸ã‚±ãƒ¼ã‚¿ãƒ¼ã®è¡¨ç¤º
        peakHoldL.style.transform = `translateX(${peakLevelL}%)`;
        peakHoldR.style.transform = `translateX(${peakLevelR}%)`;

        // 0%ã«ãªã£ãŸã‚‰ãƒªã‚»ãƒƒãƒˆ
        if (peakLevelL < 0.1) peakHoldL.style.transform = `translateX(0%)`;
        if (peakLevelR < 0.1) peakHoldR.style.transform = `translateX(0%)`;

        rafId = requestAnimationFrame(drawMixer);
    }

    // â­ ãƒ“ã‚¸ãƒ¥ã‚¢ãƒ©ã‚¤ã‚¶ãƒ¼æç”»ãƒ­ã‚¸ãƒƒã‚¯ (ç°¡ç•¥åŒ–ã•ã‚ŒãŸãƒãƒ¼å‹)
    function drawVisualizer() {
        if (!visualizerCtx || !analyserMain || !isVisualizerEnabled) {
            // ãƒ“ã‚¸ãƒ¥ã‚¢ãƒ©ã‚¤ã‚¶ãƒ¼ãŒç„¡åŠ¹åŒ–ã•ã‚ŒãŸã‚‰ãƒŸã‚­ã‚µãƒ¼æç”»ã«æˆ»ã‚‹
            rafId = requestAnimationFrame(drawMixer);
            return;
        }
        
        rafId = requestAnimationFrame(drawVisualizer);
        
        analyserMain.getByteFrequencyData(frequencyData);
        
        const width = visualizerCanvas.width;
        const height = visualizerCanvas.height;
        
        visualizerCtx.clearRect(0, 0, width, height);
        
        const barWidth = (width / analyserMain.frequencyBinCount) * 2.5;
        let x = 0;

        for(let i = 0; i < analyserMain.frequencyBinCount; i++) {
            const barHeight = frequencyData[i] / 255 * height;
            
            // è¦–è¦šçš„ãªä¸­å¤®æƒãˆ
            const y = height - barHeight; 

            // ã‚°ãƒ©ãƒ‡ãƒ¼ã‚·ãƒ§ãƒ³ã‚’è¨­å®š
            const gradient = visualizerCtx.createLinearGradient(0, height, 0, 0);
            gradient.addColorStop(0, "rgba(0, 230, 184, 0.4)"); 
            gradient.addColorStop(1, "rgba(255, 255, 255, 0.8)"); 
            visualizerCtx.fillStyle = gradient;

            visualizerCtx.fillRect(x, y, barWidth, barHeight);

            x += barWidth + 1;
        }
        
        // ãƒ¬ãƒ™ãƒ«ãƒ¡ãƒ¼ã‚¿ãƒ¼ã®æç”»ã‚‚ç¶™ç¶š
        drawMixerInternal();
    }
    
    // drawMixer ã‹ã‚‰åˆ‡ã‚Šé›¢ã—ã€ãƒ“ã‚¸ãƒ¥ã‚¢ãƒ©ã‚¤ã‚¶ãƒ¼ãƒ¢ãƒ¼ãƒ‰ã§ã‚‚ãƒŸã‚­ã‚µãƒ¼æç”»ã‚’ç¶šã‘ã‚‹ãŸã‚ã®å†…éƒ¨é–¢æ•°
    function drawMixerInternal() {
        if (!analyserL || !analyserR) return;
        
        const bufferLength = analyserL.frequencyBinCount;
        const dataArrayL = new Uint8Array(bufferLength);
        const dataArrayR = new Uint8Array(bufferLength);
        
        analyserL.getByteFrequencyData(dataArrayL);
        analyserR.getByteFrequencyData(dataArrayR);
        
        const avgL = dataArrayL.reduce((sum, val) => sum + val, 0) / bufferLength;
        const avgR = dataArrayR.reduce((sum, val) => sum + val, 0) / bufferLength;
        
        const levelL = Math.min(100, (avgL / 255) * 200);
        const levelR = Math.min(100, (avgR / 255) * 200);

        mixerBarL.style.width = `${levelL}%`;
        mixerBarR.style.width = `${levelR}%`;

        if (levelL > peakLevelL) peakLevelL = levelL;
        if (levelR > peakLevelR) peakLevelR = levelR;

        peakLevelL *= peakDecayRate;
        peakLevelR *= peakDecayRate;

        peakHoldL.style.transform = `translateX(${peakLevelL}%)`;
        peakHoldR.style.transform = `translateX(${peakLevelR}%)`;

        if (peakLevelL < 0.1) peakHoldL.style.transform = `translateX(0%)`;
        if (peakLevelR < 0.1) peakHoldR.style.transform = `translateX(0%)`;
    }

    function updateVisualizerState() {
        if (isVisualizerEnabled) {
            document.body.classList.add('visualizer-mode');
            // Canvasã®ã‚µã‚¤ã‚ºã‚’è¦ªã‚³ãƒ³ãƒ†ãƒŠã«åˆã‚ã›ã‚‹ (ãƒ¬ã‚¹ãƒãƒ³ã‚·ãƒ–å¯¾å¿œ)
            visualizerCanvas.width = visualizerCanvas.offsetWidth;
            visualizerCanvas.height = visualizerCanvas.offsetHeight;
        } else {
            document.body.classList.remove('visualizer-mode');
        }
        visualizerToggle.checked = isVisualizerEnabled;
        showNotification(`ãƒ‡ãƒãƒƒã‚°: Visualizer Mode = ${isVisualizerEnabled}`, false, 2000);
    }
    
    // --- å†ç”Ÿãƒ­ã‚¸ãƒƒã‚¯ ---

    function handleFileInputChange(event) {
        const files = Array.from(event.target.files);
        if (files.length === 0) return;

        let newTracks = [];
        let startIndex = playlists.length;
        files.forEach((file, index) => {
            const track = {
                file: file,
                title: file.name,
                artist: 'Unknown Artist',
                duration: 0,
                customTitle: null,
                customArtist: null,
                lyrics: null,
                albumArtURL: DEFAULT_COVER_SRC,
                originalIndex: startIndex + index
            };
            newTracks.push(track);
        });

        // æ—¢å­˜ã®ãƒ—ãƒ¬ã‚¤ãƒªã‚¹ãƒˆã«è¿½åŠ 
        playlists.push(...newTracks);
        showNotification(`${files.length}å€‹ã®ãƒ•ã‚¡ã‚¤ãƒ«ã‚’è¿½åŠ ã—ã¾ã—ãŸã€‚`, false, 2000);

        // æœ€åˆã®ãƒ•ã‚¡ã‚¤ãƒ«ã®ãƒ¡ã‚¿ãƒ‡ãƒ¼ã‚¿ã¨å†ç”Ÿã‚’é–‹å§‹
        if (playlists.length > 0 && player.src === "") {
            currentIndex = 0;
            // ãƒ¡ã‚¿ãƒ‡ãƒ¼ã‚¿ã¯éåŒæœŸã§é †æ¬¡å–å¾—
            playlists.forEach((track, index) => fetchMetadata(index));
            loadTrack(currentIndex); // ãƒ¦ãƒ¼ã‚¶ãƒ¼æ“ä½œãªã—ã§è‡ªå‹•å†ç”Ÿã¯è¨±å¯ã•ã‚Œãªã„ãŸã‚ã€å†ç”Ÿã¯ãƒ¦ãƒ¼ã‚¶ãƒ¼ã‚¢ã‚¯ã‚·ãƒ§ãƒ³ã‚’å¾…ã¤
        } else {
            // æ–°ã—ã„ãƒ•ã‚¡ã‚¤ãƒ«ã‚‚ãƒ¡ã‚¿ãƒ‡ãƒ¼ã‚¿å–å¾—ã‚’é–‹å§‹
            newTracks.forEach((track, index) => fetchMetadata(track.originalIndex));
        }

        renderAudioList();
        saveState();
    }
    
    /**
     * æŒ‡å®šã•ã‚ŒãŸã‚¤ãƒ³ãƒ‡ãƒƒã‚¯ã‚¹ã®ãƒˆãƒ©ãƒƒã‚¯ã‚’ãƒ­ãƒ¼ãƒ‰ã™ã‚‹
     * @param {number} index - å†ç”Ÿã™ã‚‹ãƒ—ãƒ¬ã‚¤ãƒªã‚¹ãƒˆã®ã‚¤ãƒ³ãƒ‡ãƒƒã‚¯ã‚¹
     * @param {boolean} forcePlay - ãƒ­ãƒ¼ãƒ‰å¾Œã™ãã«å†ç”Ÿã‚’é–‹å§‹ã™ã‚‹ã‹ã©ã†ã‹ (endedã‚¤ãƒ™ãƒ³ãƒˆãªã©ã‹ã‚‰ã®è‡ªå‹•å†ç”Ÿç”¨)
     */
    function loadTrack(index, forcePlay = false) {
        if (index < 0 || index >= playlists.length) {
            showNotification('ã‚­ãƒ¥ãƒ¼ã®çµ‚ç«¯ã«é”ã—ã¾ã—ãŸã€‚', false, 2000);
            return;
        }
        
        currentIndex = index;
        const track = playlists[currentIndex];
        
        // ã‚¯ãƒ­ã‚¹ãƒ•ã‚§ãƒ¼ãƒ‰å‡¦ç†
        // NOTE: player.paused ã¯ ended ã‚¤ãƒ™ãƒ³ãƒˆç™ºç”Ÿç›´å¾Œã«ã¯ true ã«ãªã‚‹ãŸã‚ã€
        // è‡ªå‹•å†ç”Ÿ (forcePlay=true) ã®å ´åˆã¯ã“ã®ãƒ–ãƒ­ãƒƒã‚¯ã¯ã‚¹ã‚­ãƒƒãƒ—ã•ã‚Œã‚‹ã€‚
        if (!player.paused && !isSwitchingTrack) {
            isSwitchingTrack = true;
            const originalVolume = gainNode.gain.value;
            // ãƒ•ã‚§ãƒ¼ãƒ‰ã‚¢ã‚¦ãƒˆ
            gainNode.gain.exponentialRampToValueAtTime( 
                0.001, audioContext.currentTime + CROSSFADE_DURATION 
            );
            
            setTimeout(() => {
                // æ–°ã—ã„ãƒˆãƒ©ãƒƒã‚¯ã‚’èª­ã¿è¾¼ã¿ã€å³åº§ã«å†ç”Ÿ
                player.src = URL.createObjectURL(track.file);
                player.play().then(() => {
                    // ãƒ•ã‚§ãƒ¼ãƒ‰ã‚¤ãƒ³
                    gainNode.gain.setValueAtTime(0.001, audioContext.currentTime);
                    gainNode.gain.exponentialRampToValueAtTime(
                        originalVolume, audioContext.currentTime + CROSSFADE_DURATION
                    );
                    updateTrackDisplay(track);
                    renderAudioList();
                    saveState();
                    isSwitchingTrack = false;
                }).catch(e => {
                    showNotification(`å†ç”Ÿã‚¨ãƒ©ãƒ¼: ${e.message}`, true, 3000);
                    isSwitchingTrack = false;
                });
            }, CROSSFADE_DURATION * 1000);
        } else {
            // ğŸ’¡ ä¿®æ­£ç®‡æ‰€: ã‚¯ãƒ­ã‚¹ãƒ•ã‚§ãƒ¼ãƒ‰ãªã—ã®æ¨™æº–ãƒ­ãƒ¼ãƒ‰ã¨å†ç”Ÿãƒ­ã‚¸ãƒƒã‚¯
            // æ›²ã®çµ‚äº†ã€ã¾ãŸã¯ãƒ—ãƒ¬ã‚¤ãƒ¤ãƒ¼ãŒä¸€æ™‚åœæ­¢ä¸­ã®çŠ¶æ…‹ã§æ–°ã—ã„æ›²ãŒé¸æŠã•ã‚ŒãŸå ´åˆ
            
            player.src = URL.createObjectURL(track.file);
            updateTrackDisplay(track);
            renderAudioList();
            saveState();

            // forcePlay ãŒ true ã®å ´åˆ (ended ã‚¤ãƒ™ãƒ³ãƒˆãªã©ã‹ã‚‰ã®è‡ªå‹•å†ç”Ÿã€ã¾ãŸã¯ãƒœã‚¿ãƒ³æ“ä½œ) ã¯å†ç”Ÿã‚’é–‹å§‹
            if (forcePlay) { 
                player.play().catch(e => {
                    // è‡ªå‹•å†ç”Ÿãƒãƒªã‚·ãƒ¼ãªã©ã§å¤±æ•—ã—ãŸå ´åˆã®ã‚¨ãƒ©ãƒ¼å‡¦ç†
                    showNotification(`å†ç”Ÿã‚¨ãƒ©ãƒ¼: ${e.message} (è‡ªå‹•å†ç”Ÿå¤±æ•—)`, true, 3000);
                });
            }
        }
    }

    function togglePlayPause() {
        if (playlists.length === 0 || player.src === "") {
            showNotification('å†ç”Ÿã™ã‚‹ãƒ•ã‚¡ã‚¤ãƒ«ãŒã‚ã‚Šã¾ã›ã‚“ã€‚', true, 2000);
            return;
        }

        if (player.paused) {
            player.play().catch(e => {
                showNotification(`å†ç”Ÿé–‹å§‹ã‚¨ãƒ©ãƒ¼: ${e.message}`, true, 3000);
                updatePlayPauseButton(); 
            });
        } else {
            player.pause();
        }
    }

    function playNext() {
        if (playlists.length === 0) return;

        showNotification('æ¬¡ã®æ›²ã‚’å†ç”Ÿã—ã¾ã™', false, 1000); 

        let nextIndex;
        if (isLoop === 'single') {
            nextIndex = currentIndex;
        } else if (isShuffle) {
            // ã‚·ãƒ£ãƒƒãƒ•ãƒ«ãƒ¢ãƒ¼ãƒ‰: ç¾åœ¨ã®æ›²ä»¥å¤–ã®ãƒ©ãƒ³ãƒ€ãƒ ãªæ›²ã‚’é¸æŠ
            let availableIndices = [];
            for (let i = 0; i < playlists.length; i++) {
                if (i !== currentIndex) {
                    availableIndices.push(i);
                }
            }
            if (availableIndices.length === 0) {
                // ãƒ—ãƒ¬ã‚¤ãƒªã‚¹ãƒˆã«1æ›²ã—ã‹ãªã„å ´åˆ (singleã§ãªã„å ´åˆã¯çµ‚äº†)
                player.pause();
                player.currentTime = 0;
                updatePlayPauseButton();
                showNotification('ãƒ—ãƒ¬ã‚¤ãƒªã‚¹ãƒˆã®å†ç”ŸãŒçµ‚äº†ã—ã¾ã—ãŸã€‚', false, 3000);
                return;
            } else {
                nextIndex = availableIndices[Math.floor(Math.random() * availableIndices.length)];
            }
        } else {
            nextIndex = currentIndex + 1;
        }

        if (nextIndex >= playlists.length) {
            if (isLoop === 'all') {
                nextIndex = 0; // ãƒ«ãƒ¼ãƒ—
            } else {
                player.pause();
                player.currentTime = 0;
                updatePlayPauseButton();
                showNotification('ãƒ—ãƒ¬ã‚¤ãƒªã‚¹ãƒˆã®å†ç”ŸãŒçµ‚äº†ã—ã¾ã—ãŸã€‚', false, 3000);
                return;
            }
        }
        
        loadTrack(nextIndex, true); 
    }

    function playPrev() {
        if (playlists.length === 0) return;

        if (player.currentTime > 3) {
            // 3ç§’ä»¥ä¸ŠçµŒéã—ã¦ã„ãŸã‚‰æ›²ã®å…ˆé ­ã«æˆ»ã‚‹
            player.currentTime = 0;
            showNotification('æ›²ã®å…ˆé ­ã«æˆ»ã‚Šã¾ã—ãŸã€‚', false, 1000);
        } else {
            // 3ç§’æœªæº€ãªã‚‰å‰ã®æ›²ã¸
            let prevIndex;
            if (isShuffle) {
                // ã‚·ãƒ£ãƒƒãƒ•ãƒ«æ™‚ã¯å˜ç´”ã«å‰ã®æ›²ã‚’å®Ÿè£…ã™ã‚‹ã®ã¯é›£ã—ã„ã®ã§ã€ã“ã“ã§ã¯ãƒ©ãƒ³ãƒ€ãƒ ãªå‰ã®æ›²ã€ã¾ãŸã¯ç¾åœ¨ã®æ›²ã«æˆ»ã‚‹
                prevIndex = currentIndex - 1; // ä¸€æ—¦ä¸€ã¤å‰ã«æˆ»ã‚‹ãŒã€ã‚·ãƒ£ãƒƒãƒ•ãƒ«ãƒ­ã‚¸ãƒƒã‚¯ã¯ã‚ˆã‚Šè¤‡é›‘ãªå±¥æ­´ç®¡ç†ãŒå¿…è¦
            } else {
                prevIndex = currentIndex - 1;
            }

            if (prevIndex < 0) {
                prevIndex = playlists.length - 1; // ãƒ—ãƒ¬ã‚¤ãƒªã‚¹ãƒˆã®æœ€å¾Œã«ãƒ«ãƒ¼ãƒ—
            }

            loadTrack(prevIndex, true);
        }
    }

    function toggleLoop() {
        if (isLoop === 'off') {
            isLoop = 'all';
            showNotification('ãƒªãƒ”ãƒ¼ãƒˆ: å…¨æ›²', false, 1500);
        } else if (isLoop === 'all') {
            isLoop = 'single';
            showNotification('ãƒªãƒ”ãƒ¼ãƒˆ: ä¸€æ›²', false, 1500);
        } else {
            isLoop = 'off';
            showNotification('ãƒªãƒ”ãƒ¼ãƒˆ: ã‚ªãƒ•', false, 1500);
        }
        updateLoopStatus();
        saveState();
    }

    function toggleShuffle() {
        isShuffle = !isShuffle;
        showNotification(`ã‚·ãƒ£ãƒƒãƒ•ãƒ«: ${isShuffle ? 'ã‚ªãƒ³' : 'ã‚ªãƒ•'}`, false, 1500);
        updateShuffleStatus();
        saveState();
    }

    function seekBackward() {
        player.currentTime = Math.max(0, player.currentTime - 10);
        showNotification('10ç§’å·»ãæˆ»ã—', false, 500);
    }

    function seekForward() {
        player.currentTime = Math.min(player.duration, player.currentTime + 10);
        showNotification('10ç§’ã‚¹ã‚­ãƒƒãƒ—', false, 500);
    }

    // --- UIæ›´æ–° ---

    function updatePlayPauseButton() {
        playPauseBtn.innerHTML = player.paused ? 'â–¶ï¸' : 'â¸ï¸';
        if (!player.src) {
            playPauseBtn.classList.remove('player-ready');
        } else {
            playPauseBtn.classList.add('player-ready');
        }
    }

    function updateDurationDisplay() {
        durationDisplay.textContent = formatTime(player.duration);
        seekBar.max = player.duration;
    }

    function updateTimeDisplay() {
        if (!isSeeking) {
            currentTimeDisplay.textContent = formatTime(player.currentTime);
            seekBar.value = player.currentTime;
            
            const progress = (player.currentTime / player.duration) * 100 || 0;
            seekBar.style.setProperty('--progress', `${progress}%`);
            
            // æ¬¡ã®æ›²é€šçŸ¥ã®ã‚¿ã‚¤ãƒŸãƒ³ã‚°ã‚’ãƒã‚§ãƒƒã‚¯ (çµ‚äº†ã®10ç§’å‰)
            if (nextTrackNotificationEnabled && 
                !nextTrackNotificationSent && 
                player.duration > 0 && 
                player.duration - player.currentTime <= 10) {
                
                const nextTrackTitle = getNextTrackTitle();
                if (nextTrackTitle) {
                    showNotification(`ã¾ã‚‚ãªã ${nextTrackTitle} ã‚’å†ç”Ÿã—ã¾ã™`, false, 2000);
                    nextTrackNotificationSent = true;
                }
            } else if (player.duration - player.currentTime > 10) {
                // 10ç§’ã®é–¾å€¤ã‚’è¶…ãˆãŸã‚‰ãƒªã‚»ãƒƒãƒˆ
                nextTrackNotificationSent = false;
            }
        }
    }
    
    function getNextTrackTitle() {
        if (playlists.length === 0) return null;

        let nextIndex;
        if (isLoop === 'single') {
            nextIndex = currentIndex;
        } else if (isShuffle) {
            // ã‚·ãƒ£ãƒƒãƒ•ãƒ«æ™‚ã¯äºˆæ¸¬ãŒå›°é›£ãªã®ã§ã€æ¬¡ã®æ›²ã®ã‚¿ã‚¤ãƒˆãƒ«ã¯è¡¨ç¤ºã—ãªã„
            return null;
        } else {
            nextIndex = currentIndex + 1;
        }

        if (nextIndex >= playlists.length) {
            if (isLoop === 'all') {
                nextIndex = 0;
            } else {
                return null;
            }
        }
        
        const track = playlists[nextIndex];
        return track.customTitle || track.title;
    }

    function updateShuffleStatus() {
        const item = shuffleStatus;
        if (isShuffle) {
            item.innerHTML = '<span class="mode-icon">ğŸ”€</span> ã‚·ãƒ£ãƒƒãƒ•ãƒ«';
            item.classList.add('active');
        } else {
            item.innerHTML = '<span class="mode-icon">â–¶ï¸</span> é †æ¬¡å†ç”Ÿ';
            item.classList.remove('active');
        }
    }

    function updateLoopStatus() {
        const item = loopStatus;
        item.classList.remove('active');
        
        if (isLoop === 'off') {
            item.innerHTML = '<span class="mode-icon">ğŸ”</span> ãƒªãƒ”ãƒ¼ãƒˆ OFF';
        } else if (isLoop === 'all') {
            item.innerHTML = '<span class="mode-icon">ğŸ”</span> ãƒªãƒ”ãƒ¼ãƒˆ ALL';
            item.classList.add('active');
        } else if (isLoop === 'single') {
            item.innerHTML = '<span class="mode-icon">ğŸ”‚</span> ãƒªãƒ”ãƒ¼ãƒˆ SINGLE';
            item.classList.add('active');
            // ã‚¹ã‚¿ã‚¤ãƒ«ã®è¿½åŠ : ä¸€æ›²ãƒªãƒ”ãƒ¼ãƒˆæ™‚ã¯ãƒ«ãƒ¼ãƒ—ã‚¢ã‚¤ã‚³ãƒ³ã‚’å¼·èª¿
            item.style.backgroundColor = 'var(--peak-hold-color)';
        } 
        
        // ã‚¹ã‚¿ã‚¤ãƒ«ã®ãƒªã‚»ãƒƒãƒˆ
        if (isLoop !== 'single') {
            item.style.backgroundColor = '';
        }
    }

    function updateTrackDisplay(track) {
        // è¡¨ç¤ºã™ã‚‹ã‚¿ã‚¤ãƒˆãƒ«ã¨ã‚¢ãƒ¼ãƒ†ã‚£ã‚¹ãƒˆã‚’æ±ºå®š (ã‚«ã‚¹ã‚¿ãƒ ãƒ¡ã‚¿ãƒ‡ãƒ¼ã‚¿ã‚’å„ªå…ˆ)
        const displayTitle = track.customTitle || track.title;
        const displayArtist = track.customArtist || track.artist;

        trackTitle.textContent = displayTitle;
        trackArtist.textContent = displayArtist;
        coverArt.src = track.albumArtURL;
        lyricsDisplay.textContent = track.lyrics || 'æ­Œè©æƒ…å ±ãŒã‚ã‚Šã¾ã›ã‚“ã€‚';
        
        // è©³ç´°ç”»é¢ã®è¡¨ç¤ºã‚‚æ›´æ–°
        currentTrackInfoDetails.innerHTML = `
            <strong>ãƒ•ã‚¡ã‚¤ãƒ«å:</strong> ${track.file.name}<br>
            <strong>ã‚µã‚¤ã‚º:</strong> ${(track.file.size / (1024 * 1024)).toFixed(2)} MB<br>
            <strong>ã‚ªãƒªã‚¸ãƒŠãƒ«ã‚¿ã‚¤ãƒˆãƒ«:</strong> ${track.title}<br>
            <strong>ã‚ªãƒªã‚¸ãƒŠãƒ«ã‚¢ãƒ¼ãƒ†ã‚£ã‚¹ãƒˆ:</strong> ${track.artist}<br>
            <strong>ã‚«ã‚¹ã‚¿ãƒ ã‚¿ã‚¤ãƒˆãƒ«:</strong> ${track.customTitle || 'ãªã—'}<br>
            <strong>ã‚«ã‚¹ã‚¿ãƒ ã‚¢ãƒ¼ãƒ†ã‚£ã‚¹ãƒˆ:</strong> ${track.customArtist || 'ãªã—'}<br>
            <strong>ã‚­ãƒ¥ãƒ¼ç•ªå·:</strong> ${currentIndex + 1}/${playlists.length}<br>
            <strong>å†ç”Ÿæ™‚é–“:</strong> ${formatTime(track.duration)}
            <div id="metadataEditForm" style="display:${metadataEditForm.classList.contains('show') ? 'block' : 'none'};">
                <div class="input-group">
                    <label for="editTitle">ã‚¿ã‚¤ãƒˆãƒ«</label>
                    <input type="text" id="editTitle" value="${displayTitle}">
                </div>
                <div class="input-group">
                    <label for="editArtist">ã‚¢ãƒ¼ãƒ†ã‚£ã‚¹ãƒˆ</label>
                    <input type="text" id="editArtist" value="${displayArtist}">
                </div>
                <button class="footer-btn" id="saveMetadataBtn">ã‚¿ã‚°ã‚’ä¿å­˜ã—ã¦é©ç”¨</button>
            </div>
        `;

        // å†åº¦DOMè¦ç´ ã‚’å–å¾—
        editTitleInput = document.getElementById("editTitle");
        editArtistInput = document.getElementById("editArtist");
        saveMetadataBtn = document.getElementById("saveMetadataBtn");
        saveMetadataBtn.onclick = saveEditedMetadata;
    }

    function renderAudioList() {
        audioList.innerHTML = '';
        playlists.forEach((track, index) => {
            const item = document.createElement('div');
            item.classList.add('queue-item');
            if (index === currentIndex) {
                item.classList.add('active-track');
            }
            item.setAttribute('data-index', index);
            
            const displayTitle = track.customTitle || track.title;
            const displayArtist = track.customArtist || track.artist;

            item.innerHTML = `
                <div class="queue-index">${index + 1}</div>
                <div class="track-info-container">
                    <div class="track-title-display" title="${displayTitle}">${displayTitle}</div>
                    <div class="track-artist-display" title="${displayArtist}">${displayArtist}</div>
                </div>
                <div class="queue-controls">
                    <div class="playing-status">${index === currentIndex ? (player.paused ? '' : 'ğŸ¶') : ''}</div>
                    <button class="queue-control-btn move-up-btn" title="ä¸Šã¸ç§»å‹•">â¬†</button>
                    <button class="queue-control-btn move-down-btn" title="ä¸‹ã¸ç§»å‹•">â¬‡</button>
                    <button class="queue-control-btn delete-btn" title="å‰Šé™¤">âŒ</button>
                </div>
            `;

            // ã‚­ãƒ¥ãƒ¼ã‚¢ã‚¤ãƒ†ãƒ ã®ã‚¯ãƒªãƒƒã‚¯ã§å†ç”Ÿ
            item.addEventListener('click', (e) => {
                // ã‚³ãƒ³ãƒˆãƒ­ãƒ¼ãƒ«ãƒœã‚¿ãƒ³ã§ãªã‘ã‚Œã°å†ç”Ÿ
                if (e.target.closest('.queue-control-btn')) return;
                handleUserAction(() => loadTrack(index, true));
            });
            
            // ã‚³ãƒ³ãƒˆãƒ­ãƒ¼ãƒ«ãƒœã‚¿ãƒ³ã®ã‚¤ãƒ™ãƒ³ãƒˆãƒªã‚¹ãƒŠãƒ¼
            item.querySelector('.move-up-btn').onclick = () => moveTrack(index, index - 1);
            item.querySelector('.move-down-btn').onclick = () => moveTrack(index, index + 1);
            item.querySelector('.delete-btn').onclick = () => deleteTrack(index);

            audioList.appendChild(item);
        });
    }

    // --- ãƒ¡ã‚¿ãƒ‡ãƒ¼ã‚¿å‡¦ç† ---
    
    function fetchMetadata(index) {
        const track = playlists[index];
        if (!track || !track.file) return;

        jsmediatags.read(track.file, {
            onSuccess: function(tag) {
                showNotification(`ãƒ‡ãƒãƒƒã‚°: ãƒ¡ã‚¿ãƒ‡ãƒ¼ã‚¿å–å¾—: ${track.file.name}`, false, 1000);
                
                const tags = tag.tags;
                
                track.title = tags.title || track.file.name;
                track.artist = tags.artist || 'Unknown Artist';
                
                // æ­Œè©ã®å–å¾—
                if (tags.lyrics && tags.lyrics.lyrics) {
                    track.lyrics = tags.lyrics.lyrics;
                } else if (tags.comment && tags.comment.text) {
                     // ã‚³ãƒ¡ãƒ³ãƒˆæ¬„ã«æ­Œè©ãŒå…¥ã£ã¦ã„ã‚‹å ´åˆã‚‚ã‚ã‚‹
                     track.lyrics = tags.comment.text;
                }
                
                // ã‚¢ãƒ¼ãƒˆãƒ¯ãƒ¼ã‚¯ã®å‡¦ç†
                if (tags.picture) {
                    const picture = tags.picture;
                    let base64String = "";
                    for (let i = 0; i < picture.data.length; i++) {
                        base64String += String.fromCharCode(picture.data[i]);
                    }
                    track.albumArtURL = `data:${picture.format};base64,${btoa(base64String)}`;
                } else {
                    track.albumArtURL = DEFAULT_COVER_SRC;
                }
                
                // å†ç”Ÿæ™‚é–“ï¼ˆãƒ¡ã‚¿ãƒ‡ãƒ¼ã‚¿ã«ã¯å«ã¾ã‚Œãªã„ãŸã‚ã€ã“ã“ã§ã¯ãƒ€ãƒŸãƒ¼ï¼‰
                // å®Ÿéš›ã®æ™‚é–“ã¯ loadedmetadata ã‚¤ãƒ™ãƒ³ãƒˆã§å–å¾—ã•ã‚Œã‚‹
                
                // ã‚«ã‚¹ã‚¿ãƒ ãƒ¡ã‚¿ãƒ‡ãƒ¼ã‚¿ã‚’ãƒ­ãƒ¼ãƒ‰
                loadCustomMetadata(index);
                
                // ç¾åœ¨å†ç”Ÿä¸­ã®ãƒˆãƒ©ãƒƒã‚¯ã§ã‚ã‚Œã°è¡¨ç¤ºã‚’æ›´æ–°
                if (index === currentIndex) {
                    updateTrackDisplay(track);
                    renderAudioList(); 
                } else {
                    renderAudioList();
                }
            },
            onError: function(error) {
                showNotification(`ãƒ‡ãƒãƒƒã‚°: ãƒ¡ã‚¿ãƒ‡ãƒ¼ã‚¿ã‚¨ãƒ©ãƒ¼ for ${track.file.name}: ${error.type}`, true, 2000);
                // ã‚¨ãƒ©ãƒ¼ã§ã‚‚ã‚«ã‚¹ã‚¿ãƒ ãƒ¡ã‚¿ãƒ‡ãƒ¼ã‚¿ã¯ãƒ­ãƒ¼ãƒ‰ã‚’è©¦ã¿ã‚‹
                loadCustomMetadata(index); 
            }
        });
    }

    function moveTrack(oldIndex, newIndex) {
        if (newIndex < 0 || newIndex >= playlists.length || oldIndex === newIndex) return;
        
        const [removed] = playlists.splice(oldIndex, 1);
        playlists.splice(newIndex, 0, removed);

        // ç¾åœ¨å†ç”Ÿä¸­ã®æ›²ãŒç§»å‹•ã—ãŸå ´åˆã€currentIndexã‚’æ›´æ–°
        if (currentIndex === oldIndex) {
            currentIndex = newIndex;
        } else if (oldIndex < currentIndex && newIndex >= currentIndex) {
            currentIndex--;
        } else if (oldIndex > currentIndex && newIndex <= currentIndex) {
            currentIndex++;
        }

        renderAudioList();
        saveState();
        showNotification(`ã‚­ãƒ¥ãƒ¼: ${removed.title} ã‚’ç§»å‹•ã—ã¾ã—ãŸ`, false, 1500);
    }
    
    function deleteTrack(index) {
        const removedTrack = playlists.splice(index, 1)[0];
        
        if (index === currentIndex) {
            // ç¾åœ¨ã®æ›²ã‚’å‰Šé™¤ã—ãŸå ´åˆ
            if (playlists.length > 0) {
                // æ¬¡ã®æ›²ã‚’è‡ªå‹•å†ç”Ÿ (loadTrackãŒcurrentIndexã®èª¿æ•´ã‚‚è¡Œã†)
                loadTrack(Math.min(currentIndex, playlists.length - 1), true);
            } else {
                // ãƒ—ãƒ¬ã‚¤ãƒªã‚¹ãƒˆãŒç©ºã«ãªã£ãŸå ´åˆ
                player.pause();
                player.src = '';
                trackTitle.textContent = 'ãƒ•ã‚¡ã‚¤ãƒ«ã‚’é¸æŠã—ã¦ãã ã•ã„';
                trackArtist.textContent = 'â€”';
                coverArt.src = DEFAULT_COVER_SRC;
                currentIndex = 0;
                updatePlayPauseButton();
                playPauseBtn.classList.remove('player-ready');
            }
        } else if (index < currentIndex) {
            // ç¾åœ¨ã®æ›²ã‚ˆã‚Šå‰ã®æ›²ã‚’å‰Šé™¤ã—ãŸå ´åˆã€currentIndexã‚’ãƒ‡ã‚¯ãƒªãƒ¡ãƒ³ãƒˆã—ã¦ã‚ºãƒ¬ã‚’ä¿®æ­£
            currentIndex--;
        }

        renderAudioList();
        saveState();
        showNotification(`ã‚­ãƒ¥ãƒ¼: ${removedTrack.title} ã‚’å‰Šé™¤ã—ã¾ã—ãŸ`, false, 1500);
    }

    // --- è©³ç´°/è¨­å®š ---

    function showTrackDetails() {
        if (playlists.length === 0) {
            showNotification('å†ç”Ÿä¸­ã®ãƒˆãƒ©ãƒƒã‚¯ãŒã‚ã‚Šã¾ã›ã‚“ã€‚', true, 2000);
            return;
        }
        const track = playlists[currentIndex];
        updateTrackDisplay(track); // è©³ç´°ç”»é¢ã®æƒ…å ±ã‚’æ›´æ–°
        metadataEditForm.classList.remove('show'); // ç·¨é›†ãƒ•ã‚©ãƒ¼ãƒ ã‚’éè¡¨ç¤ºã«
        toggleEditBtn.textContent = 'ã‚¿ã‚°ã‚’ç·¨é›†';
        trackDetailsOverlay.classList.add('show');
    }

    function hideTrackDetails() {
        trackDetailsOverlay.classList.remove('show');
    }
    
    function showSettings() {
        settingsOverlay.classList.add('show');
        debugToggle.checked = isDebugging;
        nextTrackNotificationToggle.checked = nextTrackNotificationEnabled;
        visualizerToggle.checked = isVisualizerEnabled;
    }

    function hideSettings() {
        settingsOverlay.classList.remove('show');
    }
    
    function toggleMetadataEdit() {
        metadataEditForm.classList.toggle('show');
        if (metadataEditForm.classList.contains('show')) {
            toggleEditBtn.textContent = 'ç·¨é›†ãƒ•ã‚©ãƒ¼ãƒ ã‚’éš ã™';
            // ç¾åœ¨ã®è¡¨ç¤ºå†…å®¹ã‚’ãƒ•ã‚©ãƒ¼ãƒ ã«ã‚»ãƒƒãƒˆ
            const track = playlists[currentIndex];
            editTitleInput.value = track.customTitle || track.title;
            editArtistInput.value = track.customArtist || track.artist;
        } else {
            toggleEditBtn.textContent = 'ã‚¿ã‚°ã‚’ç·¨é›†';
        }
    }

    function saveEditedMetadata() {
        const track = playlists[currentIndex];
        const newTitle = editTitleInput.value.trim();
        const newArtist = editArtistInput.value.trim();
        
        // å¤‰æ›´ãŒãªã„å ´åˆã¯ä½•ã‚‚ã—ãªã„
        if (newTitle === (track.customTitle || track.title) && 
            newArtist === (track.customArtist || track.artist)) {
            showNotification('ã‚¿ã‚°ã«å¤‰æ›´ã¯ã‚ã‚Šã¾ã›ã‚“ã§ã—ãŸã€‚', false, 1500);
            hideTrackDetails();
            return;
        }

        track.customTitle = newTitle || null;
        track.customArtist = newArtist || null;
        
        // IndexedDBã«ä¿å­˜
        saveCustomMetadata(currentIndex);
        
        // è¡¨ç¤ºã‚’æ›´æ–°
        updateTrackDisplay(track);
        renderAudioList();
        
        showNotification('ã‚¿ã‚°æƒ…å ±ã‚’ä¿å­˜ã—ã¦é©ç”¨ã—ã¾ã—ãŸã€‚', false, 2000);
        hideTrackDetails();
    }
    
    // --- IndexedDB ---

    function initIndexedDB() {
        const request = indexedDB.open(DB_NAME, DB_VERSION);

        request.onerror = (e) => showNotification(`ãƒ‡ãƒãƒƒã‚°: IndexedDBã‚¨ãƒ©ãƒ¼: ${e.target.error.name}`, true, 3000);

        request.onupgradeneeded = (e) => {
            db = e.target.result;
            if (!db.objectStoreNames.contains(STORE_NAME)) {
                const store = db.createObjectStore(STORE_NAME, { keyPath: 'fileName' });
                // ä»Šå¾Œã®æ‹¡å¼µã®ãŸã‚ã«ã‚¤ãƒ³ãƒ‡ãƒƒã‚¯ã‚¹ã‚’ä½œæˆå¯èƒ½
            }
            showNotification("ãƒ‡ãƒãƒƒã‚°: IndexedDBåˆæœŸåŒ–å®Œäº†", false, 1000);
        };

        request.onsuccess = (e) => {
            db = e.target.result;
            showNotification("ãƒ‡ãƒãƒƒã‚°: IndexedDBæ¥ç¶šå®Œäº†", false, 1000);
            // ãƒ—ãƒ¬ã‚¤ãƒªã‚¹ãƒˆã®å¾©å…ƒãŒãªã„ãŸã‚ã€åˆæœŸãƒ­ãƒ¼ãƒ‰æ™‚ã®å‡¦ç†ã¯ä¸è¦
        };
    }

    function saveCustomMetadata(index) {
        if (!db) return;
        
        const track = playlists[index];
        if (!track.file || !track.file.name) return;

        if (!track.customTitle && !track.customArtist) {
            // ã‚«ã‚¹ã‚¿ãƒ æƒ…å ±ãŒãªã„å ´åˆã¯å‰Šé™¤
            deleteCustomMetadata(track.file.name);
            return;
        }
        
        const transaction = db.transaction([STORE_NAME], 'readwrite');
        const store = transaction.objectStore(STORE_NAME);
        
        const metadata = {
            fileName: track.file.name,
            customTitle: track.customTitle,
            customArtist: track.customArtist
        };

        const request = store.put(metadata);
        
        request.onsuccess = () => showNotification(`ãƒ‡ãƒãƒƒã‚°: ã‚«ã‚¹ã‚¿ãƒ ãƒ¡ã‚¿ãƒ‡ãƒ¼ã‚¿ä¿å­˜: ${track.file.name}`, false, 1000);
        request.onerror = (e) => showNotification(`ãƒ‡ãƒãƒƒã‚°: ã‚«ã‚¹ã‚¿ãƒ ãƒ¡ã‚¿ãƒ‡ãƒ¼ã‚¿ä¿å­˜ã‚¨ãƒ©ãƒ¼: ${e.target.error.name}`, true, 2000);
    }
    
    function loadCustomMetadata(index) {
        const track = playlists[index];
        if (!track.file || !track.file.name || !db) return;

        const transaction = db.transaction([STORE_NAME], 'readonly');
        const store = transaction.objectStore(STORE_NAME);
        const request = store.get(track.file.name);

        request.onsuccess = function(e) {
            const data = e.target.result;
            if (data) {
                track.customTitle = data.customTitle;
                track.customArtist = data.customArtist;
                showNotification(`ãƒ‡ãƒãƒƒã‚°: ã‚«ã‚¹ã‚¿ãƒ ãƒ¡ã‚¿ãƒ‡ãƒ¼ã‚¿ãƒ­ãƒ¼ãƒ‰: ${track.file.name}`, false, 1000);
                
                // å†ç”Ÿä¸­ã®ãƒˆãƒ©ãƒƒã‚¯ã§ã‚ã‚Œã°è¡¨ç¤ºã‚’æ›´æ–°
                if (index === currentIndex) {
                    updateTrackDisplay(track);
                    renderAudioList();
                } else {
                    renderAudioList(); // ã‚­ãƒ¥ãƒ¼ãƒªã‚¹ãƒˆã®æ›´æ–°
                }
            }
        };
        request.onerror = (e) => showNotification(`ãƒ‡ãƒãƒƒã‚°: ã‚«ã‚¹ã‚¿ãƒ ãƒ¡ã‚¿ãƒ‡ãƒ¼ã‚¿ãƒ­ãƒ¼ãƒ‰ã‚¨ãƒ©ãƒ¼: ${e.target.error.name}`, true, 2000);
    }
    
    function deleteCustomMetadata(fileName) {
        if (!db) return;
        const transaction = db.transaction([STORE_NAME], 'readwrite');
        const store = transaction.objectStore(STORE_NAME);
        const request = store.delete(fileName);
        
        request.onsuccess = () => showNotification(`ãƒ‡ãƒãƒƒã‚°: ã‚«ã‚¹ã‚¿ãƒ ãƒ¡ã‚¿ãƒ‡ãƒ¼ã‚¿å‰Šé™¤: ${fileName}`, false, 1000);
        request.onerror = (e) => showNotification(`ãƒ‡ãƒãƒƒã‚°: ã‚«ã‚¹ã‚¿ãƒ ãƒ¡ã‚¿ãƒ‡ãƒ¼ã‚¿å‰Šé™¤ã‚¨ãƒ©ãƒ¼: ${e.target.error.name}`, true, 2000);
    }


    // --- çŠ¶æ…‹ç®¡ç† ---

    function toggleLyrics() {
        if (playlists.length === 0) return;
        coverArtContainer.classList.toggle('flipped');
    }
    
    function saveState() {
        localStorage.setItem(PLAYER_STATE_KEY, JSON.stringify({
            currentIndex, 
            isLoop, 
            isShuffle, 
            volume: volumeSlider.value,
            crossfade: CROSSFADE_DURATION,
            visualizer: isVisualizerEnabled, 
            // å†ç”Ÿä½ç½®ã¯ãƒ•ã‚¡ã‚¤ãƒ«ã®ãƒ­ãƒ¼ãƒ‰å¾Œã«è¨­å®šã™ã‚‹ãŸã‚ã€ã“ã“ã§ã¯ä¿å­˜ã—ãªã„
            // playbackPosition: player.currentTime 
        }));
    }
    
    function loadState() {
        const s = JSON.parse(localStorage.getItem(PLAYER_STATE_KEY));
        if (s) {
            currentIndex = s.currentIndex || 0;
            isLoop = s.isLoop || 'off';
            isShuffle = s.isShuffle || false;
            if (s.volume) {
                volumeSlider.value = s.volume;
                updateVolume(s.volume);
            }
            if (s.crossfade) {
                CROSSFADE_DURATION = s.crossfade;
                crossfadeDurationSlider.value = s.crossfade;
                crossfadeValueDisplay.textContent = s.crossfade.toFixed(1);
            }
            // â­ çŠ¶æ…‹ã‚’ãƒ­ãƒ¼ãƒ‰
            isVisualizerEnabled = s.visualizer || false; 
        }
        
        // localStorageã‹ã‚‰ãƒ—ãƒ¬ã‚¤ãƒªã‚¹ãƒˆã‚’å¾©å…ƒã™ã‚‹å ´åˆã®ãƒ­ã‚¸ãƒƒã‚¯ã¯å®Ÿè£…ã•ã‚Œã¦ã„ã¾ã›ã‚“ã€‚
        // ãƒ•ã‚¡ã‚¤ãƒ«ã‚·ã‚¹ãƒ†ãƒ ã‚¢ã‚¯ã‚»ã‚¹APIãŒå¿…è¦ã§ã™ãŒã€ã‚¦ã‚§ãƒ–ãƒ™ãƒ¼ã‚¹ã§ã¯éæ¨å¥¨/éæ¨™æº–ã§ã™ã€‚
    }

    function handleAudioError(e) {
        showNotification(`ã‚ªãƒ¼ãƒ‡ã‚£ã‚ªã‚¨ãƒ©ãƒ¼: ${e.message || 'ä¸æ˜ãªã‚¨ãƒ©ãƒ¼'}`, true, 4000);
        console.error("Audio Error:", e);
        // ã‚¨ãƒ©ãƒ¼ç™ºç”Ÿæ™‚ã¯å¼·åˆ¶çš„ã«æ¬¡ã®æ›²ã¸ã‚¹ã‚­ãƒƒãƒ—ã‚’è©¦ã¿ã‚‹
        if (playlists.length > 0 && currentIndex < playlists.length - 1) {
            showNotification('ã‚¨ãƒ©ãƒ¼ã‚’æ¤œå‡ºã—ãŸãŸã‚ã€æ¬¡ã®æ›²ã¸ã‚¹ã‚­ãƒƒãƒ—ã—ã¾ã™ã€‚', false, 2000);
            playNext();
        } else {
            player.pause();
            updatePlayPauseButton();
        }
    }
    
  </script>
</body>
</html>
